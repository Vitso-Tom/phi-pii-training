<!DOCTYPE html>
<!--
Copyright (c) 2025 Tom Smolinsky
Code licensed under the MIT License. See LICENSE-MIT.
Content licensed under CC BY 4.0. See LICENSE-CC-BY-4.0.
VERSION 2.3 - Module 4 with Per-Subsection Exercises (Like Module 3)
-->
<html lang="en"><head>
    <meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               img-src 'self' data:;
               style-src 'self' 'unsafe-inline';
               script-src 'self' 'unsafe-inline';
               base-uri 'none';
               form-action 'none';
               frame-ancestors 'self' https://www.vitsotech.com;
               upgrade-insecure-requests">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHI/PII Training v2.3 - Per-Subsection Exercises</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .training-container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 0.5rem 1.5rem;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .mode-btn.active {
            background: white;
            color: #3498db;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #2ecc71;
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .content-area {
            padding: 2rem;
            min-height: 400px;
        }

        .module {
            display: none;
        }

        .module.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .module-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #3498db;
        }

        .module-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .learning-objectives {
            background: #e8f4fd;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .learning-objectives h3 {
            color: #2980b9;
            margin-bottom: 1rem;
        }

        .objectives-list {
            list-style: none;
        }

        .objectives-list li {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .objectives-list li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
        }

        .content-section {
            margin: 2rem 0;
        }

        .content-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .content-section p {
            line-height: 1.6;
            margin-bottom: 1rem;
            color: #555;
        }

        .formula-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            margin: 1.5rem 0;
            color: #856404;
        }

        .code-example {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 1rem 0;
            line-height: 1.4;
        }

        .code-example .comment {
            color: #95a5a6;
        }

        .code-example .keyword {
            color: #3498db;
        }

        .code-example .string {
            color: #e74c3c;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            font-size: 0.9rem;
        }

        .comparison-table th {
            background: #3498db;
            color: white;
            padding: 0.8rem;
            text-align: left;
            font-weight: bold;
        }

        .comparison-table td {
            padding: 0.8rem;
            border: 1px solid #dee2e6;
        }

        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .exercise {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .exercise-header {
            background: #e9ecef;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 6px 6px 0 0;
            border-bottom: 2px solid #dee2e6;
        }

        .exercise-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .question {
            margin: 1.5rem 0;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            position: relative;
        }

        .question.correct-answered {
            border-left: 4px solid #28a745;
        }

        .question.incorrect-answered {
            border-left: 4px solid #dc3545;
        }

        .question-text {
            font-weight: bold;
            margin-bottom: 1rem;
            color: #2c3e50 !important;
        }

        .options {
            list-style: none;
        }

        .option {
            margin: 0.5rem 0;
            padding: 0.8rem;
            background: #f8f9fa !important;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #2c3e50 !important;
        }

        .option:hover:not(.disabled) {
            background: #e9ecef !important;
            border-color: #3498db;
        }

        .option.selected {
            background: #d4edda !important;
            border-color: #28a745;
            color: #155724 !important;
        }

        .option.correct {
            background: #d4edda !important;
            border-color: #28a745;
            color: #155724 !important;
        }

        .option.incorrect {
            background: #f8d7da !important;
            border-color: #dc3545;
            color: #721c24 !important;
        }

        .option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            display: none;
        }

        .feedback.correct {
            background: #d4edda !important;
            border: 1px solid #c3e6cb;
            color: #155724 !important;
        }

        .feedback.incorrect {
            background: #f8d7da !important;
            border: 1px solid #f5c6cb;
            color: #721c24 !important;
        }

        .scenario-box {
            background: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .scenario-box h4 {
            color: #2980b9;
            margin-bottom: 1rem;
        }

        .timeline {
            position: relative;
            margin: 2rem 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #3498db;
        }

        .timeline-item {
            position: relative;
            margin: 1rem 0;
            padding-left: 50px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3498db;
        }

        .timeline-content {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .module-nav {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .module-nav-item {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #bdc3c7;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .module-nav-item.active {
            background: #3498db;
            transform: scale(1.3);
        }

        .module-nav-item.completed {
            background: #27ae60;
        }

        .completion-certificate {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .certificate-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        #userName:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .score-display {
            background: white;
            color: #2c3e50;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .cert-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .answer-key {
            margin-top: 2rem;
        }

        .answer-item {
            background: white;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            color: #2c3e50;
            text-align: left;
        }

        .answer-item.correct {
            border-left: 4px solid #28a745;
        }

        .answer-item.incorrect {
            border-left: 4px solid #dc3545;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .module-subsection {
            display: none;
        }

        .module-subsection.active {
            display: block !important;
            animation: fadeIn 0.3s ease;
        }

        .module-section-btn {
            font-size: 0.85rem;
            padding: 0.6rem 1rem;
            margin: 0.2rem;
        }

        .module-section-btn.active {
            background: #3498db !important;
            color: white !important;
        }

        .module-section-btn.viewed::after {
            content: ' ✓';
            color: #27ae60;
            font-weight: bold;
        }

        .subsection-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-top: 3px solid #3498db;
        }

        .subsection-nav-btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
        }

        #license-footer {
            margin: 16px 24px 28px;
            text-align: center;
            font-size: 0.9rem;
            color: #6b7280;
        }

        #license-footer a {
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .navigation {
                padding: 1rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .mode-toggle {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .cert-actions {
                flex-direction: column;
            }

            .subsection-nav {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .subsection-nav-btn {
                width: 100%;
            }

            .comparison-table {
                font-size: 0.75rem;
            }

            .comparison-table th,
            .comparison-table td {
                padding: 0.5rem;
            }
        }

        /* Accessibility */
        .btn:focus,
        .option:focus,
        .module-nav-item:focus {
            outline: 3px solid #3498db;
            outline-offset: 2px;
        }

        @media print {
            body {
                background: white;
            }
            
            .training-container {
                box-shadow: none;
            }
            
            .header, .navigation, #license-footer {
                display: none;
            }
            
            .completion-certificate {
                page-break-inside: avoid;
            }
        }
                /* Tooltip styles for checklist items */
        .tooltip-item {
            position: relative;
            display: inline;
            cursor: help;
            border-bottom: 1px dotted #3498db;
        }
        
        .tooltip-item:hover {
            color: #3498db;
        }
        
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            left: 0;
            top: 100%;
            margin-top: 0.5rem;
            width: 400px;
            max-width: 90vw;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 0.85rem;
            line-height: 1.6;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }
        
        .tooltip-item:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip-content strong {
            color: #3498db;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .tooltip-content p {
            margin: 0.5rem 0;
            color: #ecf0f1;
        }
        
        .tooltip-content ul {
            margin: 0.5rem 0;
            padding-left: 1.2rem;
        }
        
        .tooltip-content li {
            margin: 0.3rem 0;
            color: #ecf0f1;
        }
    </style>
</head>
<body>
    <div class="training-container">
        <div class="header">
            <h1>Technical PHI/PII Training for Builders v3.2</h1>
            <p>Duration: 50-65 minutes | Target: Technical Teams</p>
            
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('learn')" aria-label="Learn Mode">
                    📚 Learn Mode
                </button>
                <button class="mode-btn" onclick="setMode('assessment')" aria-label="Assessment Mode">
                    ✏️ Assessment Mode
                </button>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            
            <div class="module-nav" id="moduleNav" role="navigation" aria-label="Module navigation"></div>
        </div>

        <div class="content-area">
            <!-- Module 0: Introduction -->
            <div class="module active" id="module-0">
                <div class="module-header">
                    <div class="module-title">Welcome to PHI/PII Training</div>
                    <p>This interactive training will help you understand and properly handle Protected Health Information (PHI) and Personally Identifiable Information (PII) in technical workflows.</p>
                </div>

                <div class="learning-objectives">
                    <h3>By the end of this training, you will be able to:</h3>
                    <ul class="objectives-list">
                        <li>Define PHI and PII in technical contexts, including inferential PHI</li>
                        <li>Identify PHI exposure points in databases, APIs, logging systems, and multi-system integrations</li>
                        <li>Design architectures that minimize PHI creation and exposure</li>
                        <li>Apply proper de-identification techniques and understand BAA/DUA requirements</li>
                        <li>Configure observability tools (APM, logging, error tracking) to avoid PHI exposure</li>
                        <li>Execute immediate incident response procedures when PHI exposure occurs</li>
                    </ul>
                </div>

                <div class="alert alert-info">
                    <strong>Training Modes:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                        <li><strong>Learn Mode:</strong> Change answers anytime, get immediate feedback</li>
                        <li><strong>Assessment Mode:</strong> Answers lock after submission</li>
                    </ul>
                </div>

                <div class="alert alert-success">
                    <strong>🆕 New in v3.2:</strong> Major enhancements for technical teams!
                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                        <li><strong>New Feature!:</strong> Progress will be saved so that you can step away and come back at your leisure</li>
                        <li><strong>Module 3:</strong> Deep-dive into database schema design, API patterns, logging practices, and multi-system integrations</li>
                        <li><strong>Module 3:</strong> Tool Tips / Hover Help for deeper explanations in Module 3 Builder Checklist sections </li>
                        <li><strong>Module 4:</strong> Three Foundational Principles, comprehensive BAA/DUA guidance, and vendor-agnostic tooling examples</li>
                    </ul>
                </div>

                <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid #3498db;">
                    <h3 style="color: #2980b9; margin-bottom: 1rem;">👤 Enter Your Name for Certificate</h3>
                    <p style="margin-bottom: 1rem; color: #555;">Your name will appear on your completion certificate.</p>
                    <input 
                        type="text" 
                        id="userNameInput" 
                        placeholder="Enter your full name" 
                        style="width: 100%; padding: 0.8rem; border: 2px solid #3498db; border-radius: 6px; font-size: 1rem; font-family: inherit;"
                        oninput="updateUserName(this.value)"
                        aria-label="Enter your name for certificate">
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;"><em>You can change this anytime by clicking your name on the certificate.</em></p>
                </div>
            </div>

            <!-- Module 1: PHI/PII Definitions -->
            <div class="module" id="module-1">
                <div class="module-header">
                    <div class="module-title">Module 1: PHI/PII Definitions & Clear-Cut Cases</div>
                    <p>Duration: 12-15 minutes</p>
                </div>

                <div class="content-section">
                    <h3>What is PII?</h3>
                    <p><strong>Personally Identifiable Information (PII)</strong> is any data that could reasonably identify a specific individual. Think of it as data that could be used to "pick someone out of a crowd."</p>
                    
                    <div class="scenario-box">
                        <h4>Common PII Examples:</h4>
                        <ul>
                            <li>Full names</li>
                            <li>Email addresses</li>
                            <li>Phone numbers</li>
                            <li>Social Security numbers</li>
                            <li>IP addresses (in some contexts)</li>
                            <li>Device IDs tied to individuals</li>
                        </ul>
                    </div>
                </div>

                <div class="content-section">
                    <h3>What is PHI?</h3>
                    <p><strong>Protected Health Information (PHI)</strong> is PII that exists in a healthcare context.</p>
                    
                    <div class="formula-box">
                        PHI = PII + Health Context
                    </div>

                    <div class="scenario-box">
                        <h4>PHI Examples:</h4>
                        <ul>
                            <li>Patient name + diagnosis</li>
                            <li>Email address + medication list</li>
                            <li>Phone number + appointment type</li>
                            <li>Even health data alone can be PHI if it could identify someone</li>
                        </ul>
                    </div>
                </div>

                <div class="exercise">
                    <div class="exercise-header">
                        <div class="exercise-title">Interactive Exercise 1.1: Data Classification Challenge</div>
                        <p>For each data element, select whether it's PHI, PII, Both, or Neither.</p>
                    </div>

                    <div class="question" data-question="1" data-correct="b">
                        <div class="question-text">1. "John Smith" (name only)</div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) PHI</li>
                            <li class="option" data-answer="b" tabindex="0">b) PII</li>
                            <li class="option" data-answer="c" tabindex="0">c) Both</li>
                            <li class="option" data-answer="d" tabindex="0">d) Neither</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> A name alone can identify a person, making it PII, but there's no health context to make it PHI.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> A name alone can identify a person, making it PII, but there's no health context to make it PHI. The correct answer is <strong>b) PII</strong>.
                        </div>
                    </div>

                    <div class="question" data-question="2" data-correct="c">
                        <div class="question-text">2. "John Smith diagnosed with hypertension"</div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) PHI</li>
                            <li class="option" data-answer="b" tabindex="0">b) PII</li>
                            <li class="option" data-answer="c" tabindex="0">c) Both</li>
                            <li class="option" data-answer="d" tabindex="0">d) Neither</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> The name makes it PII, and the health condition (hypertension) adds health context, making it PHI as well.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> The name makes it PII, and the health condition (hypertension) adds health context, making it PHI as well. The correct answer is <strong>c) Both</strong>.
                        </div>
                    </div>

                    <div class="question" data-question="3" data-correct="c">
                        <div class="question-text">3. "Patient ID 12345 - glucose reading 120 mg/dL"</div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) PHI</li>
                            <li class="option" data-answer="b" tabindex="0">b) PII</li>
                            <li class="option" data-answer="c" tabindex="0">c) Both</li>
                            <li class="option" data-answer="d" tabindex="0">d) Neither</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Patient ID is PII (identifies an individual), and glucose reading adds health context, making it PHI.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Patient ID is PII (identifies an individual), and glucose reading adds health context, making it PHI. The correct answer is <strong>c) Both</strong>.
                        </div>
                    </div>
                </div>

               
                <div class="alert alert-warning">
                    <strong>Don't worry if you got some of those wrong!</strong> Questions 2 and 3 were intentionally tricky - many experienced developers and healthcare professionals miss these initially. The key lesson here is that PHI/PII classification can be surprisingly nuanced and non-obvious.
                </div>

                <div class="content-section">
                    <h3>Critical Insight: PHI Cannot Exist Without PII</h3>
                    <p>Here's a fundamental principle that will help you in every situation:</p>
                    
                    <div class="formula-box">
                        No PII = No PHI (Even with health data)
                    </div>

                    <div class="scenario-box">
                        <h4>Examples:</h4>
                        <ul>
                            <li><strong>❌ PHI:</strong> "Patient glucose reading: 120 mg/dL" (anonymous health data = NOT PHI)</li>
                            <li><strong>✅ PHI:</strong> "John Smith glucose reading: 120 mg/dL" (PII + health data = PHI)</li>
                            <li><strong>❌ PHI:</strong> "Diabetes medication dosage: 10mg" (anonymous health data = NOT PHI)</li>
                            <li><strong>✅ PHI:</strong> "john@email.com diabetes medication dosage: 10mg" (PII + health data = PHI)</li>
                        </ul>
                    </div>

                    <p><strong>Why this matters for developers:</strong> You can work with health data safely as long as it's truly de-identified and contains no PII. The risk comes when identifiable information gets combined with health context.</p>
                </div>

                <div class="content-section" style="margin-top: 2rem; padding: 1.5rem; background: #e8f4fd; border-radius: 8px;">
                    <h3>🎯 Module 1 Key Takeaways</h3>
                    <ul>
                        <li><strong>PII = Identifiable:</strong> Any data that can reasonably identify a specific individual</li>
                        <li><strong>PHI = PII + Health Context:</strong> When identifiable information combines with health-related data</li>
                        <li><strong>Context Matters:</strong> The same data can be safe or PHI depending on what it's combined with</li>
                        <li><strong>Technical Examples:</strong> Patient IDs, email addresses, and even device IDs can be PII</li>
                        <li><strong>Health Context:</strong> Medications, diagnoses, appointment types, and health program enrollment all create PHI</li>
                    </ul>
                </div>
            </div>

            <!-- Module 2: Common Leak Points -->
            <div class="module" id="module-2">
                <div class="module-header">
                    <div class="module-title">Module 2: Common Leak Points in Tech Workflows</div>
                    <p>Duration: 15-18 minutes</p>
                </div>

                <div class="alert alert-warning">
                    <strong>Reality Check:</strong> PHI leaks rarely happen because someone maliciously exposes data. They happen because of everyday technical practices that seem harmless but create exposure points.
                </div>

                <div class="content-section">
                    <h3>Top 5 Leak Points in Tech Companies</h3>
                    
                    <div class="scenario-box">
                        <h4>1. Code Repositories</h4>
                        <ul>
                            <li>Hardcoded connection strings with patient DB access</li>
                            <li>Sample data with real PHI in test files</li>
                            <li>Git commits with debug output containing PHI</li>
                            <li>Accidentally pushing to public repos</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>2. AI Tools Without BAAs</h4>
                        <ul>
                            <li>Using ChatGPT, Claude, or other public AI with PHI</li>
                            <li>Copying patient data into code completion tools</li>
                            <li>Feeding PHI to AI for data analysis or debugging</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>3. Development Environments</h4>
                        <ul>
                            <li>Copying production PHI to local dev/test environments</li>
                            <li>Storing PHI in IDE scratch files or temporary folders</li>
                            <li>Browser dev tools capturing PHI in network requests</li>
                        </ul>
                    </div>
                </div>

                <div class="exercise">
                    <div class="exercise-header">
                        <div class="exercise-title">Interactive Exercise 2.1: Leak Point Identification</div>
                        <p>For each scenario, identify if PHI exposure has occurred and select the correct action.</p>
                    </div>

                    <div class="question" data-question="4" data-correct="b">
                        <div class="question-text">4. You're debugging an API error and find this in logs: <code>ERROR: Payment failed for sarah.jones@email.com - insulin prescription ID 789</code></div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) Just a technical error log - no PHI</li>
                            <li class="option" data-answer="b" tabindex="0">b) PHI exposure - email + medication reveals diabetes</li>
                            <li class="option" data-answer="c" tabindex="0">c) Only PII exposure - no health info</li>
                            <li class="option" data-answer="d" tabindex="0">d) Safe because internal logs only</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Email (PII) + insulin prescription (reveals diabetes) = PHI exposure in logs.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Email (PII) + insulin prescription (reveals diabetes) = PHI exposure. "Internal only" doesn't matter. The correct answer is <strong>b)</strong>.
                        </div>
                    </div>

                    <div class="question" data-question="5" data-correct="c">
                        <div class="question-text">5. Your teammate asks: "Can I use ChatGPT to debug this database query for patient medication records?"</div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) Yes, if you anonymize the data first</li>
                            <li class="option" data-answer="b" tabindex="0">b) Yes, ChatGPT is secure enough</li>
                            <li class="option" data-answer="c" tabindex="0">c) No, never use public AI with PHI-related code/data</li>
                            <li class="option" data-answer="d" tabindex="0">d) Yes, but only SQL without data</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Public AI tools have no BAA. Never share PHI-related code or queries with public AI.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Public AI tools have no BAA. Never share PHI-related queries. The correct answer is <strong>c)</strong>.
                        </div>
                    </div>

                    <div class="question" data-question="6" data-correct="c">
                        <div class="question-text">6. You find "test_data.csv" on dev server: <code>john.smith@email.com,diabetes,insulin,2024-01-15</code></div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) Delete it - obviously test data</li>
                            <li class="option" data-answer="b" tabindex="0">b) Leave it - dev server means synthetic</li>
                            <li class="option" data-answer="c" tabindex="0">c) Report immediately - appears to be PHI</li>
                            <li class="option" data-answer="d" tabindex="0">d) Move to secure folder first</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Never assume data is "test" without verification. Report immediately for investigation.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Never assume data is "test." This requires immediate investigation. The correct answer is <strong>c)</strong>.
                        </div>
                    </div>

                    <div class="question" data-question="7" data-correct="b">
                        <div class="question-text">7. Code review shows: <code>// TODO: Replace hardcoded connection mysql://user:pass@db.hospital.com/patient_records</code></div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) Note TODO, approve - won't go to prod</li>
                            <li class="option" data-answer="b" tabindex="0">b) Reject immediately - DB credentials + PHI exposed</li>
                            <li class="option" data-answer="c" tabindex="0">c) Approve but ask for env variables</li>
                            <li class="option" data-answer="d" tabindex="0">d) Just a comment, safe to approve</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Hardcoded PHI database credentials create immediate violations. Reject immediately.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Hardcoded PHI database credentials are immediate violations. The correct answer is <strong>b)</strong>.
                        </div>
                    </div>
                </div>
            </div>
            <!-- End of Module 2 -->

            <!-- Module 3: Context Scenarios with Subsections -->
            <div class="module" id="module-3">
                <div class="module-header">
                    <div class="module-title">Module 3: When "Safe" Data Becomes PHI</div>
                    <p>Duration: 20-25 minutes | Advanced Technical Scenarios</p>
                </div>

                <div class="alert alert-warning">
                    <strong>Expert-Level Content:</strong> This module covers subtle cases. Complete all 6 subsections to continue.
                    <ul style="margin-top: 0.5rem; padding-left: 2rem;">
                        <li>Green checkmark (<span style="color: #27ae60;">✓</span>) appears after viewing each section</li>
                        <li>NEXT button enables after all sections completed</li>
                    </ul>
                </div>

                <div class="content-section">
                    <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h4 style="color: #856404; margin-bottom: 0.5rem;">📋 Quick Navigation - Click Any Section:</h4>
                        <p style="color: #856404; font-size: 0.9rem; margin-bottom: 0.5rem;">Use buttons below OR scroll to bottom for Next/Previous buttons</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn btn-secondary module-section-btn active viewed" data-section="intro">1. Basic Context</button>
                            <button class="btn btn-secondary module-section-btn" data-section="database">2. Database & API</button>
                            <button class="btn btn-secondary module-section-btn" data-section="logging">3. Logging</button>
                            <button class="btn btn-secondary module-section-btn" data-section="inference">4. Inference</button>
                            <button class="btn btn-secondary module-section-btn" data-section="systems">5. Multi-System</button>
                            <button class="btn btn-secondary module-section-btn" data-section="safeharbor">6. Safe Harbor</button>
                        </div>
                    </div>
                </div>

                <!-- Subsection: Intro -->
                <div class="module-subsection active" id="subsection-intro">
                    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
                        <strong style="color: #2980b9;">🔍 Current Section: 1. Basic Context Rules</strong>
                    </div>
                    <div class="content-section">
                        <h3>The Context Transformation Rule</h3>
                        <p>Data that seems safe individually can become PHI when combined with other information.</p>
                    </div>

                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-title">Exercise 3.1a: Context Detective</div>
                        </div>

                        <div class="question" data-question="8" data-correct="no">
                            <div class="question-text">8. General wellness newsletter about sleep tips to mike@email.com - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="yes" tabindex="0">Yes</li>
                                <li class="option" data-answer="no" tabindex="0">No</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> General wellness content has no specific health context. Email is PII but no PHI.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> General wellness content has no specific health diagnosis or condition. The correct answer is <strong>No</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="9" data-correct="yes">
                            <div class="question-text">9. "Hi Lisa, daily reminder to take your Metformin at 8 AM" to lisa.chen@email.com - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="no" tabindex="0">No</li>
                                <li class="option" data-answer="yes" tabindex="0">Yes</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Email + name (PII) + Metformin (diabetes medication) = PHI.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Email + name + Metformin reveals diabetes. The correct answer is <strong>Yes</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="10" data-correct="yes">
                            <div class="question-text">10. "Welcome! Your blood pressure monitoring program starts soon" to sarah.johnson@email.com - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="no" tabindex="0">No</li>
                                <li class="option" data-answer="yes" tabindex="0">Yes</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Email + BP monitoring program implies hypertension diagnosis = PHI.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Email + BP monitoring program implies hypertension. The correct answer is <strong>Yes</strong>.
                            </div>
                        </div>
                    </div>

                    <div class="subsection-nav">
                        <div></div>
                        <div style="color: #6c757d; font-weight: bold;">Section 1 of 6</div>
                        <button class="btn btn-primary subsection-nav-btn" onclick="nextSubsection()">
                            Next Section: Database & API →
                        </button>
                    </div>
                </div>

                <!-- Subsection: Database -->
                <div class="module-subsection" id="subsection-database">
                    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
                        <strong style="color: #2980b9;">🔍 Current Section: 2. Database Design & API Patterns</strong>
                    </div>
                <div class="content-section">
                    <h3>Database Design & API Patterns: Architectural Decisions That Create PHI</h3>
                    <p><strong>Reality for builders:</strong> Your database schema and API design decisions directly determine whether PHI is created, how it flows through your system, and where it gets exposed. Well-intentioned architectural choices - convenient table joins, comprehensive API responses, flexible GraphQL queries - can inadvertently create PHI exposure points.</p>
                </div>

                <div class="alert alert-danger">
                    <strong>🚨 Critical Insight:</strong> Database normalization and API convenience often conflict with PHI minimization. The "perfect" schema that joins everything and the "complete" API response that returns all user data are exactly what create PHI exposure. You must design for separation.
                </div>

                <div class="content-section">
                    <h3>🗄️ Database Schema Patterns That Create PHI</h3>
                    
                    <div class="scenario-box">
                        <h4>Pattern 1: The "Convenient" User Table</h4>
                        <p><strong>The Setup:</strong> Single users table with all information</p>
                        
                        <div class="code-example"><span class="comment">-- Common pattern: Everything in one place</span>
                <span class="keyword">CREATE TABLE</span> users (
                id SERIAL PRIMARY KEY,
                email VARCHAR(255) UNIQUE,          <span class="comment">-- ⚠️ PII</span>
                phone VARCHAR(20),                  <span class="comment">-- ⚠️ PII</span>
                first_name VARCHAR(100),            <span class="comment">-- ⚠️ PII</span>
                last_name VARCHAR(100),             <span class="comment">-- ⚠️ PII</span>
                date_of_birth DATE,                 <span class="comment">-- ⚠️ PII</span>
                
                <span class="comment">-- Health-related fields in same table</span>
                primary_diagnosis VARCHAR(255),     <span class="comment">-- ⚠️ Health data</span>
                current_medications TEXT[],         <span class="comment">-- ⚠️ Health data</span>
                allergies TEXT[],                   <span class="comment">-- ⚠️ Health data</span>
                last_appointment_date DATE,         <span class="comment">-- ⚠️ Health data</span>
                insurance_provider VARCHAR(100),    <span class="comment">-- ⚠️ Health data</span>
                
                created_at TIMESTAMP,
                updated_at TIMESTAMP
                );

                <span class="comment">-- ⚠️ PROBLEM: Every query that selects from this table creates PHI</span>
                <span class="comment">-- Even SELECT email FROM users WHERE id = 123 can't avoid PHI schema</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Why This is Dangerous:</strong></p>
                        <ul>
                            <li>Any query selecting from this table risks exposing both PII and health data</li>
                            <li>Developers need access to email for authentication → automatically get access to diagnoses</li>
                            <li>Analytics queries on user demographics → unintentionally pull health data</li>
                            <li>ORM auto-generated queries often SELECT * → always returns PHI</li>
                            <li>Database backups, exports, staging environments all contain full PHI</li>
                            <li>Database monitoring tools (query analyzers, slow query logs) capture PHI in results</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>✅ BETTER Pattern: Separation of Concerns</h4>
                        <div class="code-example"><span class="comment">-- Separate PII from health data</span>

                <span class="comment">-- Table 1: Identity/Authentication (PII only, no health context)</span>
                <span class="keyword">CREATE TABLE</span> user_identity (
                user_id UUID PRIMARY KEY,
                email VARCHAR(255) UNIQUE,          <span class="comment">-- PII but no health context</span>
                phone VARCHAR(20),                  <span class="comment">-- PII but no health context</span>
                first_name VARCHAR(100),            <span class="comment">-- PII but no health context</span>
                last_name VARCHAR(100),             <span class="comment">-- PII but no health context</span>
                date_of_birth DATE,                 <span class="comment">-- PII but no health context</span>
                created_at TIMESTAMP
                );

                <span class="comment">-- Table 2: Health Records (health data, but use hashed reference)</span>
                <span class="keyword">CREATE TABLE</span> health_records (
                record_id UUID PRIMARY KEY,
                patient_hash VARCHAR(64),           <span class="comment">-- ✅ Hash of user_id, not direct FK</span>
                diagnosis_code VARCHAR(20),         <span class="comment">-- Health data, not directly linked to PII</span>
                medications JSONB,                  <span class="comment">-- Health data</span>
                allergies JSONB,                    <span class="comment">-- Health data</span>
                recorded_at TIMESTAMP,
                <span class="comment">-- NO direct foreign key to user_identity</span>
                <span class="comment">-- Application layer maps user_id → patient_hash when needed</span>
                );

                <span class="comment">-- ✅ Benefits:</span>
                <span class="comment">-- 1. Auth team can access user_identity without seeing health data</span>
                <span class="comment">-- 2. Analytics on demographics doesn't touch health_records</span>
                <span class="comment">-- 3. Health data queries don't require PII access</span>
                <span class="comment">-- 4. Different encryption keys for each table</span>
                <span class="comment">-- 5. Different backup/retention policies possible</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Architectural Benefits:</strong></p>
                        <ul>
                            <li>Team specialization: Identity team vs Clinical team with different access</li>
                            <li>Compliance: Can grant analytics access to demographics without health exposure</li>
                            <li>Encryption: Different encryption keys/methods for PII vs health data</li>
                            <li>Retention: Can delete PII (GDPR "right to forget") while keeping anonymized health data for research</li>
                            <li>Auditability: Separate audit logs for PII access vs health data access</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>Pattern 2: Foreign Key Joins That Create PHI</h4>
                        <p><strong>The Setup:</strong> Normalized schema with foreign keys</p>
                        
                        <div class="code-example"><span class="comment">-- Typical normalized design</span>
                <span class="keyword">CREATE TABLE</span> patients (
                patient_id SERIAL PRIMARY KEY,
                email VARCHAR(255),                 <span class="comment">-- ⚠️ PII</span>
                full_name VARCHAR(200)              <span class="comment">-- ⚠️ PII</span>
                );

                <span class="keyword">CREATE TABLE</span> appointments (
                appointment_id SERIAL PRIMARY KEY,
                patient_id INTEGER REFERENCES patients(patient_id),
                appointment_type VARCHAR(100),      <span class="comment">-- ⚠️ Health context</span>
                appointment_date TIMESTAMP,
                provider_name VARCHAR(100)
                );

                <span class="comment">-- Common query pattern (creates PHI):</span>
                <span class="keyword">SELECT</span> 
                p.email,                            <span class="comment">-- PII</span>
                p.full_name,                        <span class="comment">-- PII</span>
                a.appointment_type,                 <span class="comment">-- Health data</span>
                a.appointment_date
                <span class="keyword">FROM</span> patients p
                <span class="keyword">JOIN</span> appointments a ON p.patient_id = a.patient_id
                <span class="keyword">WHERE</span> a.appointment_date > NOW();

                <span class="comment">-- ⚠️ Result set = PHI (PII + health context combined)</span>
                <span class="comment">-- This query result in logs, query cache, application memory = PHI</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Common Scenarios That Create PHI:</strong></p>
                        <ul>
                            <li><strong>Dashboard queries:</strong> "Show upcoming appointments with patient names" → JOIN creates PHI</li>
                            <li><strong>Reminder systems:</strong> "Get email + appointment type" → JOIN creates PHI</li>
                            <li><strong>Analytics queries:</strong> "Count appointments by type per patient" → JOIN creates PHI</li>
                            <li><strong>Export features:</strong> "Download patient list with appointment history" → massive PHI exposure</li>
                            <li><strong>Search functionality:</strong> "Find patients with cardiology appointments" → search results = PHI</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>✅ BETTER Pattern: Application-Layer Joins with Hashing</h4>
                        <div class="code-example"><span class="comment">-- Keep tables separate, join in application when absolutely necessary</span>

                <span class="comment">-- Query 1: Get appointment IDs for date range (no PII)</span>
                <span class="keyword">SELECT</span> 
                patient_hash,                       <span class="comment">-- ✅ Hash, not direct ID</span>
                appointment_type,                   <span class="comment">-- Health data but no PII</span>
                appointment_date
                <span class="keyword">FROM</span> appointments
                <span class="keyword">WHERE</span> appointment_date > NOW();

                <span class="comment">-- Query 2: Get patient contact info separately (PII, no health context)</span>
                <span class="keyword">SELECT</span> email, full_name
                <span class="keyword">FROM</span> patients
                <span class="keyword">WHERE</span> patient_id = unhash(patient_hash);  <span class="comment">-- Application layer hashing</span>

                <span class="comment">-- Application decides IF and WHEN to combine them</span>
                <span class="comment">-- Only combine in memory for immediate use (sending reminder)</span>
                <span class="comment">-- Never persist the combined result</span>
                <span class="comment">-- Never log the combined result</span></div>
                    </div>
                </div>

                <div class="content-section">
                    <h3>🌐 API Design Patterns That Create PHI</h3>
                    
                    <div class="scenario-box">
                        <h4>Pattern 1: The "Kitchen Sink" API Response</h4>
                        <p><strong>The Setup:</strong> Single endpoint returns everything about a user</p>
                        
                        <div class="code-example"><span class="comment">// Common pattern: Comprehensive user profile endpoint</span>
                <span class="keyword">GET</span> /api/v1/users/{id}

                <span class="comment">// Response: Everything in one place</span>
                {
                <span class="string">"userId"</span>: 12345,
                <span class="string">"email"</span>: <span class="string">"sarah@email.com"</span>,        <span class="comment">// ⚠️ PII</span>
                <span class="string">"phone"</span>: <span class="string">"+1-555-0123"</span>,            <span class="comment">// ⚠️ PII</span>
                <span class="string">"firstName"</span>: <span class="string">"Sarah"</span>,              <span class="comment">// ⚠️ PII</span>
                <span class="string">"lastName"</span>: <span class="string">"Johnson"</span>,             <span class="comment">// ⚠️ PII</span>
                <span class="string">"dateOfBirth"</span>: <span class="string">"1985-03-15"</span>,       <span class="comment">// ⚠️ PII</span>
                
                <span class="string">"healthProfile"</span>: {
                    <span class="string">"primaryDiagnosis"</span>: <span class="string">"Type 2 Diabetes"</span>,  <span class="comment">// ⚠️ Health data</span>
                    <span class="string">"medications"</span>: [
                    {<span class="string">"name"</span>: <span class="string">"Metformin"</span>, <span class="string">"dosage"</span>: <span class="string">"500mg"</span>},
                    {<span class="string">"name"</span>: <span class="string">"Lisinopril"</span>, <span class="string">"dosage"</span>: <span class="string">"10mg"</span>}
                    ],
                    <span class="string">"allergies"</span>: [<span class="string">"Penicillin"</span>],
                    <span class="string">"lastVisit"</span>: <span class="string">"2025-10-15"</span>
                },
                
                <span class="string">"appointments"</span>: [
                    {<span class="string">"date"</span>: <span class="string">"2025-11-20"</span>, <span class="string">"type"</span>: <span class="string">"Cardiology"</span>}
                ]
                }

                <span class="comment">// ⚠️ MASSIVE PHI exposure in single response</span>
                <span class="comment">// API logs, caching, frontend state, error tracking all contain PHI</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Cascading Problems:</strong></p>
                        <ul>
                            <li><strong>API Gateway logs:</strong> Request/response logging captures entire PHI payload</li>
                            <li><strong>CDN/Load Balancer:</strong> Access logs may include response bodies</li>
                            <li><strong>API caching:</strong> Redis, Memcached, CDN edge caches contain PHI</li>
                            <li><strong>Frontend state:</strong> Redux/Vuex stores, localStorage, sessionStorage have PHI</li>
                            <li><strong>Error tracking:</strong> If API fails, error report includes full response with PHI</li>
                            <li><strong>Developer tools:</strong> Network tab, Redux DevTools expose PHI to anyone watching</li>
                            <li><strong>API documentation:</strong> Swagger/OpenAPI examples might use real PHI inadvertently</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>✅ BETTER Pattern: Separate Endpoints by Concern</h4>
                        <div class="code-example"><span class="comment">// Separate endpoints for different data categories</span>

                <span class="comment">// Endpoint 1: Identity/Contact (PII only, no health context)</span>
                <span class="keyword">GET</span> /api/v1/users/{id}/contact
                {
                <span class="string">"email"</span>: <span class="string">"sarah@email.com"</span>,        <span class="comment">// PII but no health context</span>
                <span class="string">"phone"</span>: <span class="string">"+1-555-0123"</span>,            <span class="comment">// PII but no health context</span>
                <span class="string">"preferredContact"</span>: <span class="string">"email"</span>
                }
                <span class="comment">// ✅ Can be cached, logged more freely (no health context)</span>

                <span class="comment">// Endpoint 2: Health Summary (uses hashed ID, no direct PII)</span>
                <span class="keyword">GET</span> /api/v1/health/{patient_hash}/summary
                {
                <span class="string">"patientHash"</span>: <span class="string">"7a3f9c2e..."</span>,      <span class="comment">// ✅ Hash, not email/name</span>
                <span class="string">"diagnosisCategory"</span>: <span class="string">"endocrine"</span>,  <span class="comment">// ✅ Category, not "diabetes"</span>
                <span class="string">"medicationCount"</span>: 2,               <span class="comment">// ✅ Count, not drug names</span>
                <span class="string">"lastVisitMonth"</span>: <span class="string">"2025-10"</span>         <span class="comment">// ✅ Month, not exact date</span>
                }
                <span class="comment">// ✅ Health data but no direct PII = not PHI until joined</span>

                <span class="comment">// Endpoint 3: Appointments (if PII needed, separate call)</span>
                <span class="keyword">GET</span> /api/v1/appointments?patient_hash={hash}
                {
                <span class="string">"appointments"</span>: [
                    {
                    <span class="string">"appointmentId"</span>: <span class="string">"appt_xyz"</span>,
                    <span class="string">"dateTime"</span>: <span class="string">"2025-11-20T14:00:00Z"</span>,
                    <span class="string">"specialty"</span>: <span class="string">"cardiology"</span>,    <span class="comment">// Health data</span>
                    <span class="string">"status"</span>: <span class="string">"scheduled"</span>
                    }
                ]
                }
                <span class="comment">// ✅ Uses patient_hash, frontend can correlate if needed</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Architectural Benefits:</strong></p>
                        <ul>
                            <li>Can cache contact info without caching health data</li>
                            <li>Different authentication/authorization for each endpoint</li>
                            <li>Separate rate limiting (health endpoints more restrictive)</li>
                            <li>Easier to audit access patterns per data type</li>
                            <li>Can use different CSP services for different data types (with appropriate BAAs)</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>Pattern 2: GraphQL Over-Fetching Risk</h4>
                        <p><strong>The Setup:</strong> Flexible GraphQL API allowing arbitrary queries</p>
                        
                        <div class="code-example"><span class="comment">// GraphQL schema that allows dangerous queries</span>
                type User {
                id: ID!
                email: String!                    <span class="comment"># ⚠️ PII</span>
                firstName: String!                <span class="comment"># ⚠️ PII</span>
                lastName: String!                 <span class="comment"># ⚠️ PII</span>
                
                <span class="comment"># Nested health data accessible in same query</span>
                healthProfile: HealthProfile      <span class="comment"># ⚠️ Can be queried together</span>
                appointments: [Appointment!]!     <span class="comment"># ⚠️ Can be queried together</span>
                medications: [Medication!]!       <span class="comment"># ⚠️ Can be queried together</span>
                }

                <span class="comment"># Client query (creates PHI):</span>
                query GetUserComplete {
                user(id: "12345") {
                    email                           <span class="comment"># PII</span>
                    firstName                       <span class="comment"># PII</span>
                    healthProfile {
                    diagnoses                     <span class="comment"># Health data</span>
                    }
                    appointments {
                    type                          <span class="comment"># Health data</span>
                    date
                    }
                }
                }

                <span class="comment"># ⚠️ Single GraphQL query creates PHI by combining fields</span>
                <span class="comment"># GraphQL introspection exposes entire schema to clients</span>
                <span class="comment"># Query complexity allows deep nesting of PII + health data</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>GraphQL-Specific Risks:</strong></p>
                        <ul>
                            <li><strong>Over-fetching:</strong> Clients can request PII + health data in single query</li>
                            <li><strong>Query logging:</strong> Full GraphQL queries in logs expose field combinations</li>
                            <li><strong>Introspection:</strong> Schema exploration reveals all available PHI fields</li>
                            <li><strong>Complexity attacks:</strong> Deeply nested queries can join multiple PHI sources</li>
                            <li><strong>Caching challenges:</strong> Harder to cache safely when queries are dynamic</li>
                            <li><strong>Error responses:</strong> GraphQL errors often include field paths with PHI context</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>✅ SAFER Pattern: GraphQL with Field-Level Authorization</h4>
                        <div class="code-example"><span class="comment">// Implement field-level permissions and separate types</span>

                type User {
                id: ID!
                email: String! <span class="keyword">@auth</span>(requires: CONTACT_ACCESS)
                firstName: String! <span class="keyword">@auth</span>(requires: CONTACT_ACCESS)
                
                <span class="comment"># Cannot query health fields unless user has HEALTH_ACCESS</span>
                <span class="comment"># AND query is explicitly authorized</span>
                }

                <span class="comment"># Separate type - cannot be queried with User in same query</span>
                type HealthProfile <span class="keyword">@auth</span>(requires: HEALTH_ACCESS) {
                patientHash: String!              <span class="comment"># NOT user.id</span>
                diagnosisCategory: String         <span class="comment"># Category, not specific diagnosis</span>
                <span class="comment"># Specific diagnosis requires additional authorization</span>
                }

                <span class="comment"># Queries are separated by design</span>
                type Query {
                user(id: ID!): User <span class="keyword">@auth</span>(requires: CONTACT_ACCESS)
                
                <span class="comment"># Health queries use different ID type (hash)</span>
                healthProfile(patientHash: String!): HealthProfile 
                    <span class="keyword">@auth</span>(requires: HEALTH_ACCESS)
                }

                <span class="comment"># ✅ Cannot combine PII + health in single query</span>
                <span class="comment"># ✅ Different authorization for different data types</span>
                <span class="comment"># ✅ Introspection can be disabled in production</span></div>
                    </div>

                    <div class="scenario-box">
                        <h4>Pattern 3: Pagination & Filtering Exposures</h4>
                        <p><strong>The Setup:</strong> API with flexible filtering and pagination</p>
                        
                        <div class="code-example"><span class="comment">// Dangerous: Flexible filters that combine PII + health context</span>
                <span class="keyword">GET</span> /api/v1/patients?
                email=contains:john&                <span class="comment">// ⚠️ PII filter</span>
                diagnosis=diabetes&                 <span class="comment">// ⚠️ Health filter</span>
                medication=metformin&               <span class="comment">// ⚠️ Health filter</span>
                city=Boston&                        <span class="comment">// ⚠️ PII filter</span>
                sort=lastName&
                limit=50

                <span class="comment">// Response:</span>
                {
                <span class="string">"results"</span>: [
                    {
                    <span class="string">"email"</span>: <span class="string">"john.doe@email.com"</span>,     <span class="comment">// PII</span>
                    <span class="string">"diagnosis"</span>: <span class="string">"Type 2 Diabetes"</span>,  <span class="comment">// Health</span>
                    <span class="string">"medication"</span>: <span class="string">"Metformin"</span>         <span class="comment">// Health</span>
                    }
                    <span class="comment">// ... 49 more patients</span>
                ],
                <span class="string">"total"</span>: 247,
                <span class="string">"page"</span>: 1
                }

                <span class="comment">// ⚠️ Problems:</span>
                <span class="comment">// 1. Query string in logs contains PHI search criteria</span>
                <span class="comment">// 2. Response contains massive PHI exposure (50 patients)</span>
                <span class="comment">// 3. Pagination state in frontend may cache PHI</span>
                <span class="comment">// 4. URL can be shared, bookmarked with PHI in query params</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Pagination-Specific Risks:</strong></p>
                        <ul>
                            <li><strong>URL parameters:</strong> PHI in query strings gets logged everywhere (API logs, proxy logs, browser history)</li>
                            <li><strong>Cursor-based pagination:</strong> Cursors may encode PHI to maintain position</li>
                            <li><strong>Large result sets:</strong> Bulk export features create massive PHI exposure</li>
                            <li><strong>Search autocomplete:</strong> Real-time search suggestions may expose PHI patterns</li>
                            <li><strong>Filter persistence:</strong> Saved filters/searches stored with PHI criteria</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>✅ SAFER Pattern: POST-Based Filtering with Constraints</h4>
                        <div class="code-example"><span class="comment">// Better: POST request with body (not logged in URLs)</span>
                <span class="keyword">POST</span> /api/v1/patients/search
                Content-Type: application/json

                {
                <span class="string">"filters"</span>: {
                    <span class="string">"diagnosisCategory"</span>: <span class="string">"endocrine"</span>,    <span class="comment">// ✅ Category, not specific</span>
                    <span class="string">"ageRange"</span>: {<span class="string">"min"</span>: 40, <span class="string">"max"</span>: 60},  <span class="comment">// ✅ Range, not exact</span>
                    <span class="string">"zipPrefix"</span>: <span class="string">"021"</span>                  <span class="comment">// ✅ Prefix only</span>
                },
                <span class="string">"pagination"</span>: {
                    <span class="string">"limit"</span>: 20,                        <span class="comment">// ✅ Max 20, not 50+</span>
                    <span class="string">"cursor"</span>: <span class="string">"opaque_token_xyz"</span>      <span class="comment">// ✅ Opaque, no PHI</span>
                },
                <span class="string">"fields"</span>: [<span class="string">"patientHash"</span>, <span class="string">"ageRange"</span>]  <span class="comment">// ✅ Explicit, no email</span>
                }

                <span class="comment">// Response: Limited, de-identified</span>
                {
                <span class="string">"results"</span>: [
                    {
                    <span class="string">"patientHash"</span>: <span class="string">"7a3f9c2e..."</span>,     <span class="comment">// ✅ Hash</span>
                    <span class="string">"ageRange"</span>: <span class="string">"40-49"</span>,              <span class="comment">// ✅ Range</span>
                    <span class="string">"diagnosisCategory"</span>: <span class="string">"endocrine"</span>   <span class="comment">// ✅ Category</span>
                    }
                ],
                <span class="string">"nextCursor"</span>: <span class="string">"opaque_token_abc"</span>,
                <span class="string">"hasMore"</span>: <span class="keyword">true</span>
                }

                <span class="comment">// ✅ No PII in response, generalized health data only</span></div>
                    </div>
                </div>

                <div class="content-section">
                    <h3>🎯 Builder's Checklist: PHI-Safe API & Database Design</h3>
                    
                    <div class="scenario-box">
                        <h4>Database Design Review:</h4>
                        <ol style="padding-left: 1.5rem; line-height: 2.2;">
                            <li>
                                <span class="tooltip-item"><strong>Table separation:</strong> Can you separate PII tables from health data tables?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>Keep user contact info (names, emails) in different tables from medical data (diagnoses, prescriptions).</p>
                                        <strong>Why it matters:</strong>
                                        <p>When separated, you reduce the chance of accidentally creating PHI. A query against just the contact table won't expose health data.</p>
                                        <strong>Example:</strong>
                                        <p><code>users</code> table vs <code>medical_records</code> table instead of one big <code>patient_data</code> table.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Foreign keys:</strong> Do FKs force joins that create PHI? Consider application-layer hashing instead
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>If your database schema requires joining PII+health tables just to get basic info, you're creating PHI constantly.</p>
                                        <strong>Alternative:</strong>
                                        <p>Use hashed IDs at the application layer so the DB doesn't know the direct relationship.</p>
                                        <strong>Example:</strong>
                                        <p>Instead of <code>SELECT users.name, visits.diagnosis FROM users JOIN visits</code>, your app uses a hash to lookup separately.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Query patterns:</strong> Audit common queries - do they SELECT across PII + health tables?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>Audit your most common queries - are developers routinely joining contact info with medical data?</p>
                                        <strong>Risk:</strong>
                                        <p>Every time this happens, PHI flows through your app, logs, caches, etc.</p>
                                        <strong>Action:</strong>
                                        <p>Look for JOIN patterns between PII and health data tables in your codebase.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>ORM configuration:</strong> Does ORM default to SELECT *? Can you configure explicit column selection?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>ORMs (like Hibernate, Entity Framework, Sequelize) often fetch ALL columns by default.</p>
                                        <strong>Risk:</strong>
                                        <p>Developer wants just an email address, but ORM pulls diagnosis codes too.</p>
                                        <strong>Fix:</strong>
                                        <p>Configure explicit column selection and lazy loading to only fetch what's needed.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Indexing strategy:</strong> Are you indexing on PHI fields? (Index contents may be logged, cached)
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>Database indexes can show up in query plans, performance logs, and cache layers.</p>
                                        <strong>Risk:</strong>
                                        <p>Index on <code>diagnosis_code</code> field → logs show which diagnoses are being searched.</p>
                                        <strong>Consideration:</strong>
                                        <p>Sometimes necessary for performance, but be aware indexes expose data in monitoring tools.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Database logging:</strong> Are queries logged? Do logs expose PHI in WHERE clauses?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>Many DBs log slow queries, error queries, or all queries for debugging.</p>
                                        <strong>Risk:</strong>
                                        <p>Log shows <code>WHERE patient_name='John Smith' AND diagnosis='HIV'</code></p>
                                        <strong>Fix:</strong>
                                        <p>Sanitize query logs, use parameterized queries, restrict log access.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Backup strategy:</strong> Can you backup PII separately from health data for different retention?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>If separated, you can keep contact info for 7 years but medical data for 10 (or whatever your retention policy requires).</p>
                                        <strong>Why it matters:</strong>
                                        <p>HIPAA has minimum retention requirements; separating data types gives you flexibility.</p>
                                        <strong>Bonus:</strong>
                                        <p>Makes it easier to respond to "right to be forgotten" requests.</p>
                                    </span>
                                </span>
                            </li>
                        </ol>
                        
                        <h4 style="margin-top: 2rem;">API Design Review:</h4>
                        <ol style="padding-left: 1.5rem; line-height: 2.2;">
                            <li>
                                <span class="tooltip-item"><strong>Response structure:</strong> Does single endpoint return PII + health data together?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>Does <code>/api/patient/123</code> return <code>{name: "Jane", diagnosis: "diabetes"}</code> in one response?</p>
                                        <strong>Risk:</strong>
                                        <p>Any consumer of that endpoint sees PHI, even if they only needed the name.</p>
                                        <strong>Better:</strong>
                                        <p>Separate endpoints or field selection.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Endpoint separation:</strong> Can you split into /contact, /health, /appointments endpoints?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>Different endpoints for different data types.</p>
                                        <strong>Benefits:</strong>
                                        <ul>
                                            <li>Can apply different security controls to each</li>
                                            <li>Can audit "who accesses health data" separately</li>
                                            <li>Reduces PHI exposure to only code paths that need it</li>
                                        </ul>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Field selection:</strong> Can clients request only fields they need? (GraphQL field selection, REST field parameter)
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>GraphQL-style field selection or REST parameter like <code>?fields=name,email</code></p>
                                        <strong>Why:</strong>
                                        <p>Frontend only needs to show appointment time? Don't send diagnosis codes.</p>
                                        <strong>Reduces:</strong>
                                        <p>PHI flowing to browser, client logs, network captures.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Authorization:</strong> Different auth levels for PII vs health data endpoints?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>Maybe all staff can see contact info, but only providers see diagnoses.</p>
                                        <strong>HIPAA angle:</strong>
                                        <p>Minimum necessary principle - limit access to only what's needed for job function.</p>
                                        <strong>Implementation:</strong>
                                        <p>Different API scopes/permissions for different endpoint groups.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Rate limiting:</strong> More restrictive limits for PHI-heavy endpoints?
                                    <span class="tooltip-content">
                                        <strong>What it means:</strong>
                                        <p>Allow more calls to <code>/api/contact</code> than <code>/api/diagnoses</code></p>
                                        <strong>Why:</strong>
                                        <p>Makes bulk PHI extraction harder, makes scraping attempts more visible.</p>
                                        <strong>Security depth:</strong>
                                        <p>Defense in depth against compromised credentials.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Caching strategy:</strong> What gets cached? For how long? Is PHI in cache covered by BAA?
                                    <span class="tooltip-content">
                                        <strong>Critical questions:</strong>
                                        <ul>
                                            <li>CDN caching API responses? → PHI in CDN logs (is CDN covered by BAA?)</li>
                                            <li>Browser caching with Cache-Control headers? → PHI in browser cache</li>
                                            <li>Redis/Memcached? → PHI in memory cache (encrypted? BAA? access controls?)</li>
                                        </ul>
                                        <strong>Rule of thumb:</strong>
                                        <p>PHI should rarely be cached; if it is, use short TTL and encryption.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Logging:</strong> Are request/response bodies logged? Do logs contain PHI?
                                    <span class="tooltip-content">
                                        <strong>Common issue:</strong>
                                        <p>API gateway logs full request/response for debugging.</p>
                                        <strong>Result:</strong>
                                        <p>Logs full of <code>{"patient": "John", "diagnosis": "cancer"}</code></p>
                                        <strong>Fix:</strong>
                                        <p>Sanitize logs, use correlation IDs instead of actual data, log only metadata.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Error responses:</strong> Do 400/500 errors expose PHI in error messages?
                                    <span class="tooltip-content">
                                        <strong>Bad example:</strong>
                                        <p><code>"Error: Patient John Smith's diagnosis of HIV cannot be updated"</code></p>
                                        <strong>Better:</strong>
                                        <p><code>"Error: Unable to update record ID abc123. Reference code: ERR-2938"</code></p>
                                        <strong>Principle:</strong>
                                        <p>Error messages shouldn't echo back sensitive data.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>API documentation:</strong> Are example requests/responses using real or realistic-fake PHI?
                                    <span class="tooltip-content">
                                        <strong>Risk:</strong>
                                        <p>Swagger docs show <code>"patient_name": "Sarah Johnson"</code> with real social security numbers from testing.</p>
                                        <strong>Better:</strong>
                                        <p>Obvious fake data like <code>"patient_name": "Test Patient"</code> or <code>"ssn": "000-00-0000"</code></p>
                                        <strong>Why:</strong>
                                        <p>Docs get shared, indexed, cached - don't want real PHI there.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Versioning:</strong> Old API versions still exposed with less secure PHI handling?
                                    <span class="tooltip-content">
                                        <strong>Scenario:</strong>
                                        <p>v2 API has proper PHI controls, but v1 is still running and returns PHI in logs.</p>
                                        <strong>Risk:</strong>
                                        <p>Attackers/auditors find old version with weaker security.</p>
                                        <strong>Fix:</strong>
                                        <p>Deprecate and sunset old versions, or retrofit security controls.</p>
                                    </span>
                                </span>
                            </li>
                        </ol>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <strong>⚠️ REST vs GraphQL for Healthcare:</strong> REST with explicit, separated endpoints is often SAFER than GraphQL for PHI because it's easier to control what data can be combined in a single request. GraphQL flexibility = PHI risk unless you implement strict field-level authorization.
                </div>

                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-title">Exercise 3.2b: API Design Challenge</div>
                        </div>

                        <div class="question" data-question="11" data-correct="no">
                            <div class="question-text">11. API endpoint response: <code>`GET /api/v1/users/{hash}/activity` returns: `{"userHash": "abc123...", "sessionCount": 47, "avgSessionMinutes": 8.5, "lastActiveDate": "2025-10-15"}`</code> - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="yes" tabindex="0">Yes - PHI</li>
                                <li class="option" data-answer="no" tabindex="0">No - Safe data</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> User hash (non-identifiable, can't reverse to email/name) + general activity metrics (no health context) = Safe. This is good API design: hashed identifier with aggregated behavioral data. No PII exposed, no health-specific features mentioned.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Hashed user ID + general activity metrics = safe. The hash can't be reversed to identify individuals (no email, name, phone). Activity metrics don't indicate health conditions. The correct answer is <strong>No</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="12" data-correct="no">
                            <div class="question-text">12. Analytics API: <code>`GET /api/v1/analytics/regional-health` returns: `{"region": "northeast", "avgMetric": 72.5, "userCount": 1847, "trend": "improving"}`</code> - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="yes" tabindex="0">Yes - PHI</li>
                                <li class="option" data-answer="no" tabindex="0">No - Safe</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Aggregated regional data with large user count (1,847 users) = Safe. Meets k-anonymity thresholds (k >> 5). No individual identification possible. This is the gold standard for healthcare analytics APIs: aggregate only, no individual-level data.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Properly aggregated data (1,847 users) with regional grouping = safe, not PHI. No individual can be identified from aggregate statistics. Even though it's health-related ("health" in endpoint name), aggregation prevents PHI creation. The correct answer is <strong>No</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="13" data-correct="yes">
                            <div class="question-text">13. API endpoint: <code>`GET /api/v1/patients/{id}/dashboard` returns: `{"email": "mary@company.com", "upcomingVisits": [{"date": "2025-11-20", "type": "Cardiac Rehabilitation", "provider": "Dr. Smith"}], "activePrescriptions": 3}`</code> - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="no" tabindex="0">No - Safe</li>
                                <li class="option" data-answer="yes" tabindex="0">Yes - PHI</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Email (PII) + "Cardiac Rehabilitation" visit (implies heart condition) = PHI. This is a classic "kitchen sink" API pattern that combines everything in one response. API logs, caching layers, frontend state, error tracking all now contain PHI. Better design: separate /contact and /health endpoints with hashed IDs.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Email + cardiac rehabilitation visit = PHI because it combines PII with health context (heart condition). Even though "activePrescriptions" is just a count, "Cardiac Rehabilitation" reveals health condition. This API design creates unnecessary PHI exposure. The correct answer is <strong>Yes</strong>.
                            </div>
                        </div>
                    </div>

                    <div class="subsection-nav">
                        <button class="btn btn-secondary subsection-nav-btn" onclick="prevSubsection()">
                            ← Previous: Basic Context
                        </button>
                        <div style="color: #6c757d; font-weight: bold;">Section 2 of 6</div>
                        <button class="btn btn-primary subsection-nav-btn" onclick="nextSubsection()">
                            Next: Logging & Analytics →
                        </button>
                    </div>
                </div>

                <!-- Subsection: Logging -->
                <div class="module-subsection" id="subsection-logging">
                    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
                        <strong style="color: #2980b9;">🔍 Current Section: 3. Logging & Analytics Traps</strong>
                    </div>
                <div class="content-section">
                    <h3>Logging & Analytics Traps: The Silent PHI Exposures</h3>
                    <p><strong>Reality for builders:</strong> Application logs, error tracking, APM tools, and observability platforms are where PHI exposure happens most frequently - and most silently. You're debugging, optimizing performance, tracking errors... and accidentally logging PHI to systems without BAAs.</p>
                </div>

                <div class="alert alert-danger">
                    <strong>🚨 Critical Reality:</strong> Logging is often the #1 source of unintentional PHI exposure in technical environments. Developers log verbosely during debugging and forget to remove it. Error handlers dump entire request objects. APM tools auto-capture parameters. And suddenly, PHI is in CloudWatch, Datadog, Splunk, or Sentry - systems that may not have BAAs.
                </div>

                <div class="content-section">
                    <h3>🪵 Common Logging Patterns That Expose PHI</h3>
                    
                    <div class="scenario-box">
                        <h4>Pattern 1: Verbose Debug Logging</h4>
                        <p><strong>The Setup:</strong> Developer debugging API issues in production</p>
                        
                        <div class="code-example"><span class="comment">// Common mistake: Logging entire request objects</span>
                <span class="keyword">app.post</span>(<span class="string">'/api/appointments'</span>, (req, res) => {
                logger.debug(<span class="string">'Received appointment request:'</span>, req.body);
                <span class="comment">// ⚠️ req.body might contain:</span>
                <span class="comment">// {</span>
                <span class="comment">//   "patientEmail": "sarah@email.com",</span>
                <span class="comment">//   "appointmentType": "Cardiology Consultation",</span>
                <span class="comment">//   "symptoms": "chest pain, shortness of breath"</span>
                <span class="comment">// }</span>
                
                <span class="keyword">try</span> {
                    <span class="keyword">const</span> result = createAppointment(req.body);
                    logger.info(<span class="string">'Appointment created:'</span>, result);
                    <span class="comment">// ⚠️ Result object likely contains PHI too</span>
                    res.json(result);
                } <span class="keyword">catch</span> (error) {
                    logger.error(<span class="string">'Failed to create appointment:'</span>, error, req.body);
                    <span class="comment">// ⚠️ Error logs with full request = PHI in error tracking</span>
                }
                });

                <span class="comment">// ⚠️ All of this PHI is now in:</span>
                <span class="comment">// - CloudWatch Logs / Cloud Logging / Azure Monitor</span>
                <span class="comment">// - Log aggregation (Splunk, Elasticsearch, Datadog)</span>
                <span class="comment">// - Error tracking (Sentry, Rollbar, Bugsnag)</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Why This is Dangerous:</strong></p>
                        <ul>
                            <li>Logs persist long-term (often 30-90+ days retention)</li>
                            <li>Logs are indexed, searchable, and accessible by many team members</li>
                            <li>Log aggregation tools sync to analytics, alerting, dashboards</li>
                            <li>Many logging/APM tools don't have BAAs or only offer them at enterprise tier</li>
                            <li>Logs get exported for troubleshooting, shared in Slack, attached to tickets</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>Pattern 2: Database Query Logging</h4>
                        <p><strong>The Setup:</strong> ORM or database client with query logging enabled</p>
                        
                        <div class="code-example"><span class="comment">// Many ORMs log SQL queries by default</span>
                <span class="comment">// Sequelize, TypeORM, Entity Framework, etc.</span>

                <span class="comment">// Development config (often copied to production):</span>
                {
                <span class="string">"logging"</span>: <span class="keyword">true</span>,  <span class="comment">// ⚠️ Logs ALL queries</span>
                <span class="string">"logLevel"</span>: <span class="string">"debug"</span>
                }

                <span class="comment">// Results in logs like:</span>
                <span class="comment">// Executing: SELECT * FROM patients WHERE email = 'john@email.com'</span>
                <span class="comment">// Executing: UPDATE medications SET dosage = '10mg', drug_name = 'Metformin' </span>
                <span class="comment">//            WHERE patient_id = 12345</span>
                <span class="comment">// Executing: INSERT INTO diagnoses (patient_id, icd_code, description) </span>
                <span class="comment">//            VALUES (12345, 'E11.9', 'Type 2 Diabetes')</span>

                <span class="comment">// ⚠️ PHI in query parameters, WHERE clauses, INSERT values</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Critical Points:</strong></p>
                        <ul>
                            <li>Query logging often enabled in development, accidentally left on in production</li>
                            <li>Parameterized queries still log the parameter VALUES in many ORMs</li>
                            <li>Database audit logs (AWS RDS logs, Cloud SQL logs, Azure SQL audit) capture queries</li>
                            <li>Slow query logs capture full SQL with PHI in WHERE clauses</li>
                            <li>Connection pool logs may capture authentication with connection strings containing PHI table names</li>
                        </ul>
                    </div>

                    <div class="scenario-box">
                        <h4>Pattern 3: APM Tool Auto-Instrumentation</h4>
                        <p><strong>The Setup:</strong> Application Performance Monitoring with automatic tracing</p>
                        
                        <div class="code-example"><span class="comment">// APM tools (Datadog, New Relic, AppDynamics, Dynatrace) </span>
                <span class="comment">// auto-instrument HTTP requests and capture:</span>

                <span class="comment">// HTTP Request captured by APM:</span>
                POST /api/prescriptions
                Headers:
                Authorization: Bearer eyJ...
                X-User-Email: doctor.smith@hospital.com  <span class="comment">// ⚠️ PII</span>

                Query Params:
                patientId=12345                          <span class="comment">// ⚠️ PII</span>

                Request Body:
                {
                <span class="string">"medication"</span>: <span class="string">"Lisinopril"</span>,             <span class="comment">// ⚠️ Health data (BP med)</span>
                <span class="string">"dosage"</span>: <span class="string">"10mg"</span>,
                <span class="string">"diagnosis"</span>: <span class="string">"Hypertension"</span>           <span class="comment">// ⚠️ Health data</span>
                }

                <span class="comment">// APM trace includes:</span>
                <span class="comment">// - Full URL with query params (patientId)</span>
                <span class="comment">// - Request headers (user email)</span>
                <span class="comment">// - Request/response bodies (medication + diagnosis)</span>
                <span class="comment">// - Database queries executed during request</span>
                <span class="comment">// - External API calls made</span>

                <span class="comment">// ⚠️ All of this is PHI if it combines PII + health data</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>APM-Specific Risks:</strong></p>
                        <ul>
                            <li>Auto-instrumentation captures MORE than you realize (headers, bodies, queries)</li>
                            <li>Distributed tracing follows requests across microservices, capturing PHI at each hop</li>
                            <li>Performance profiling captures function arguments (which may contain PHI)</li>
                            <li>Real User Monitoring (RUM) captures frontend interactions with PHI</li>
                            <li>APM dashboards, alerts, and team collaboration features expose PHI to many users</li>
                        </ul>
                        
                        <div class="alert alert-warning" style="margin-top: 1rem; font-size: 0.9rem;">
                            <strong>⚠️ BAA Reality Check:</strong> Many APM tools (Datadog, New Relic, AppDynamics, Dynatrace) offer BAAs - but often only at Enterprise tier, with specific configuration requirements, and not for all features (e.g., RUM, synthetic monitoring may be excluded).
                        </div>
                    </div>

                    <div class="scenario-box">
                        <h4>Pattern 4: Error Tracking with Full Context</h4>
                        <p><strong>The Setup:</strong> Error monitoring (Sentry, Rollbar, Bugsnag, Airbrake)</p>
                        
                        <div class="code-example"><span class="comment">// Typical error handler that captures too much</span>
                <span class="keyword">try</span> {
                <span class="keyword">const</span> prescription = <span class="keyword">await</span> createPrescription(patientData);
                } <span class="keyword">catch</span> (error) {
                Sentry.captureException(error, {
                    <span class="keyword">extra</span>: {
                    patientData: patientData,          <span class="comment">// ⚠️ Entire patient object</span>
                    userId: req.user.id,
                    userEmail: req.user.email,         <span class="comment">// ⚠️ PII</span>
                    requestBody: req.body,             <span class="comment">// ⚠️ May contain PHI</span>
                    timestamp: <span class="keyword">new</span> Date(),
                    environment: process.env.NODE_ENV
                    },
                    <span class="keyword">tags</span>: {
                    operation: <span class="string">'create_prescription'</span>,  <span class="comment">// ⚠️ Health context</span>
                    patientId: patientData.id          <span class="comment">// ⚠️ PII</span>
                    }
                });
                }

                <span class="comment">// Sentry error report now contains:</span>
                <span class="comment">// - Stack trace (may include PHI in variable names/values)</span>
                <span class="comment">// - User email (PII)</span>
                <span class="comment">// - Full patient data object (PHI)</span>
                <span class="comment">// - Request context (may contain PHI)</span>
                <span class="comment">// - Breadcrumbs (user actions leading to error - may reveal health behaviors)</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Error Tracking Risks:</strong></p>
                        <ul>
                            <li>Stack traces can contain variable values with PHI</li>
                            <li>Breadcrumbs track user navigation (e.g., "viewed diabetes resources → clicked medication list")</li>
                            <li>Request context captures URLs, headers, bodies with PHI</li>
                            <li>Session replay features (LogRocket, FullStory) record entire user sessions with PHI</li>
                            <li>Error grouping/aggregation creates patterns that infer conditions</li>
                            <li>Team collaboration features (comments, assignments) expose errors to many users</li>
                        </ul>
                        
                        <div class="alert alert-danger" style="margin-top: 1rem; font-size: 0.9rem;">
                            <strong>🚨 Session Replay Risk:</strong> Tools like LogRocket, FullStory, Hotjar that record user sessions are EXTREMELY high risk for PHI. They capture everything users see and do - forms, content, navigation. Most do NOT offer BAAs or HIPAA compliance.
                        </div>
                    </div>

                    <div class="scenario-box">
                        <h4>Pattern 5: Log Aggregation & Search Platforms</h4>
                        <p><strong>The Setup:</strong> Centralized logging (Splunk, Elasticsearch, Datadog Logs, CloudWatch Insights)</p>
                        
                        <div class="code-example"><span class="comment">// Logs from multiple sources aggregated into searchable platform</span>

                <span class="comment">// Application logs:</span>
                2025-10-19 14:23:15 INFO Processing appointment for sarah@email.com
                2025-10-19 14:23:16 DEBUG Appointment type: Cardiology consultation
                2025-10-19 14:23:17 INFO Sending reminder to +1-555-0123

                <span class="comment">// Nginx/API Gateway logs:</span>
                POST /api/prescriptions?patientId=12345&medication=Lisinopril
                User-Agent: HealthApp/2.0 (patient-portal)

                <span class="comment">// Database audit logs:</span>
                UPDATE medications SET drug_name='Metformin', dosage='500mg' 
                WHERE patient_id=12345

                <span class="comment">// All aggregated and searchable:</span>
                <span class="comment">// Search: "sarah@email.com" → finds appointment, medication, diagnosis</span>
                <span class="comment">// Search: "patientId=12345" → finds all health activities</span>
                <span class="comment">// Search: "Cardiology" → finds all cardiology patients</span>

                <span class="comment">// ⚠️ Log aggregation platform becomes PHI repository</span></div>
                        
                        <p style="margin-top: 1rem;"><strong>Aggregation Risks:</strong></p>
                        <ul>
                            <li>Combines logs from multiple sources, creating PHI where individual logs might not</li>
                            <li>Search/query capabilities make PHI easily discoverable</li>
                            <li>Long retention periods (30-90+ days, sometimes years for compliance)</li>
                            <li>Wide access - many team members have log search access for troubleshooting</li>
                            <li>Alerting/dashboards expose PHI in Slack, email, PagerDuty notifications</li>
                            <li>Log exports for analysis create PHI in CSV/JSON files on developer machines</li>
                        </ul>
                    </div>
                </div>

                <div class="content-section">
                    <h3>🛠️ Safe vs Unsafe Logging Patterns</h3>
                    
                    <div class="scenario-box">
                        <h4>❌ UNSAFE: Logging Everything</h4>
                        <div class="code-example"><span class="comment">// Dangerous: No filtering, logs everything</span>
                logger.info(<span class="string">'User action'</span>, {
                userId: user.id,
                email: user.email,                    <span class="comment">// ⚠️ PII</span>
                action: <span class="string">'viewed_content'</span>,
                contentTitle: <span class="string">'Managing Type 2 Diabetes'</span>,  <span class="comment">// ⚠️ Health context</span>
                timestamp: <span class="keyword">new</span> Date(),
                sessionData: req.session              <span class="comment">// ⚠️ May contain PHI</span>
                });

                <span class="comment">// Database logging ON for all queries</span>
                sequelize = <span class="keyword">new</span> Sequelize(config, {
                logging: console.log,                 <span class="comment">// ⚠️ Logs all queries with PHI</span>
                benchmark: <span class="keyword">true</span>
                });

                <span class="comment">// APM with default configuration</span>
                <span class="comment">// Captures all headers, bodies, query params</span></div>
                    </div>

                    <div class="scenario-box">
                        <h4>✅ SAFER: Structured Logging with Filtering</h4>
                        <div class="code-example"><span class="comment">// Better: Structured logging with PHI filtering</span>
                <span class="keyword">const</span> safeLogger = {
                info: (message, data) => {
                    <span class="keyword">const</span> filtered = filterPHI(data);  <span class="comment">// Remove/hash PII fields</span>
                    logger.info(message, filtered);
                }
                };

                <span class="keyword">function</span> filterPHI(data) {
                <span class="keyword">return</span> {
                    userHash: data.userId ? hash(data.userId) : <span class="keyword">null</span>,  <span class="comment">// Hash, don't expose</span>
                    action: data.action,
                    contentCategory: categorize(data.contentTitle),  <span class="comment">// "health" not "diabetes"</span>
                    timestamp: data.timestamp,
                    <span class="comment">// Explicitly exclude: email, phone, names, specific diagnoses</span>
                };
                }

                safeLogger.info(<span class="string">'User action'</span>, {
                userId: user.id,
                action: <span class="string">'viewed_content'</span>,
                contentTitle: <span class="string">'Managing Type 2 Diabetes'</span>
                });
                <span class="comment">// Logs: { userHash: "7a3f9c...", action: "viewed_content", </span>
                <span class="comment">//        contentCategory: "health", timestamp: "..." }</span>
                <span class="comment">// ✅ No PII, generalized health context = no PHI</span></div>
                    </div>

                    <div class="scenario-box">
                        <h4>✅ BEST: Production Log Strategy</h4>
                        <div class="code-example"><span class="comment">// Gold standard: Separate log levels, strict filtering, BAA-covered tools</span>

                <span class="comment">// 1. Disable verbose logging in production</span>
                <span class="keyword">const</span> logLevel = process.env.NODE_ENV === <span class="string">'production'</span> 
                ? <span class="string">'warn'</span>  <span class="comment">// Only warnings and errors</span>
                : <span class="string">'debug'</span>;

                <span class="comment">// 2. Never log request/response bodies in production</span>
                <span class="keyword">app.use</span>((req, res, next) => {
                <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) {
                    logger.debug(<span class="string">'Request:'</span>, sanitize(req.body));
                }
                <span class="comment">// In production: Log only non-PHI metadata</span>
                logger.info(<span class="string">'Request received'</span>, {
                    method: req.method,
                    path: req.path,  <span class="comment">// No query params with PII</span>
                    statusCode: res.statusCode,
                    duration: res.duration,
                    requestId: req.id  <span class="comment">// Random ID, not user ID</span>
                });
                next();
                });

                <span class="comment">// 3. Configure APM to exclude sensitive data</span>
                <span class="keyword">const</span> apm = require(<span class="string">'elastic-apm-node'</span>).start({
                captureBody: <span class="string">'off'</span>,                    <span class="comment">// Don't capture request bodies</span>
                captureHeaders: <span class="keyword">false</span>,                <span class="comment">// Don't capture headers</span>
                sanitizeFieldNames: [<span class="string">'email'</span>, <span class="string">'phone'</span>, <span class="string">'ssn'</span>, <span class="string">'patient*'</span>]
                });

                <span class="comment">// 4. Disable database query logging in production</span>
                <span class="keyword">const</span> sequelize = <span class="keyword">new</span> Sequelize(config, {
                logging: process.env.NODE_ENV === <span class="string">'production'</span> ? <span class="keyword">false</span> : console.log
                });

                <span class="comment">// ✅ Minimal logging, no PHI, still useful for debugging</span></div>
                    </div>
                </div>

                <div class="content-section">
                    <h3>🎯 Builder's Checklist: PHI-Safe Logging</h3>
                    
                    <div class="scenario-box">
<h4>Before Deploying to Production:</h4>
                        <ol style="padding-left: 1.5rem; line-height: 2.2;">
                            <li>
                                <span class="tooltip-item"><strong>Audit log statements:</strong> Search codebase for logger.debug, console.log, print statements
                                    <span class="tooltip-content">
                                        <strong>Why this matters:</strong>
                                        <p>Debug statements often log entire objects "temporarily" during development and get forgotten. These are PHI time bombs.</p>
                                        <strong>What to search for:</strong>
                                        <ul>
                                            <li><code>logger.debug(</code> or <code>console.log(</code> or <code>print(</code></li>
                                            <li><code>JSON.stringify(req.body)</code> or <code>str(user_obj)</code></li>
                                            <li>Any logging of <code>query.results</code>, <code>db.rows</code>, <code>api_response</code></li>
                                        </ul>
                                        <strong>Good vs Bad:</strong>
                                        <p>✅ Good: <code>logger.info('User login', {userId: hashId(user.id)})</code></p>
                                        <p>❌ Bad: <code>console.log('Debug user:', user)</code></p>
                                    </span>
                                </span>
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li>What objects are being logged? req.body? user objects? query results?</li>
                                    <li>Do any logs contain email, phone, patient IDs, diagnoses, medications?</li>
                                </ul>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Check ORM/database logging:</strong> Is query logging enabled? Are queries with PHI being logged?
                                    <span class="tooltip-content">
                                        <strong>The problem:</strong>
                                        <p>Many ORMs (Sequelize, Hibernate, Entity Framework) log ALL queries by default in development mode. Developers forget to disable this for production.</p>
                                        <strong>What gets exposed:</strong>
                                        <ul>
                                            <li><code>WHERE patient_name='John' AND diagnosis='HIV'</code></li>
                                            <li><code>INSERT INTO prescriptions (patient_id, drug, dosage) VALUES...</code></li>
                                            <li>Query parameters that contain PHI</li>
                                        </ul>
                                        <strong>How to fix:</strong>
                                        <p>Disable query logging in production, or configure to log only query structure (no parameters). Use parameterized queries always.</p>
                                        <strong>Consequence if missed:</strong>
                                        <p>Every database query with PHI is written to logs, often retained for months. This is a breach waiting to be discovered.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Review APM configuration:</strong> What does your APM tool capture by default?
                                    <span class="tooltip-content">
                                        <strong>Why this matters:</strong>
                                        <p>APM tools (Application Performance Monitoring) are designed to capture EVERYTHING by default to help with debugging. This is dangerous in healthcare.</p>
                                        <strong>Default capture includes:</strong>
                                        <ul>
                                            <li>Full HTTP request/response bodies</li>
                                            <li>All headers (may contain auth tokens with user identifiers)</li>
                                            <li>Query parameters from URLs</li>
                                            <li>Database query results</li>
                                            <li>Stack traces with local variables (may contain patient data)</li>
                                        </ul>
                                        <strong>Required actions:</strong>
                                        <ul>
                                            <li>Configure scrubbing rules to redact PHI fields</li>
                                            <li>Disable request/response body capture, or whitelist safe fields only</li>
                                            <li>Verify your APM vendor has signed a BAA</li>
                                        </ul>
                                        <strong>Real example:</strong>
                                        <p>New Relic by default captures full request bodies. If someone POSTs patient diagnosis data, it's in New Relic's servers. Without BAA = HIPAA violation.</p>
                                    </span>
                                </span>
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li>Request bodies? Response bodies? Headers? Query parameters?</li>
                                    <li>Do you have proper sanitization rules configured?</li>
                                    <li>Does your APM plan include BAA coverage?</li>
                                </ul>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Error tracking review:</strong> What context are you sending with errors?
                                    <span class="tooltip-content">
                                        <strong>The trap:</strong>
                                        <p>Error tracking tools (Sentry, Rollbar, Bugsnag) are built to send as much context as possible to help debug. This often includes PHI.</p>
                                        <strong>Common PHI exposures:</strong>
                                        <ul>
                                            <li>Full <code>req.body</code> attached to errors (contains patient form data)</li>
                                            <li>"Breadcrumbs" showing user navigation through health records</li>
                                            <li>Local variables in stack traces (may include query results)</li>
                                            <li>Session replay recordings (captures everything user sees/types)</li>
                                        </ul>
                                        <strong>Session replay = EXTREME RISK:</strong>
                                        <p>Session replay records everything: every click, every form field, every page view. If your app shows diagnoses, prescriptions, or patient names, it's ALL recorded and sent to the error tracking vendor.</p>
                                        <strong>How to fix:</strong>
                                        <p>Configure scrubbing rules, disable session replay, send only error messages (not full context), use hashed identifiers only.</p>
                                    </span>
                                </span>
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li>Full request objects? User objects? Database query results?</li>
                                    <li>Are breadcrumbs capturing health-related navigation?</li>
                                    <li>Session replay enabled? (High risk!)</li>
                                </ul>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Verify BAA coverage:</strong> For every logging/monitoring tool:
                                    <span class="tooltip-content">
                                        <strong>Legal requirement:</strong>
                                        <p>Any vendor that could potentially access PHI (even in logs) must sign a Business Associate Agreement (BAA) with you. Without BAA = automatic HIPAA violation.</p>
                                        <strong>Common mistakes:</strong>
                                        <ul>
                                            <li>Assuming cloud provider BAA covers all services (it often doesn't - check specific services)</li>
                                            <li>Using free/starter tiers that don't offer BAAs (must upgrade to enterprise)</li>
                                            <li>Not verifying BAA is actually signed and in place</li>
                                            <li>Using consumer tools (personal Dropbox, Gmail, etc.) for PHI</li>
                                        </ul>
                                        <strong>Check for each tool:</strong>
                                        <p>Go to vendor's website and search "BAA" or "HIPAA compliance". Most enterprise vendors have a self-service BAA signing process. If they don't offer BAAs, you CANNOT use them for any data that might contain PHI.</p>
                                        <strong>Example gotcha:</strong>
                                        <p>AWS signs BAA, but it only covers specific services. S3 (yes), but CloudWatch Logs requires configuration. Read the fine print.</p>
                                    </span>
                                </span>
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li>CloudWatch/Cloud Logging/Azure Monitor - covered by CSP BAA? Check specific service coverage</li>
                                    <li>Datadog/New Relic/AppDynamics - do you have enterprise tier with BAA?</li>
                                    <li>Sentry/Rollbar/Bugsnag - do they offer BAAs? At what tier?</li>
                                    <li>Splunk/Elasticsearch - on-premises or cloud? BAA configured?</li>
                                </ul>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Log retention policies:</strong> How long are logs kept? Can you demonstrate compliance with data retention limits in your DUA/BAA?
                                    <span class="tooltip-content">
                                        <strong>Why this matters:</strong>
                                        <p>HIPAA requires you to retain certain records but also to dispose of PHI when no longer needed. Keeping logs forever = compliance problem.</p>
                                        <strong>Common scenarios:</strong>
                                        <ul>
                                            <li>Logs retained for 1+ year "just in case" but BAA requires deletion after 90 days</li>
                                            <li>No automated deletion - logs accumulate indefinitely</li>
                                            <li>Different retention for different log types (access logs vs error logs)</li>
                                        </ul>
                                        <strong>What to document:</strong>
                                        <ul>
                                            <li>Retention period for each log type</li>
                                            <li>Automated deletion process</li>
                                            <li>Manual review/deletion procedures if needed</li>
                                            <li>Alignment with BAA/DUA requirements</li>
                                        </ul>
                                        <strong>Audit question:</strong>
                                        <p>"Show me your log retention policy and prove it's being enforced." Can you?</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Access controls:</strong> Who has log access? Is it appropriate for their role? Audit trails for log access?
                                    <span class="tooltip-content">
                                        <strong>Minimum necessary principle:</strong>
                                        <p>HIPAA requires limiting access to PHI to only what's needed for someone's job. This applies to logs too.</p>
                                        <strong>Common violations:</strong>
                                        <ul>
                                            <li>All developers have CloudWatch access "for debugging" (but only 2-3 need it)</li>
                                            <li>Junior developers can see production logs with PHI</li>
                                            <li>Customer support can access application logs (should only access audit logs)</li>
                                            <li>No tracking of who views logs when</li>
                                        </ul>
                                        <strong>What to implement:</strong>
                                        <ul>
                                            <li>Role-based access control (RBAC) for log viewing</li>
                                            <li>Audit trail of who accessed what logs when</li>
                                            <li>Justification requirement for log access requests</li>
                                            <li>Regular access reviews (quarterly minimum)</li>
                                        </ul>
                                        <strong>Red flag:</strong>
                                        <p>If you can't list everyone with log access right now, you have a compliance problem.</p>
                                    </span>
                                </span>
                            </li>
                            <li>
                                <span class="tooltip-item"><strong>Log exports:</strong> Can team members export logs with PHI to local machines? CSV files in Downloads folders?
                                    <span class="tooltip-content">
                                        <strong>The nightmare scenario:</strong>
                                        <p>Developer exports logs to CSV for analysis, saves to Downloads folder, laptop gets stolen = breach notification to thousands of patients + regulatory investigation.</p>
                                        <strong>Why this happens:</strong>
                                        <ul>
                                            <li>Log viewer UI has "Export to CSV" button - too easy to click</li>
                                            <li>Developer needs to analyze error patterns, exports 10K log lines</li>
                                            <li>No policy against exporting, no technical controls preventing it</li>
                                            <li>Exported files stored on unencrypted local drives</li>
                                        </ul>
                                        <strong>How to prevent:</strong>
                                        <ul>
                                            <li>Disable export functionality if possible</li>
                                            <li>Require MFA + justification for exports</li>
                                            <li>Auto-expire export downloads after 24 hours</li>
                                            <li>Watermark exports with username/timestamp</li>
                                            <li>Policy: all analysis must happen in production tools (no local exports)</li>
                                        </ul>
                                        <strong>Better alternative:</strong>
                                        <p>Provide analysis tools IN the logging platform (queries, dashboards, alerts) so exports aren't needed.</p>
                                    </span>
                                </span>
                            </li>
                        </ol>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <strong>⚠️ Common Justification That Doesn't Hold Up:</strong> "We need verbose logging to debug production issues" → Solution: Use feature flags to enable verbose logging temporarily for specific requests/users, with automatic expiration. Never leave verbose PHI logging on permanently.
                </div>

                <div class="content-section">
                    <h3>🛡️ Logging Tool Categories & BAA Availability</h3>
                    
                    <div class="scenario-box">
                        <table class="comparison-table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Tool Category</th>
                                    <th style="width: 35%;">Examples</th>
                                    <th style="width: 40%;">BAA Availability</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>CSP Native Logs</strong></td>
                                    <td>CloudWatch (AWS), Cloud Logging (GCP), Azure Monitor</td>
                                    <td>✅ Typically covered by CSP BAA, but verify specific services and configuration requirements</td>
                                </tr>
                                <tr>
                                    <td><strong>APM Platforms</strong></td>
                                    <td>Datadog, New Relic, AppDynamics, Dynatrace</td>
                                    <td>⚠️ Enterprise tier only, with configuration requirements (disable body capture, etc.)</td>
                                </tr>
                                <tr>
                                    <td><strong>Log Aggregation</strong></td>
                                    <td>Splunk, Elasticsearch, Datadog Logs, Sumo Logic</td>
                                    <td>⚠️ Enterprise tier typically, verify on-premises vs cloud deployments</td>
                                </tr>
                                <tr>
                                    <td><strong>Error Tracking</strong></td>
                                    <td>Sentry, Rollbar, Bugsnag, Airbrake</td>
                                    <td>⚠️ Some offer BAAs at enterprise tier, many do NOT</td>
                                </tr>
                                <tr>
                                    <td><strong>Session Replay</strong></td>
                                    <td>LogRocket, FullStory, Hotjar, Heap</td>
                                    <td>❌ Most do NOT offer BAAs or HIPAA compliance - avoid with PHI</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <p style="margin-top: 1rem;"><strong>Golden Rule:</strong> Assume NO BAA coverage unless you've explicitly verified it in writing with your vendor account team and confirmed it covers your specific use case and plan tier.</p>
                    </div>
                </div>

                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-title">Exercise 3.3c: Logging Safety Challenge</div>
                        </div>

                        <div class="question" data-question="14" data-correct="no">
                            <div class="question-text">14. Application log entry: <code>`{"timestamp": "2025-10-19T14:23:15Z", "level": "INFO", "message": "Database query completed", "table": "user_preferences", "duration_ms": 45, "request_id": "req_abc123"}`</code> - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="yes" tabindex="0">Yes - PHI</li>
                                <li class="option" data-answer="no" tabindex="0">No - Safe log</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Request ID (non-identifiable random ID) + user preferences table (no health context) + technical metadata only = Safe. No PII (no email, phone, patient ID) and no health-specific context. This is good production logging practice.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> This log contains only technical metadata with no PII (no email, phone, patient ID) and no health context. Request IDs are random and don't identify individuals. Table name "user_preferences" doesn't imply health data. The correct answer is <strong>No</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="15" data-correct="yes">
                            <div class="question-text">15. APM trace captured by Datadog: <code>`POST /api/prescriptions - User: sarah@healthapp.com - Body: {"medication": "Lisinopril", "dosage": "10mg", "diagnosis": "Hypertension"} - Response: 201 Created`</code> - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="no" tabindex="0">No - Just technical monitoring</li>
                                <li class="option" data-answer="yes" tabindex="0">Yes - PHI</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Email (PII) + medication (Lisinopril = blood pressure drug) + diagnosis (Hypertension) = PHI in APM trace. APM tools with auto-instrumentation often capture this by default. Verify: 1) Does Datadog have BAA configured? 2) Is body capture disabled? 3) Are sensitive fields sanitized?
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> This APM trace combines email (PII) with medication and diagnosis (health data), creating PHI. Even though it's "just monitoring," the trace contains identifiable health information. APM tools often auto-capture this - you must configure sanitization rules. The correct answer is <strong>Yes</strong>.
                            </div>
                        </div>  

                        <div class="question" data-question="16" data-correct="no">
                            <div class="question-text">16. Database slow query log: <code>`[2025-10-19 14:23:15] SLOW QUERY (2.3s): SELECT * FROM appointments WHERE appointment_date > '2025-10-01' AND status = 'completed' LIMIT 100`</code> - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="yes" tabindex="0">Yes - PHI</li>
                                <li class="option" data-answer="no" tabindex="0">No - Safe log</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Query contains no PII (no names, emails, patient IDs in WHERE clause) and references only metadata (dates, status). While querying appointments table, the log itself doesn't expose identifiable patient information. However, ALWAYS review query logs carefully - if this query had `WHERE patient_email = 'john@email.com'` it WOULD be PHI.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> This slow query log contains only table names and non-identifying query conditions (dates, status). No PII is exposed. However, be vigilant - many query logs DO expose PHI when they include patient emails, IDs, or names in WHERE clauses or INSERT values. The correct answer is <strong>No</strong>.
                            </div>
                        </div>
                    </div>

                    <div class="subsection-nav">
                        <button class="btn btn-secondary subsection-nav-btn" onclick="prevSubsection()">
                            ← Previous: Database & API
                        </button>
                        <div style="color: #6c757d; font-weight: bold;">Section 3 of 6</div>
                        <button class="btn btn-primary subsection-nav-btn" onclick="nextSubsection()">
                            Next: Inference Problem →
                        </button>
                    </div>
                </div>

                <!-- Subsection: Inference -->
                <div class="module-subsection" id="subsection-inference">
                    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
                        <strong style="color: #2980b9;">🔍 Current Section: 4. The Inference Problem</strong>
                    </div>
                    <div class="content-section">
                        <h3>The Inference Problem: When Behavior Reveals Health Conditions</h3>
                        <p><strong>Critical insight for builders:</strong> Even when you never explicitly store diagnosis codes or medical conditions, user behavior patterns can reveal health information. This creates "inferential PHI" - and you're still liable under HIPAA.</p>
                    </div>

                    <div class="alert alert-danger">
                        <strong>🚨 Wake-Up Call:</strong> "We only track anonymous usage metrics" is NOT a defense if those metrics can be correlated back to individuals and reveal health conditions. Product analytics, A/B testing, personalization engines, and recommendation systems all create this risk.
                    </div>

                    <div class="content-section">
                        <h3>🔍 How Inference Creates PHI</h3>
                        
                        <div class="scenario-box">
                            <h4>Pattern 1: Content Access Patterns</h4>
                            <p><strong>The Setup:</strong> Health app with educational content about various conditions</p>
                            
                            <div class="code-example"><span class="comment">// Analytics event tracking</span>
                    {
                    <span class="string">"event"</span>: <span class="string">"content_viewed"</span>,
                    <span class="string">"userId"</span>: <span class="string">"user_12345"</span>,              <span class="comment">// Internal ID (not directly PII)</span>
                    <span class="string">"email"</span>: <span class="string">"sarah@email.com"</span>,       <span class="comment">// ⚠️ PII</span>
                    <span class="string">"contentId"</span>: <span class="string">"depression-coping-strategies"</span>,
                    <span class="string">"timeSpent"</span>: 420,                  <span class="comment">// 7 minutes</span>
                    <span class="string">"returnVisits"</span>: 8                  <span class="comment">// Visited this topic 8 times</span>
                    }
                    <span class="comment">// ⚠️ Email + repeated depression content = inferential PHI</span>
                    <span class="comment">// Implies mental health condition</span></div>
                            
                            <p style="margin-top: 1rem;"><strong>Why This is PHI:</strong></p>
                            <ul>
                                <li>Email address identifies the individual (PII)</li>
                                <li>Repeated access to depression resources implies mental health condition</li>
                                <li>Time spent + return visits strengthens the inference</li>
                                <li>Analytics platform (Google Analytics, Mixpanel, Amplitude, etc.) now contains PHI</li>
                                <li>Does your analytics tool have a BAA? Probably not.</li>
                            </ul>
                        </div>

                        <div class="scenario-box">
                            <h4>Pattern 2: Feature Usage Patterns</h4>
                            <p><strong>The Setup:</strong> Wellness app with various health tracking features</p>
                            
                            <div class="code-example"><span class="comment">// Product analytics - feature usage dashboard</span>
                    SELECT 
                        u.email,
                        COUNT(bg.reading_id) as blood_glucose_checks,
                        AVG(bg.reading_value) as avg_glucose,
                        COUNT(DISTINCT DATE(bg.timestamp)) as days_tracked
                    FROM users u
                    JOIN blood_glucose_readings bg ON u.user_id = bg.user_id
                    WHERE bg.timestamp > NOW() - INTERVAL '30 days'
                    GROUP BY u.email
                    HAVING COUNT(bg.reading_id) > 60  <span class="comment">// 60+ readings in 30 days = 2x/day</span>

                    <span class="comment">// ⚠️ Result: email + blood glucose tracking frequency = inferential PHI</span>
                    <span class="comment">// Implies diabetes diagnosis</span></div>
                            
                            <p style="margin-top: 1rem;"><strong>The Inference Chain:</strong></p>
                            <ul>
                                <li>Users who track blood glucose 2x/day likely have diabetes</li>
                                <li>Email identifies the individual</li>
                                <li>Usage pattern implies diagnosis → inferential PHI created</li>
                                <li>Product analytics dashboard, data warehouse, BI tools all contain PHI</li>
                            </ul>
                        </div>

                        <div class="scenario-box">
                            <h4>Pattern 3: Time-Series Behavior Analysis</h4>
                            <p><strong>The Setup:</strong> Mental health app with mood tracking and therapy scheduling</p>
                            
                            <div class="code-example"><span class="comment">// User engagement analysis for retention efforts</span>
                    {
                    <span class="string">"userId"</span>: <span class="string">"USR_98765"</span>,
                    <span class="string">"phone"</span>: <span class="string">"+1-555-0199"</span>,           <span class="comment">// ⚠️ PII</span>
                    <span class="string">"behaviorPattern"</span>: {
                        <span class="string">"loginTimes"</span>: [<span class="string">"08:00"</span>, <span class="string">"13:00"</span>, <span class="string">"18:00"</span>, <span class="string">"23:00"</span>],
                        <span class="string">"avgSessionDuration"</span>: 15,      <span class="comment">// minutes</span>
                        <span class="string">"moodLogFrequency"</span>: <span class="string">"4x daily"</span>,
                        <span class="string">"crisisHotlineAccessed"</span>: 3,
                        <span class="string">"therapistMessagesSent"</span>: 12
                    }
                    }
                    <span class="comment">// ⚠️ Phone + crisis hotline access + high mood logging = inferential PHI</span>
                    <span class="comment">// Strongly implies mental health crisis or severe depression</span></div>
                            
                            <p style="margin-top: 1rem;"><strong>Critical Reality:</strong></p>
                            <ul>
                                <li>Behavioral patterns can be MORE revealing than explicit diagnosis codes</li>
                                <li>4x daily mood logging + crisis hotline access = clear mental health indicator</li>
                                <li>Phone number identifies individual + behavioral pattern = PHI</li>
                                <li>This data in product analytics, retention analysis, or ML training = PHI exposure</li>
                            </ul>
                        </div>

                        <div class="scenario-box">
                            <h4>Pattern 4: Personalization & Recommendation Engines</h4>
                            <p><strong>The Setup:</strong> Health content platform with ML-powered recommendations</p>
                            
                            <div class="code-example"><span class="comment">// ML model training data for content recommendations</span>
                    training_data = [
                    {
                        <span class="string">"user_email"</span>: <span class="string">"john@company.com"</span>,       <span class="comment">// ⚠️ PII</span>
                        <span class="string">"viewed_articles"</span>: [
                        <span class="string">"managing-type-2-diabetes"</span>,
                        <span class="string">"insulin-injection-techniques"</span>,
                        <span class="string">"low-carb-diet-plans"</span>,
                        <span class="string">"blood-sugar-monitoring-tips"</span>
                        ],
                        <span class="string">"engagement_score"</span>: 0.89,
                        <span class="string">"recommended_next"</span>: <span class="string">"diabetes-medication-guide"</span>
                    }
                    ]
                    <span class="comment">// ⚠️ Email + diabetes content cluster = inferential PHI</span>
                    <span class="comment">// ML model itself now "knows" user's condition</span></div>
                            
                            <p style="margin-top: 1rem;"><strong>ML/AI Specific Risks:</strong></p>
                            <ul>
                                <li>Training data with email/user_id + health content = PHI in ML pipeline</li>
                                <li>Model inference logs contain identifiable data + predicted conditions</li>
                                <li>Recommendation engine databases store user-condition correlations</li>
                                <li>A/B testing frameworks expose PHI to analytics platforms</li>
                                <li>Do your ML platforms (SageMaker, Vertex AI, Azure ML) have BAAs configured?</li>
                            </ul>
                        </div>

                        <div class="scenario-box">
                            <h4>Pattern 5: A/B Testing & Experimentation Platforms</h4>
                            <p><strong>The Setup:</strong> Testing new UI for medication reminders</p>
                            
                            <div class="code-example"><span class="comment">// Optimizely / LaunchDarkly / Split.io event data</span>
                    {
                    <span class="string">"experiment"</span>: <span class="string">"medication_reminder_redesign"</span>,
                    <span class="string">"userId"</span>: <span class="string">"user_54321"</span>,
                    <span class="string">"userEmail"</span>: <span class="string">"lisa@email.com"</span>,      <span class="comment">// ⚠️ PII</span>
                    <span class="string">"variant"</span>: <span class="string">"treatment_b"</span>,
                    <span class="string">"metadata"</span>: {
                        <span class="string">"medicationCategory"</span>: <span class="string">"insulin"</span>,   <span class="comment">// ⚠️ Health data</span>
                        <span class="string">"reminderFrequency"</span>: <span class="string">"2x_daily"</span>
                    },
                    <span class="string">"conversionEvent"</span>: <span class="string">"reminder_acknowledged"</span>
                    }
                    <span class="comment">// ⚠️ Email + insulin reminders = inferential PHI in A/B test platform</span></div>
                            
                            <p style="margin-top: 1rem;"><strong>Experimentation Risks:</strong></p>
                            <ul>
                                <li>A/B testing platforms (Optimizely, LaunchDarkly, etc.) typically DON'T have BAAs</li>
                                <li>Experiment metadata often includes health context</li>
                                <li>User segmentation by condition creates PHI</li>
                                <li>Conversion funnels reveal condition-specific behaviors</li>
                            </ul>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3>🛠️ Safe vs Unsafe Inference Patterns</h3>
                        
                        <div class="scenario-box">
                            <h4>❌ UNSAFE: Individual-Level Tracking with Identifiers</h4>
                            <div class="code-example"><span class="comment">// Dangerous analytics implementation</span>
                    analytics.track(<span class="string">"Feature Used"</span>, {
                    userId: currentUser.id,
                    email: currentUser.email,              <span class="comment">// ⚠️ PII</span>
                    feature: <span class="string">"blood_glucose_tracker"</span>,  <span class="comment">// ⚠️ Health context</span>
                    frequency: <span class="string">"daily"</span>,
                    duration: 30                           <span class="comment">// days of use</span>
                    });

                    <span class="comment">// ⚠️ Creates inferential PHI: email + BG tracking = diabetes inference</span></div>
                        </div>

                        <div class="scenario-box">
                            <h4>✅ SAFER: Aggregated Analytics Without Identifiers</h4>
                            <div class="code-example"><span class="comment">// Safer: Aggregate first, no individual tracking</span>
                    <span class="comment">// Server-side aggregation BEFORE sending to analytics</span>
                    <span class="keyword">const</span> aggregatedMetrics = {
                    feature: <span class="string">"health_tracking"</span>,           <span class="comment">// Generic category</span>
                    activeUsers: 1247,                     <span class="comment">// Count, not individuals</span>
                    avgSessionDuration: 8.5,               <span class="comment">// Minutes - aggregate</span>
                    totalSessions: 15832,
                    dateRange: <span class="string">"2025-10"</span>                  <span class="comment">// Month only</span>
                    };

                    analytics.track(<span class="string">"Feature Usage Summary"</span>, aggregatedMetrics);
                    <span class="comment">// ✅ No individual identifiers, aggregated data = no PHI</span></div>
                        </div>

                        <div class="scenario-box">
                            <h4>✅ BEST: Hashed Identifiers + Feature Anonymization</h4>
                            <div class="code-example"><span class="comment">// Best practice: Hash user ID, generalize features</span>
                    <span class="keyword">const</span> safeUserId = sha256(currentUser.id + SECRET_SALT);

                    analytics.track(<span class="string">"Feature Used"</span>, {
                    userHash: safeUserId.substring(0, 16),  <span class="comment">// Truncated hash - consistent but not reversible</span>
                    featureCategory: <span class="string">"health_monitoring"</span>,  <span class="comment">// Generic, not "blood_glucose"</span>
                    engagementLevel: <span class="string">"high"</span>,               <span class="comment">// Not specific frequency</span>
                    cohortMonth: <span class="string">"2025-10"</span>                 <span class="comment">// Temporal grouping only</span>
                    });

                    <span class="comment">// ✅ Useful for product analytics, but can't identify individuals or infer conditions</span></div>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3>🎯 Builder's Checklist: Preventing Inferential PHI</h3>
                        
                        <div class="scenario-box">
                            <h4>Before Implementing Analytics, A/B Tests, or ML Features:</h4>
                            <ol style="padding-left: 1.5rem; line-height: 2.2;">
                                <li>
                                    <span class="tooltip-item"><strong>Identify PII in your data:</strong> What fields identify individuals? (email, phone, user_id that maps to PII?)
                                        <span class="tooltip-content">
                                            <strong>Why this matters:</strong>
                                            <p>If you don't know what's PII, you can't protect it. Many developers think "user_id=12345" is anonymous, but if it maps to an email/name in another table, it's PII.</p>
                                            <strong>What counts as PII:</strong>
                                            <ul>
                                                <li>Direct identifiers: email, phone, SSN, name, address</li>
                                                <li>Indirect identifiers: user_id that can be joined to identity tables</li>
                                                <li>Device IDs if they're persistent and tied to individuals</li>
                                                <li>IP addresses if combined with other data</li>
                                            </ul>
                                            <strong>Common mistake:</strong>
                                            <p>"We use hashed user IDs in analytics, so it's anonymous!" → But if marketing can join that hash back to the CRM, it's NOT anonymous.</p>
                                            <strong>Action:</strong>
                                            <p>Map all data flows: Can any analytics ID be traced back to a real person? If yes = PII.</p>
                                        </span>
                                    </span>
                                </li>
                                <li>
                                    <span class="tooltip-item"><strong>Identify health context:</strong> What behaviors or content imply health conditions?
                                        <span class="tooltip-content">
                                            <strong>The inference problem:</strong>
                                            <p>You don't need to store "diabetes" to reveal someone has diabetes. Behavioral patterns can imply health conditions just as clearly.</p>
                                            <strong>Examples of health context:</strong>
                                            <ul>
                                                <li>Page views: "glucose-monitoring.html", "cardiac-rehab-programs"</li>
                                                <li>Search terms: "insulin dosage", "chemotherapy side effects"</li>
                                                <li>Feature usage: "Track Blood Pressure" button clicks</li>
                                                <li>Content interactions: Viewing cancer treatment videos</li>
                                                <li>Time patterns: Regular 8am medication reminders</li>
                                            </ul>
                                            <strong>Real example:</strong>
                                            <p>A fitness app tracked "users who viewed diabetes content" → that's identifying people with potential diabetes. That's health context.</p>
                                            <strong>Key principle:</strong>
                                            <p>If knowing someone did X would reveal something about their health condition, X is health context.</p>
                                        </span>
                                    </span>
                                </li>
                                <li>
                                    <span class="tooltip-item"><strong>Map the correlation:</strong> Can PII be correlated with health behaviors? If yes → inferential PHI risk
                                        <span class="tooltip-content">
                                            <strong>The PHI creation formula:</strong>
                                            <p>PII + Health Context (even behavioral) = PHI. This is true even if they're in separate systems/tables.</p>
                                            <strong>How correlation happens:</strong>
                                            <ul>
                                                <li>Analytics dashboard showing "sarah@example.com viewed insulin content 15 times"</li>
                                                <li>A/B test segments: "Users with diabetes" (even if you don't store diagnosis, you've identified them)</li>
                                                <li>ML recommendations: "Because you have diabetes..." (reveals condition)</li>
                                                <li>Cohort analysis: "Users who clicked 'Schedule Oncology Appointment'" → identifiable group</li>
                                            </ul>
                                            <strong>The audit test:</strong>
                                            <p>Ask: "Could someone with access to our analytics determine who has what health condition?" If yes → you're creating PHI.</p>
                                            <strong>Common defense that fails:</strong>
                                            <p>"The data is in different systems!" → Doesn't matter. If someone with access can correlate it, it's PHI.</p>
                                        </span>
                                    </span>
                                </li>
                                <li>
                                    <span class="tooltip-item"><strong>Choose safe patterns:</strong>
                                        <span class="tooltip-content">
                                            <strong>Three approaches to avoid PHI creation:</strong>
                                            <p><strong>Option A: Aggregate only</strong> - Track cohorts, never individuals. "500 users viewed diabetes content" but never "user X viewed Y".</p>
                                            <p><strong>Option B: Hash + generalize</strong> - Use irreversible hashes for IDs, generalize health features ("wellness" not "diabetes"), make re-identification impossible.</p>
                                            <p><strong>Option C: Separate pipelines</strong> - Run contact analysis (who are our users?) completely separately from behavior analysis (what features are popular?). Never join them.</p>
                                            <strong>How to choose:</strong>
                                            <ul>
                                                <li>Option A: Best for feature adoption, funnel analysis, trend tracking</li>
                                                <li>Option B: When you need some individual tracking but can't create PHI</li>
                                                <li>Option C: When you need both PII (marketing) and health behavior (product) but must keep separate</li>
                                            </ul>
                                            <strong>All three require:</strong>
                                            <p>Technical controls that make correlation impossible, not just policy. "We promise not to join the data" is not enough.</p>
                                        </span>
                                    </span>
                                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                        <li>Option A: Aggregate data, no individual tracking</li>
                                        <li>Option B: Hash identifiers, generalize features</li>
                                        <li>Option C: Separate pipelines - PII analysis separate from health behavior analysis</li>
                                    </ul>
                                </li>
                                <li>
                                    <span class="tooltip-item"><strong>Verify BAA coverage:</strong> Does your analytics platform have a BAA if you're tracking individual-level health-related behavior?
                                        <span class="tooltip-content">
                                            <strong>Why this matters:</strong>
                                            <p>If your analytics contain PHI (even inferential PHI), the analytics vendor is handling PHI and MUST have a BAA. Most don't offer BAAs at standard tiers.</p>
                                            <strong>Common platforms & BAA status:</strong>
                                            <ul>
                                                <li><strong>Google Analytics:</strong> Standard/Free version = NO BAA. GA360 (enterprise) = BAA available but must be configured carefully</li>
                                                <li><strong>Mixpanel:</strong> Enterprise tier only, must request BAA</li>
                                                <li><strong>Amplitude:</strong> Enterprise tier, BAA available</li>
                                                <li><strong>Segment:</strong> Business tier and above, BAA available</li>
                                                <li><strong>Heap:</strong> Growth plan and above, BAA available</li>
                                            </ul>
                                            <strong>The gotcha:</strong>
                                            <p>Even WITH a BAA, you must configure the tool correctly. Google Analytics with BAA still needs IP anonymization, user-ID scrubbing, and other protections enabled.</p>
                                            <strong>Red flag:</strong>
                                            <p>If you're using free/starter tier of ANY analytics tool and tracking health behaviors, you're likely in violation.</p>
                                        </span>
                                    </span>
                                </li>
                                <li>
                                    <span class="tooltip-item"><strong>Review ML pipelines:</strong> Training data, model inference logs, recommendation engines - all need scrutiny
                                        <span class="tooltip-content">
                                            <strong>ML creates special PHI risks:</strong>
                                            <p>Machine learning systems process large amounts of data, make inferences about individuals, and create new derived data. Each stage is a PHI exposure point.</p>
                                            <strong>Where PHI appears in ML:</strong>
                                            <ul>
                                                <li><strong>Training data:</strong> "Users with diabetes" labeled dataset for recommendation model</li>
                                                <li><strong>Feature engineering:</strong> Creating "health_score" feature from behaviors</li>
                                                <li><strong>Model inference logs:</strong> "User 12345: predicted condition = diabetes (94% confidence)"</li>
                                                <li><strong>Recommendation outputs:</strong> "Because you have anxiety, try meditation app"</li>
                                                <li><strong>A/B test variants:</strong> "Show diabetes content to diabetic cohort"</li>
                                            </ul>
                                            <strong>Questions to ask:</strong>
                                            <ul>
                                                <li>Can training data be traced to individuals?</li>
                                                <li>Do model predictions reveal health conditions?</li>
                                                <li>Are inference logs storing PHI?</li>
                                                <li>Do recommendation reasons expose conditions?</li>
                                                <li>Where is ML pipeline data stored? BAA coverage?</li>
                                            </ul>
                                            <strong>Common violation:</strong>
                                            <p>Storing ML training data in S3 bucket without proper access controls or BAA coverage, labeled with "patient_id" + "diagnosis".</p>
                                        </span>
                                    </span>
                                </li>
                                <li>
                                    <span class="tooltip-item"><strong>Audit third-party tools:</strong> Google Analytics, Mixpanel, Amplitude, Segment, A/B testing platforms - what data are you sending them?
                                        <span class="tooltip-content">
                                            <strong>The data leakage problem:</strong>
                                            <p>Most analytics tools are installed with a single script tag and immediately start sending everything to third-party servers. What's being sent?</p>
                                            <strong>Automatic data collection includes:</strong>
                                            <ul>
                                                <li>Page URLs (may contain health context: "/diabetes-resources")</li>
                                                <li>Page titles (may reveal conditions: "Managing Your Cancer Treatment")</li>
                                                <li>User IDs (if you're passing them)</li>
                                                <li>Custom events you track (button clicks, form submissions)</li>
                                                <li>UTM parameters from marketing campaigns</li>
                                                <li>Referrer URLs (where users came from)</li>
                                            </ul>
                                            <strong>How to audit:</strong>
                                            <ol>
                                                <li>Open browser DevTools → Network tab</li>
                                                <li>Navigate through your app as a user would</li>
                                                <li>Filter for analytics domains (google-analytics.com, mixpanel.com, etc.)</li>
                                                <li>Examine EVERY request - what's in the payload?</li>
                                                <li>Look for PII (emails, IDs) + health context (page titles, events)</li>
                                            </ol>
                                            <strong>Real example:</strong>
                                            <p>Company discovered they were sending <code>{page: "/patient/12345/diabetes-treatment-plan", userId: "abc@email.com"}</code> to Mixpanel. Full PHI exposure to third party without BAA.</p>
                                        </span>
                                    </span>
                                </li>
                                <li>
                                    <span class="tooltip-item"><strong>Document decisions:</strong> If challenged in audit, can you explain why your analytics don't create PHI?
                                        <span class="tooltip-content">
                                            <strong>The audit moment:</strong>
                                            <p>Auditor: "Show me evidence that your analytics don't contain PHI." Can you produce documentation right now?</p>
                                            <strong>What to document:</strong>
                                            <ul>
                                                <li><strong>Data classification:</strong> What data goes into analytics? Which fields are PII? Which are health context?</li>
                                                <li><strong>Risk assessment:</strong> Can PII be correlated with health data? If yes, how is this mitigated?</li>
                                                <li><strong>Technical controls:</strong> Hashing? Aggregation? Separate pipelines? How implemented?</li>
                                                <li><strong>BAA coverage:</strong> Which vendors have BAAs? Proof of signed agreements?</li>
                                                <li><strong>Testing evidence:</strong> Audit logs showing data sent to third parties doesn't contain PHI</li>
                                                <li><strong>Change management:</strong> Process for reviewing new analytics before implementation</li>
                                            </ul>
                                            <strong>Red flag in audits:</strong>
                                            <p>"We don't think it's PHI" without evidence. "Our developers are careful" without documentation. "We've never had a problem" without testing.</p>
                                            <strong>Good answer:</strong>
                                            <p>"Here's our data flow diagram showing PII is hashed before analytics. Here's our BAA with Mixpanel. Here's our quarterly audit showing no PHI in analytics payloads."</p>
                                            <strong>Why this matters:</strong>
                                            <p>Fines and breach notifications aside, you need to prove to auditors you've thought this through. Documentation is evidence of due diligence.</p>
                                        </span>
                                    </span>
                                </li>
                            </ol>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <strong>⚠️ Special Warning for Product & Analytics Teams:</strong> "Anonymous user IDs" are NOT anonymous if they can be joined back to PII tables. "We don't store diagnoses" is NOT a defense if user behavior reveals conditions. Inference = PHI exposure, period.
                    </div>

                    <div class="content-section">
                        <h3>📊 Real-World Example: Safe Product Analytics</h3>
                        
                        <div class="scenario-box">
                            <h4>Goal: Understand feature adoption without creating PHI</h4>
                            
                            <p><strong>❌ Unsafe Approach:</strong></p>
                            <div class="code-example"><span class="comment">// Tracks individuals with health context</span>
                    SELECT email, feature_name, usage_count
                    FROM user_events
                    WHERE feature_name LIKE <span class="string">'%health%'</span>
                    <span class="comment">// ⚠️ Email + health feature usage = inferential PHI</span></div>
                            
                            <p style="margin-top: 1.5rem;"><strong>✅ Safe Approach:</strong></p>
                            <div class="code-example"><span class="comment">// Aggregate by cohorts, no individual tracking</span>
                    SELECT 
                        feature_category,                    <span class="comment">// "monitoring" not "glucose"</span>
                        user_cohort,                         <span class="comment">// "2025-Q3 signups"</span>
                        COUNT(DISTINCT user_hash) as users,  <span class="comment">// Hashed IDs</span>
                        AVG(usage_count) as avg_usage,
                        PERCENTILE(usage_count, 0.5) as median
                    FROM anonymized_events
                    WHERE feature_category = <span class="string">'health_tracking'</span>
                    GROUP BY feature_category, user_cohort
                    HAVING COUNT(DISTINCT user_hash) >= 20   <span class="comment">// k-anonymity threshold</span>
                    <span class="comment">// ✅ Useful metrics, but no individual identification or condition inference</span></div>
                        </div>
                    </div>

                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-title">Exercise 3.4d: Inference Challenge</div>
                        </div>

                <div class="question" data-question="17" data-correct="no">
                    <div class="question-text">17. Product analytics dashboard shows: "Health Tracking feature accessed 1,247 times by 89 unique users this month" - PHI?</div>
                    <ul class="options">
                        <li class="option" data-answer="yes" tabindex="0">Yes - Inferential PHI</li>
                        <li class="option" data-answer="no" tabindex="0">No - Safe aggregated</li>
                    </ul>
                    <div class="feedback correct">
                        <strong>Correct!</strong> Properly aggregated data with no individual identifiers = Safe. The metric shows feature usage at a population level (89 users) without revealing which individuals used it or what specific conditions they might have. This is the gold standard for product analytics in healthcare.
                    </div>
                    <div class="feedback incorrect">
                        <strong>Incorrect.</strong> Aggregated data with no individual identification = safe, not inferential PHI. The key is that you can't identify which 89 specific users accessed the feature. If the data showed "sarah@email.com accessed diabetes tracking 15 times," THAT would be inferential PHI. The correct answer is <strong>No</strong>.
                    </div>
                </div>

                    <div class="question" data-question="18" data-correct="yes">
                        <div class="question-text">18. Analytics event: `{"email": "tom@email.com", "event": "viewed_content", "article": "managing-depression-symptoms", "viewCount": 8, "timeSpentMinutes": 47}` - PHI?</div>
                        <ul class="options">
                            <li class="option" data-answer="no" tabindex="0">No - Just content analytics</li>
                            <li class="option" data-answer="yes" tabindex="0">Yes - Inferential PHI</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Email (PII) + repeated depression content engagement (8 views, 47 minutes) = inferential PHI. The behavioral pattern implies mental health condition. This data in Google Analytics, Mixpanel, Amplitude, or any analytics platform without a BAA creates PHI exposure.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Email + depression content engagement pattern = inferential PHI because it implies a mental health condition. Even though no diagnosis code is stored, the repeated behavior (8 views, 47 minutes) creates a strong inference. The correct answer is <strong>Yes</strong>.
                        </div>
                    </div>

                                                <div class="question" data-question="19" data-correct="yes">
                            <div class="question-text">19. ML training data: `{"userId": "A12B3", "phone": "+1-555-0123", "features_used": ["blood_glucose_log", "insulin_tracker", "carb_counter"], "usage_frequency": "multiple_daily", "days_active": 87}` - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="no" tabindex="0">No - Just usage patterns</li>
                                <li class="option" data-answer="yes" tabindex="0">Yes - Inferential PHI</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Phone number (PII) + blood glucose/insulin tracking pattern = inferential PHI (implies diabetes diagnosis). ML training data, model inference logs, and recommendation engines all contain PHI if they include identifiable information + health behavior patterns. Verify your ML platform (SageMaker, Vertex AI, Azure ML) has proper BAA coverage.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Phone + regular blood glucose/insulin tracking = inferential PHI because it strongly implies diabetes. Multiple daily use of these specific features over 87 days creates a clear health condition inference. The correct answer is <strong>Yes</strong>.
                            </div>
                        </div>
                    </div>

                    <div class="subsection-nav">
                        <button class="btn btn-secondary subsection-nav-btn" onclick="prevSubsection()">
                            ← Previous: Logging & Analytics
                        </button>
                        <div style="color: #6c757d; font-weight: bold;">Section 4 of 6</div>
                        <button class="btn btn-primary subsection-nav-btn" onclick="nextSubsection()">
                            Next: Multi-System Flows →
                        </button>
                    </div>
                </div>

                <!-- Subsection: Multi-System -->
                <div class="module-subsection" id="subsection-systems">
                    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
                        <strong style="color: #2980b9;">🔍 Current Section: 5. Multi-System Data Flows</strong>
                    </div>
                    <div class="content-section">
    <h3>Multi-System Data Flows: Where PHI Emerges at Integration Points</h3>
    <p><strong>Reality for builders:</strong> Modern healthcare applications rarely exist in isolation. You're constantly integrating CRMs, EHRs (Electronic Health Records), billing systems, scheduling tools, analytics platforms, and patient portals. PHI often emerges at these integration boundaries where "safe" data from different systems combines.</p>
</div>

<div class="content-section">
    <h3>🔗 Common Integration Patterns That Create PHI</h3>
    
    <div class="scenario-box">
        <h4>Pattern 1: CRM + EHR/Practice Management System</h4>
        <p><strong>The Setup:</strong></p>
        <ul>
            <li><strong>CRM (Salesforce, HubSpot, custom):</strong> Stores contact info - names, emails, phone numbers, addresses</li>
            <li><strong>EHR/Practice Management (Epic, Cerner, Athena, NextGen):</strong> Stores appointments, diagnoses, procedures, medications</li>
        </ul>
        
        <p style="margin-top: 1rem;"><strong>❌ Where PHI Gets Created:</strong></p>
        <div class="code-example"><span class="comment">// API endpoint that joins CRM + EHR data</span>
GET /api/patients/{id}/complete-profile

Response:
{
  <span class="string">"name"</span>: <span class="string">"Sarah Johnson"</span>,          <span class="comment">// From CRM</span>
  <span class="string">"email"</span>: <span class="string">"sarah.j@email.com"</span>,    <span class="comment">// From CRM</span>
  <span class="string">"phone"</span>: <span class="string">"555-0123"</span>,             <span class="comment">// From CRM</span>
  <span class="string">"lastAppointment"</span>: <span class="string">"Cardiology"</span>, <span class="comment">// From EHR - ⚠️ PHI!</span>
  <span class="string">"nextVisit"</span>: <span class="string">"2025-11-15"</span>        <span class="comment">// From EHR - ⚠️ PHI!</span>
}</div>
        
        <p style="margin-top: 1rem;"><strong>🎯 Why This Matters:</strong></p>
        <ul>
            <li>CRM data alone = PII (identifiable but no health context)</li>
            <li>EHR appointment type alone = just healthcare info (not identifiable)</li>
            <li>Combined in one response = PHI (PII + health context)</li>
            <li>Your API logs, frontend state, analytics tracking all now contain PHI</li>
        </ul>
    </div>

    <div class="scenario-box">
        <h4>Pattern 2: Billing System + Patient Portal</h4>
        <p><strong>The Setup:</strong></p>
        <ul>
            <li><strong>Billing system:</strong> Stores charges, insurance claims, procedure codes (CPT codes)</li>
            <li><strong>Patient portal:</strong> Displays bills and payment history to patients</li>
        </ul>
        
        <p style="margin-top: 1rem;"><strong>❌ Where PHI Gets Created:</strong></p>
        <div class="code-example"><span class="comment">// Email notification triggered by billing system</span>
To: john.smith@email.com
Subject: Your Recent Bill

Dear John,

Your recent visit for <span class="string">"99213 - Office Visit, Moderate Complexity"</span>
resulted in a balance of $250.

Procedure: <span class="string">"Diabetes Management - Follow-up"</span>
Date of Service: 10/15/2025

<span class="comment">// ⚠️ Email + procedure code + diagnosis = PHI in email system</span></div>
        
        <p style="margin-top: 1rem;"><strong>🎯 Critical for Builders:</strong></p>
        <ul>
            <li>Procedure codes (CPT codes like 99213) often reveal diagnoses</li>
            <li>Email system (Gmail, Outlook, SendGrid, etc.) now contains PHI</li>
            <li>Does your email service provider have a BAA? Is the email encrypted?</li>
            <li>Are email logs and delivery tracking tools covered by BAAs?</li>
        </ul>
    </div>

    <div class="scenario-box">
        <h4>Pattern 3: Analytics Platform + Operational Data</h4>
        <p><strong>The Setup:</strong></p>
        <ul>
            <li><strong>Operational databases:</strong> User accounts, session data, application logs</li>
            <li><strong>Analytics/BI tools (Tableau, Looker, Power BI, custom dashboards):</strong> Aggregate data for business insights</li>
        </ul>
        
        <p style="margin-top: 1rem;"><strong>❌ Where PHI Gets Created:</strong></p>
        <div class="code-example"><span class="comment">// ETL pipeline aggregating user behavior</span>
SELECT 
    u.email,
    u.user_id,
    COUNT(a.appointment_id) as total_appointments,
    MAX(a.appointment_type) as last_appointment_type,
    AVG(a.wait_time_minutes) as avg_wait
FROM users u
JOIN appointments a ON u.user_id = a.user_id
GROUP BY u.email, u.user_id

<span class="comment">// ⚠️ Result set contains: email + appointment types = PHI</span>
<span class="comment">// Now your analytics warehouse, dashboards, and BI tools contain PHI</span></div>
        
        <p style="margin-top: 1rem;"><strong>🎯 Builder Checklist:</strong></p>
        <ul>
            <li>Does your analytics platform (Tableau/Looker/Power BI) have a BAA?</li>
            <li>Is your data warehouse (Snowflake/BigQuery/Redshift) configured with proper BAA coverage?</li>
            <li>Are you de-identifying data BEFORE it enters the analytics pipeline?</li>
            <li>Hash user IDs, remove emails, aggregate appointment types to categories</li>
        </ul>
    </div>

    <div class="scenario-box">
        <h4>Pattern 4: Third-Party Integrations (Payment, Scheduling, SMS)</h4>
        <p><strong>The Setup:</strong></p>
        <ul>
            <li><strong>Payment processors (Stripe, Square, PayPal):</strong> Handle credit card transactions</li>
            <li><strong>Scheduling tools (Calendly, Acuity, custom):</strong> Book appointments</li>
            <li><strong>SMS/notification services (Twilio, SendGrid):</strong> Send appointment reminders</li>
        </ul>
        
        <p style="margin-top: 1rem;"><strong>❌ Where PHI Gets Created:</strong></p>
        <div class="code-example"><span class="comment">// SMS reminder via Twilio API</span>
POST /api/sms/send
{
  <span class="string">"to"</span>: <span class="string">"+1-555-0123"</span>,              <span class="comment">// PII - phone number</span>
  <span class="string">"message"</span>: <span class="string">"Hi Sarah, reminder: Your cardiology appointment is tomorrow at 2pm"</span>
                                   <span class="comment">// ⚠️ Phone + cardiology = PHI</span>
}

<span class="comment">// Payment processor metadata</span>
{
  <span class="string">"customer_email"</span>: <span class="string">"sarah@email.com"</span>,
  <span class="string">"description"</span>: <span class="string">"Office visit - diabetes follow-up"</span>
                                           <span class="comment">// ⚠️ Email + diagnosis = PHI</span>
}</div>
        
        <p style="margin-top: 1rem;"><strong>🎯 Critical Questions:</strong></p>
        <ul>
            <li>Does Twilio/SendGrid have a BAA for SMS? (They offer it, but you must explicitly enable it)</li>
            <li>Does Stripe have a BAA? (They don't typically need one for payments, but if you put diagnosis info in transaction descriptions, you've created PHI)</li>
            <li>Are you sending PHI to services without BAAs? Even in metadata or transaction descriptions?</li>
        </ul>
    </div>
</div>

<div class="content-section">
    <h3>🛠️ Architectural Patterns: Safe vs Unsafe Integration</h3>
    
    <div class="scenario-box">
        <h4>❌ UNSAFE Pattern: Direct Data Joining at API Layer</h4>
        <div class="code-example"><span class="comment">// Dangerous: Single API endpoint combines everything</span>
<span class="keyword">app.get</span>(<span class="string">'/api/patient-dashboard/:id'</span>, <span class="keyword">async</span> (req, res) => {
  <span class="keyword">const</span> crmData = <span class="keyword">await</span> CRM.getContact(req.params.id);
  <span class="keyword">const</span> ehrData = <span class="keyword">await</span> EHR.getAppointments(req.params.id);
  
  <span class="comment">// ⚠️ Creating PHI by combining PII + health data</span>
  res.json({
    name: crmData.name,           <span class="comment">// PII</span>
    email: crmData.email,         <span class="comment">// PII</span>
    appointments: ehrData.visits  <span class="comment">// Health data → Combined = PHI!</span>
  });
});</div>
        
        <p style="margin-top: 1rem;"><strong>Problems:</strong></p>
        <ul>
            <li>API logs contain PHI</li>
            <li>Frontend state management contains PHI</li>
            <li>Browser dev tools, error tracking (Sentry/Bugsnag), APM tools all capture PHI</li>
            <li>Any caching layer (Redis, CDN) now contains PHI</li>
        </ul>
    </div>

    <div class="scenario-box">
        <h4>✅ SAFER Pattern: Separation with Client-Side Joining</h4>
        <div class="code-example"><span class="comment">// Safer: Keep data separate, let client join if needed</span>
<span class="keyword">app.get</span>(<span class="string">'/api/contacts/:id'</span>, <span class="keyword">async</span> (req, res) => {
  <span class="keyword">const</span> contact = <span class="keyword">await</span> CRM.getContact(req.params.id);
  res.json(contact);  <span class="comment">// Only PII, no health context</span>
});

<span class="keyword">app.get</span>(<span class="string">'/api/appointments/:patientHash'</span>, <span class="keyword">async</span> (req, res) => {
  <span class="comment">// Use hashed patient ID, not email/name</span>
  <span class="keyword">const</span> appointments = <span class="keyword">await</span> EHR.getAppointments(req.params.patientHash);
  res.json(appointments);  <span class="comment">// Health data but no direct PII</span>
});

<span class="comment">// Client-side: Join only in memory, never persist combined data</span></div>
        
        <p style="margin-top: 1rem;"><strong>Benefits:</strong></p>
        <ul>
            <li>Backend logs don't contain PHI (separate endpoints)</li>
            <li>Can cache contact info safely (no health context)</li>
            <li>Health data uses hashed identifiers, not emails/names</li>
            <li>Still functional for user experience, but architecturally safer</li>
        </ul>
    </div>

    <div class="scenario-box">
        <h4>✅ BEST Pattern: De-identification Layer</h4>
        <div class="code-example"><span class="comment">// Best: De-identify before any cross-system data flow</span>
<span class="keyword">app.get</span>(<span class="string">'/api/analytics/patient-flow'</span>, <span class="keyword">async</span> (req, res) => {
  <span class="keyword">const</span> rawData = <span class="keyword">await</span> fetchFromMultipleSystems();
  
  <span class="comment">// De-identify BEFORE combining</span>
  <span class="keyword">const</span> deidentified = rawData.map(record => ({
    patientHash: hash(record.patientId),        <span class="comment">// Hash identifier</span>
    ageRange: getAgeRange(record.age),          <span class="comment">// 30-40 instead of 37</span>
    zipPrefix: record.zip.substring(0, 3),      <span class="comment">// 021** instead of 02138</span>
    appointmentCategory: categorize(record.appointmentType),  <span class="comment">// "Specialist" vs "Cardiology"</span>
    month: record.date.substring(0, 7)          <span class="comment">// 2025-10 instead of 2025-10-15</span>
  }));
  
  res.json(deidentified);  <span class="comment">// ✅ Useful for analytics, but not PHI</span>
});</div>
        
        <p style="margin-top: 1rem;"><strong>Gold Standard:</strong></p>
        <ul>
            <li>Analytics get useful data without PHI exposure</li>
            <li>Can use tools without BAAs (no PHI = no BAA required)</li>
            <li>Reduces compliance burden across entire data pipeline</li>
            <li>Still provides valuable business insights</li>
        </ul>
    </div>
</div>

<div class="content-section">
    <h3>🎯 Builder's Checklist for Multi-System Integrations</h3>
    
    <div class="scenario-box">
        <h4>Before Building Any Integration, Ask:</h4>
        <ol style="padding-left: 1.5rem; line-height: 2.2;">
            <li>
                <span class="tooltip-item"><strong>Data inventory:</strong> What PII exists in System A? What health data exists in System B?
                    <span class="tooltip-content">
                        <strong>Start here BEFORE writing code:</strong>
                        <p>You cannot protect data you don't know about. Before integrating systems, inventory exactly what each system contains.</p>
                        <strong>Questions for System A (e.g., CRM):</strong>
                        <ul>
                            <li>What identifiers: emails, names, phone numbers, addresses?</li>
                            <li>What demographics: age, gender, location, employer?</li>
                            <li>Account/billing info that could identify individuals?</li>
                        </ul>
                        <strong>Questions for System B (e.g., Clinical):</strong>
                        <ul>
                            <li>What health data: diagnoses, medications, vitals, lab results?</li>
                            <li>What behaviors: appointment history, feature usage in health tools?</li>
                            <li>What content: viewed health articles, search terms?</li>
                        </ul>
                        <strong>Why this matters:</strong>
                        <p>If you integrate System A + System B without this inventory, you're blindly creating PHI. You need to know WHAT you're combining BEFORE you combine it.</p>
                        <strong>Red flag:</strong>
                        <p>"We'll figure out what data we need as we build the integration." No. Inventory first, design second, build third.</p>
                    </span>
                </span>
            </li>
            <li>
                <span class="tooltip-item"><strong>Combination points:</strong> Where do they combine? APIs? ETL jobs? Event streams? Frontend?
                    <span class="tooltip-content">
                        <strong>PHI is created at the moment of combination:</strong>
                        <p>The instant PII meets health data, PHI exists. You need to know EXACTLY where this happens so you can protect that point.</p>
                        <strong>Common combination points:</strong>
                        <ul>
                            <li><strong>API layer:</strong> Backend endpoint JOINs user table with health records table</li>
                            <li><strong>ETL/Data pipeline:</strong> Nightly job merges CRM export with clinical data warehouse</li>
                            <li><strong>Event streams:</strong> Kafka topic receives user_id + health_event, combined in stream processor</li>
                            <li><strong>Frontend:</strong> React component fetches user info AND health data, displays together</li>
                            <li><strong>Analytics:</strong> BI tool joins marketing database with product usage (health features)</li>
                            <li><strong>Reporting:</strong> SQL query combines contact info with medical history for provider dashboard</li>
                        </ul>
                        <strong>Why every point matters:</strong>
                        <p>Each combination point needs: proper logging controls, BAA-covered infrastructure, access controls, audit trails. Miss one point = PHI exposure.</p>
                        <strong>Action:</strong>
                        <p>Draw a data flow diagram. Circle every place where PII and health data meet. That's your PHI attack surface.</p>
                    </span>
                </span>
            </li>
            <li>
                <span class="tooltip-item"><strong>Data flow:</strong> Map the entire flow - which systems touch the combined data?
                    <span class="tooltip-content">
                        <strong>PHI doesn't stay in one place:</strong>
                        <p>Once created, PHI flows through your architecture. Every system it touches becomes a PHI handler requiring protections.</p>
                        <strong>Typical flow example:</strong>
                        <ol>
                            <li>API Gateway receives request with user_id</li>
                            <li>Auth Service validates, adds email to context</li>
                            <li>Patient Service fetches diagnosis from DB</li>
                            <li>Aggregation Service combines email + diagnosis</li>
                            <li>Cache layer (Redis) stores combined result</li>
                            <li>API Gateway returns PHI to frontend</li>
                            <li>Frontend renders in browser, may hit local storage</li>
                            <li>Logging at each layer captures request/response</li>
                        </ol>
                        <strong>Each system now handles PHI:</strong>
                        <p>API Gateway, Auth Service, Patient Service, Aggregation Service, Redis cache, logs at every layer. All need BAA coverage, encryption, access controls.</p>
                        <strong>The forgotten systems:</strong>
                        <ul>
                            <li>Message queues between services</li>
                            <li>Load balancers (access logs)</li>
                            <li>CDN/reverse proxies (if caching responses)</li>
                            <li>Monitoring/APM tools (capturing requests)</li>
                        </ul>
                        <strong>Action required:</strong>
                        <p>Document EVERY system in the flow. Verify each has appropriate safeguards. One unprotected link = breach path.</p>
                    </span>
                </span>
            </li>
            <li>
                <span class="tooltip-item"><strong>BAA coverage:</strong> Does EVERY system in the flow have appropriate BAA coverage?
                    <span class="tooltip-content">
                        <strong>The chain rule:</strong>
                        <p>PHI protection is only as strong as the weakest link. If ANY system in your data flow lacks BAA coverage, you're in HIPAA violation.</p>
                        <strong>Systems that need BAA coverage:</strong>
                        <ul>
                            <li>Cloud infrastructure (AWS/Azure/GCP services that touch PHI)</li>
                            <li>Database hosting (RDS, Cosmos DB, Cloud SQL)</li>
                            <li>Cache layers (ElastiCache, Redis Cloud, Memorystore)</li>
                            <li>Message queues (SQS, Service Bus, Pub/Sub)</li>
                            <li>Log aggregation (CloudWatch, Stackdriver, Azure Monitor)</li>
                            <li>Monitoring/APM (Datadog, New Relic, if capturing PHI)</li>
                            <li>Error tracking (Sentry, Rollbar, if capturing PHI)</li>
                            <li>CDN (if caching responses with PHI)</li>
                            <li>Load balancers (if logging request details)</li>
                        </ul>
                        <strong>Common mistake:</strong>
                        <p>"We have an AWS BAA!" → But does it cover the SPECIFIC services you use? AWS BAA might cover EC2 but not all analytics services. Read the fine print.</p>
                        <strong>Verification checklist:</strong>
                        <ol>
                            <li>List every infrastructure component in data flow</li>
                            <li>Confirm vendor offers BAA for that specific service</li>
                            <li>Verify BAA is actually signed (don't assume)</li>
                            <li>Check BAA covers your usage (some have limitations)</li>
                            <li>Document BAA coverage in your compliance records</li>
                        </ol>
                    </span>
                </span>
            </li>
            <li>
                <span class="tooltip-item"><strong>Logging:</strong> What gets logged at integration points? API gateways? Message queues? Error tracking?
                    <span class="tooltip-content">
                        <strong>Integration points = logging hot spots:</strong>
                        <p>Every system boundary logs something. APIs log requests. Message queues log messages. ETL jobs log transformations. These logs often contain PHI.</p>
                        <strong>What typically gets logged at integrations:</strong>
                        <ul>
                            <li><strong>API Gateway:</strong> Full request/response bodies, headers, query params</li>
                            <li><strong>Load Balancer:</strong> Access logs with URLs (may contain patient IDs in path)</li>
                            <li><strong>Message Queue:</strong> Message payloads, routing keys, consumer errors</li>
                            <li><strong>ETL/Data Pipeline:</strong> Source/target data samples, transformation errors, failed records</li>
                            <li><strong>Service Mesh:</strong> Request tracing with full context propagation</li>
                            <li><strong>Database Proxy:</strong> Query logs with WHERE clauses containing PHI</li>
                        </ul>
                        <strong>Real-world example:</strong>
                        <p>API Gateway logging full request bodies → logs contain <code>{"email": "patient@example.com", "diagnosis": "HIV"}</code> → logs sent to CloudWatch → now CloudWatch contains PHI → needs BAA coverage + restricted access.</p>
                        <strong>How to fix:</strong>
                        <ul>
                            <li>Configure log scrubbing at source (redact PHI fields)</li>
                            <li>Log metadata only (correlation IDs, status codes) not payloads</li>
                            <li>Use structured logging with field-level control</li>
                            <li>Regularly audit what's actually being logged (not just config)</li>
                        </ul>
                    </span>
                </span>
            </li>
            <li>
                <span class="tooltip-item"><strong>Caching:</strong> Are you caching combined data? Where? Is that covered by BAA?
                    <span class="tooltip-content">
                        <strong>Caching multiplies PHI exposure:</strong>
                        <p>When you cache PHI, you're creating additional copies in additional systems, each needing protection. Cache = extra PHI storage.</p>
                        <strong>Common cache locations in integrations:</strong>
                        <ul>
                            <li><strong>Application cache:</strong> Redis/Memcached holding API responses with PHI</li>
                            <li><strong>API Gateway cache:</strong> Caching responses to reduce backend load</li>
                            <li><strong>CDN edge cache:</strong> Caching API responses at edge locations</li>
                            <li><strong>Browser cache:</strong> HTTP cache headers causing PHI storage in browser</li>
                            <li><strong>Database query cache:</strong> Cached query results in database layer</li>
                            <li><strong>ORM cache:</strong> Hibernate/Entity Framework second-level cache</li>
                        </ul>
                        <strong>Questions to ask:</strong>
                        <ul>
                            <li>What's the cache TTL? (Longer = more PHI retention risk)</li>
                            <li>Is cache encrypted at rest and in transit?</li>
                            <li>Who has access to cache? (DBAs, DevOps, developers?)</li>
                            <li>Is cache infrastructure covered by BAA?</li>
                            <li>Can cache be exported/dumped? (PHI extraction risk)</li>
                            <li>How is cache invalidated when patient requests data deletion?</li>
                        </ul>
                        <strong>Best practice:</strong>
                        <p>Don't cache PHI if possible. If you must: short TTL (minutes not hours), encrypted, BAA-covered infrastructure, strict access controls.</p>
                    </span>
                </span>
            </li>
            <li>
                <span class="tooltip-item"><strong>Can we de-identify?</strong> Do we NEED identifiable data combined, or can we hash/aggregate first?
                    <span class="tooltip-content">
                        <strong>The best PHI protection: don't create it:</strong>
                        <p>Before building an integration that creates PHI, ask: can we accomplish the goal WITHOUT identifiable data?</p>
                        <strong>De-identification strategies:</strong>
                        <ul>
                            <li><strong>Hash before combining:</strong> Use SHA-256(user_id + salt) so systems can correlate data without exposing identity</li>
                            <li><strong>Aggregate first:</strong> Instead of individual-level data, combine aggregated/anonymized data</li>
                            <li><strong>Separate workflows:</strong> Run PII workflow separately from health workflow, never join them</li>
                            <li><strong>Token replacement:</strong> Replace PII with tokens, keep mapping in separate secured system</li>
                        </ul>
                        <strong>Example scenarios:</strong>
                        <p><strong>Need:</strong> Show provider which patients viewed their health portal</p>
                        <p>❌ Bad: JOIN patients (name, email) with portal_access (timestamps, viewed_pages)</p>
                        <p>✅ Good: Aggregate: "42 patients accessed portal in last week" (no individual identification)</p>
                        <p><strong>Need:</strong> Analytics on feature usage by diagnosis</p>
                        <p>❌ Bad: Track "user@email.com clicked glucose tracking (diabetes diagnosis)"</p>
                        <p>✅ Good: Track "Cohort: Q3-2025-Diabetes-Patients, Feature: GlucoseTracking, Count: 847 clicks"</p>
                        <strong>When you CAN'T de-identify:</strong>
                        <p>Some use cases legitimately need identifiable PHI (provider dashboards, patient portals). That's fine - but confirm it's necessary before building. Many assumed-necessary cases can actually work with hashed/aggregated data.</p>
                    </span>
                </span>
            </li>
            <li>
                <span class="tooltip-item"><strong>Frontend exposure:</strong> Is combined PHI visible in browser dev tools, network tab, or local storage?
                    <span class="tooltip-content">
                        <strong>The browser is an uncontrolled environment:</strong>
                        <p>Once PHI reaches the browser, you lose control. Users can inspect network traffic, view local storage, take screenshots, use browser extensions that exfiltrate data.</p>
                        <strong>Where PHI appears in browsers:</strong>
                        <ul>
                            <li><strong>Network tab:</strong> API responses containing PHI visible in DevTools</li>
                            <li><strong>Local Storage:</strong> Cached user objects with email + health data</li>
                            <li><strong>Session Storage:</strong> Temporary PHI storage during user session</li>
                            <li><strong>Cookies:</strong> PHI in cookie values (terrible practice but happens)</li>
                            <li><strong>URL parameters:</strong> <code>/patient/12345/diabetes-plan</code> exposes patient ID + condition</li>
                            <li><strong>Page source:</strong> PHI rendered in HTML/JavaScript</li>
                            <li><strong>Console logs:</strong> Debug statements logging PHI objects</li>
                        </ul>
                        <strong>Risks of frontend PHI:</strong>
                        <ul>
                            <li>Browser extensions can read/exfiltrate data</li>
                            <li>XSS vulnerabilities can steal PHI from DOM/storage</li>
                            <li>Users screenshot/share URLs containing PHI</li>
                            <li>Cached data persists after logout</li>
                            <li>Browser history contains PHI-revealing URLs</li>
                        </ul>
                        <strong>How to minimize frontend PHI:</strong>
                        <ul>
                            <li>Send only absolutely necessary data to browser</li>
                            <li>Never store PHI in local/session storage (use memory only)</li>
                            <li>Use hashed IDs in URLs, not patient identifiers</li>
                            <li>Implement proper session timeout and data clearing</li>
                            <li>Add Content-Security-Policy headers</li>
                            <li>Remove console.log statements before production</li>
                        </ul>
                        <strong>Test this:</strong>
                        <p>Open DevTools, use your app, check Network tab and Application tab. If you see PHI, you're exposing it to an uncontrolled environment.</p>
                    </span>
                </span>
            </li>
        </ol>
    </div>
</div>

<div class="alert alert-warning">
    <strong>⚠️ Special Warning for Microservices Architectures:</strong> Every microservice boundary is a potential PHI creation point. Service A has PII, Service B has health data, Service C combines them → Service C now handles PHI and needs appropriate safeguards, logging controls, and BAA coverage for all its dependencies.
</div>

                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-title">Exercise 3.5e: Multi-System Challenge</div>
                        </div>

                        <div class="question" data-question="20" data-correct="no">
                            <div class="question-text">20. Analytics dashboard pulls data from two separate systems: User database (emails, names) exports to CSV, and Appointment database (dates, types) exports to different CSV. CSVs are analyzed separately, never joined. PHI created?</div>
                            <ul class="options">
                                <li class="option" data-answer="yes" tabindex="0">Yes - Multi-system PHI</li>
                                <li class="option" data-answer="no" tabindex="0">No - Systems separate</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> When systems truly operate separately with no data combination, PHI is not created. PII in one CSV and health data in another CSV = safe as long as they're never joined or correlated.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Separate systems with no combination = no PHI. The key is that the CSVs are analyzed separately and never joined. If they were joined (even by user_id), THEN PHI would be created. The correct answer is <strong>No</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="21" data-correct="yes">
                            <div class="question-text">21. API endpoint `/api/patient-summary` returns: `{"email": "john@email.com", "lastVisit": "Cardiology clinic", "nextAppointment": "2025-11-20"}` - PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="no" tabindex="0">No - Systems separate</li>
                                <li class="option" data-answer="yes" tabindex="0">Yes - Multi-system PHI</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Email (PII) + cardiology clinic visit (health data) = PHI when combined in a single API response. This means API logs, error tracking, caching layers, and frontend state all now contain PHI and need appropriate safeguards.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> The API endpoint combines PII (email) with health information (cardiology clinic visit) in a single response, creating PHI. Even though the data may come from separate backend systems, combining them at the API layer creates PHI. The correct answer is <strong>Yes</strong>.
                            </div>
                        </div>
                    </div>

                    <div class="subsection-nav">
                        <button class="btn btn-secondary subsection-nav-btn" onclick="prevSubsection()">
                            ← Previous: Inference Problem
                        </button>
                        <div style="color: #6c757d; font-weight: bold;">Section 5 of 6</div>
                        <button class="btn btn-primary subsection-nav-btn" onclick="nextSubsection()">
                            Next: HIPAA Safe Harbor →
                        </button>
                    </div>
                </div>

               <!-- Subsection: Safe Harbor -->
<div class="module-subsection" id="subsection-safeharbor">
    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
        <strong style="color: #2980b9;">🔍 Current Section: 6. HIPAA Safe Harbor (Final Section)</strong>
    </div>
    
    <div class="content-section">
        <h3>🛡️ Introduction to HIPAA Safe Harbor</h3>
        <p>Safe Harbor is HIPAA's method for de-identifying data so it's no longer considered PHI. When properly applied, you can use the data for development, testing, and analytics without PHI restrictions.</p>
    </div>

    <div class="alert alert-success">
        <strong>📚 What's Ahead:</strong> This section introduces Safe Harbor basics needed for the scenarios below. You'll get comprehensive de-identification techniques and code examples in Module 4!
    </div>

    <div class="content-section">
        <h3>Safe Harbor: Three Rules You Need Now</h3>
        <p>Safe Harbor requires removing 18 types of identifiers (you'll learn all of them in Module 4). For now, focus on these three that appear in common technical scenarios:</p>

        <div class="scenario-box">
            <h4>Rule 1: ZIP Codes - The 20,000 Population Rule</h4>
            <p>You can share the first 3 digits of a ZIP code <strong>only if</strong> all ZIP codes starting with those 3 digits have a combined population of at least 20,000 people.</p>
            
            <table class="comparison-table" style="margin-top: 1rem;">
                <thead>
                    <tr>
                        <th>Example</th>
                        <th>Combined Population</th>
                        <th>Can Share?</th>
                        <th>What to Use</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ZIP 331XX (Chicago area)</td>
                        <td>45,000</td>
                        <td><span style="color: #27ae60;">✅ Yes</span></td>
                        <td>"331XX" or "331**"</td>
                    </tr>
                    <tr>
                        <td>ZIP 059XX (Rural Vermont)</td>
                        <td>12,000</td>
                        <td><span style="color: #e74c3c;">❌ No</span></td>
                        <td>"000XX" (generic)</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="scenario-box">
            <h4>Rule 2: Dates - Year Only</h4>
            <p>Safe Harbor allows <strong>only the year</strong> from any date. All specific dates, months, quarters, or day-level information must be removed.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                <div style="background: #f8d7da; padding: 1rem; border-radius: 6px;">
                    <strong style="color: #721c24;">❌ Not Safe Harbor Compliant:</strong>
                    <ul style="margin-top: 0.5rem; color: #721c24; padding-left: 1.5rem;">
                        <li>"Admitted: 03/15/2024"</li>
                        <li>"Birth date: March 15, 1985"</li>
                        <li>"Service: Q1 2024"</li>
                        <li>"Discharged: January 2024"</li>
                    </ul>
                </div>
                <div style="background: #d4edda; padding: 1rem; border-radius: 6px;">
                    <strong style="color: #155724;">✅ Safe Harbor Compliant:</strong>
                    <ul style="margin-top: 0.5rem; color: #155724; padding-left: 1.5rem;">
                        <li>"Admitted: 2024"</li>
                        <li>"Birth year: 1985"</li>
                        <li>"Service year: 2024"</li>
                        <li>"Discharged: 2024"</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="scenario-box">
            <h4>Rule 3: Ages Over 89 Must Be Aggregated</h4>
            <p>Any age over 89 must be grouped into a category like "90+" rather than showing the specific age. Ages 89 and under can be shown exactly.</p>
            
            <table class="comparison-table" style="margin-top: 1rem;">
                <thead>
                    <tr>
                        <th>Original Ages</th>
                        <th>Safe Harbor Treatment</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>23, 45, 67, 89</td>
                        <td><span style="color: #27ae60;">✅ Show as-is:</span> 23, 45, 67, 89</td>
                    </tr>
                    <tr>
                        <td>91, 93, 95</td>
                        <td><span style="color: #27ae60;">✅ Aggregate:</span> 90+, 90+, 90+</td>
                    </tr>
                    <tr>
                        <td>42, 67, 91, 35, 93, 28</td>
                        <td><span style="color: #27ae60;">✅ Mixed:</span> 42, 67, 90+, 35, 90+, 28</td>
                    </tr>
                </tbody>
            </table>

            <div class="alert alert-info" style="margin-top: 1rem;">
                <strong>Why?</strong> People over 90 are rare (~2% of population). Showing specific ages like 91 or 93 combined with other data could identify individuals.
            </div>
        </div>
    </div>

    <div class="alert alert-warning" style="margin-top: 2rem;">
        <strong>⚠️ Important Note:</strong> These three rules are just a starting point. Safe Harbor actually requires removing <strong>18 different types of identifiers</strong>. You'll learn the complete list, technical implementation, and code examples in Module 4: De-Identification Techniques.
    </div>

    <div class="exercise">
        <div class="exercise-header">
            <div class="exercise-title">Exercise 3.6f: Safe Harbor Challenge</div>
        </div>

        <div class="question" data-question="22" data-correct="yes">
            <div class="question-text">22. ZIP codes 331XX covering Chicago suburbs (Population: 45,000) - Can share "331XX"?</div>
            <ul class="options">
                <li class="option" data-answer="no" tabindex="0">No - Must use "000XX"</li>
                <li class="option" data-answer="yes" tabindex="0">Yes - Can share "331XX"</li>
            </ul>
            <div class="feedback correct">
                <strong>Correct!</strong> Population >20K meets HIPAA Safe Harbor requirements.
            </div>
            <div class="feedback incorrect">
                <strong>Incorrect.</strong> Population >20K = can share first 3 digits. The correct answer is <strong>Yes</strong>.
            </div>
        </div>

        <div class="question" data-question="23" data-correct="no">
            <div class="question-text">23. Dataset shows "Patient admitted: 03/15/2024, discharged: 03/18/2024" - Safe Harbor compliant?</div>
            <ul class="options">
                <li class="option" data-answer="yes" tabindex="0">Yes - Dates alone aren't identifiable</li>
                <li class="option" data-answer="no" tabindex="0">No - Must remove specific dates, keep only year</li>
            </ul>
            <div class="feedback correct">
                <strong>Correct!</strong> Safe Harbor requires removing all dates except year. Must show only "2024" or use date ranges, not specific dates.
            </div>
            <div class="feedback incorrect">
                <strong>Incorrect.</strong> Specific dates must be removed under Safe Harbor - only year can remain. The correct answer is <strong>No</strong>.
            </div>
        </div>

        <div class="question" data-question="24" data-correct="yes">
            <div class="question-text">24. Research dataset shows patient ages: "42, 67, 91, 35, 93, 28" - How should ages 91 and 93 be reported for Safe Harbor compliance?</div>
            <ul class="options">
                <li class="option" data-answer="no" tabindex="0">No change needed - actual ages are fine</li>
                <li class="option" data-answer="yes" tabindex="0">Yes - Must aggregate to "90+" or age ranges</li>
            </ul>
            <div class="feedback correct">
                <strong>Correct!</strong> Safe Harbor requires ages over 89 to be aggregated (e.g., "90+") because they're rare and potentially identifying.
            </div>
            <div class="feedback incorrect">
                <strong>Incorrect.</strong> Ages over 89 must be aggregated under Safe Harbor rules. The correct answer is <strong>Yes - Must aggregate to "90+"</strong>.
            </div>
        </div>
    </div>

    <div class="subsection-nav">
        <button class="btn btn-secondary subsection-nav-btn" onclick="prevSubsection()">
            ← Previous: Multi-System Flows
        </button>
        <div style="color: #6c757d; font-weight: bold;">Section 6 of 6 <span style="color: #27ae60;">✓</span> Complete</div>
        <button class="btn btn-success subsection-nav-btn" onclick="nextModule()">
            Continue to Next Module →
        </button>
    </div>
</div>
                <!-- End of Safe Harbor subsection -->

                <div class="content-section" style="margin-top: 2rem; padding: 1.5rem; background: #e8f4fd; border-radius: 8px;">
                    <h3>🎯 Module 3 Key Takeaways</h3>
                    <ul>
                        <li><strong>Context Creates PHI:</strong> Safe data becomes PHI when combined</li>
                        <li><strong>System Boundaries:</strong> PHI emerges where systems integrate</li>
                        <li><strong>Inference Counts:</strong> Behavioral patterns can imply health conditions</li>
                    </ul>
                </div>
            </div>

            <!-- Module 4: Handling & Protection WITH SUBSECTIONS -->
            <div class="module" id="module-4">
                <div class="module-header">
                    <div class="module-title">Module 4: Handling, Protection & Technical Compliance</div>
                    <p>Duration: 20-25 minutes</p>
                </div>

                <div class="alert alert-warning">
                    <strong>Technical Deep-Dive:</strong> This module covers core principles, de-identification techniques, and BAA obligations. Each subsection includes practice exercises.
                    <ul style="margin-top: 0.5rem; padding-left: 2rem;">
                        <li>Green checkmark (<span style="color: #27ae60;">✓</span>) appears after viewing each section</li>
                        <li>Answer exercises to reinforce learning</li>
                    </ul>
                </div>

                <div class="content-section">
                    <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h4 style="color: #856404; margin-bottom: 0.5rem;">📋 Quick Navigation - Click Any Section:</h4>
                        <p style="color: #856404; font-size: 0.9rem; margin-bottom: 0.5rem;">Use buttons below OR scroll to bottom for Next/Previous buttons</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn btn-secondary module-section-btn active viewed" data-section="m4-principles" data-module="4">1. Core Principles</button>
                            <button class="btn btn-secondary module-section-btn" data-section="m4-deidentification" data-module="4">2. De-Identification</button>
                            <button class="btn btn-secondary module-section-btn" data-section="m4-baa" data-module="4">3. BAA Understanding</button>
                        </div>
                    </div>
                </div>

                <!-- Subsection 4a: Core Principles -->
                <div class="module-subsection active" id="subsection-m4-principles">
                    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
                        <strong style="color: #2980b9;">🔍 Current Section: 1. Core Principles (~3 min)</strong>
                    </div>

                   <div class="content-section">
    <h3>The Three Foundational Principles</h3>
    <p>These principles guide every technical decision when working with PHI:</p>

    <div class="scenario-box">
        <h4>Principle 1: Minimize Access & Storage</h4>
        <p><strong>What this means in practice:</strong></p>
        <ul>
            <li><strong>RBAC (Role-Based Access Control):</strong> Only grant access to PHI based on job function necessity</li>
            <li><strong>Just-in-time access:</strong> Temporary, time-limited access with approval workflows</li>
            <li><strong>No local storage:</strong> Never download PHI to laptops, personal drives, or development machines</li>
        </ul>
        
        <div style="background: #f8d7da; padding: 1rem; border-radius: 6px; margin-top: 1rem; border-left: 4px solid #dc3545;">
            <strong style="color: #721c24;">❌ Common Violations:</strong>
            <ul style="margin-top: 0.5rem; color: #721c24; margin-left: 2.5rem; padding-left: 1.5rem;">
                <li>Downloading production database to laptop for "quick analysis"</li>
                <li>Copying PHI to personal drives for "backup"</li>
                <li>Leaving PHI in IDE scratch files or browser dev tools cache</li>
                <li>Giving all developers permanent production access "just in case"</li>
            </ul>
        </div>

        <p style="margin-top: 1rem;"><strong>🎯 Why it matters for developers:</strong> Every copy of PHI creates a new attack surface and compliance obligation. The fewer places PHI exists, the easier it is to secure and audit.</p>
    </div>

    <div class="scenario-box">
        <h4>Principle 2: Use Approved Tools Only</h4>
        <p><strong>What this means in practice:</strong></p>
        <ul>
            <li><strong>AI Tools:</strong> Must have Business Associate Agreements (BAAs)</li>
            <li><strong>Cloud Services:</strong> AWS, Azure, GCP - verify BAA coverage per service</li>
            <li><strong>Monitoring Tools:</strong> APM, logging, analytics - all need BAAs if touching PHI</li>
        </ul>
        
        <div style="background: #f8d7da; padding: 1rem; border-radius: 6px; margin-top: 1rem; border-left: 4px solid #dc3545;">
            <strong style="color: #721c24;">❌ Common Violations:</strong>
            <ul style="margin-top: 0.5rem; color: #721c24; margin-left: 2.5rem; padding-left: 1.5rem;">
                <li>Using personal ChatGPT for debugging healthcare code</li>
                <li>GitHub Copilot individual tier (no BAA) instead of enterprise</li>
                <li>Personal Dropbox for sharing test data</li>
                <li>Screenshot tools that upload to cloud without BAA</li>
            </ul>
        </div>

        <div class="alert alert-warning" style="margin-top: 1rem; font-size: 0.9rem;">
            <strong>⚠️ Critical Distinction: Enterprise vs Individual Tiers</strong><br>
            Many tools offer both - only enterprise tiers typically include BAAs!
        </div>
    </div>

    <div class="scenario-box">
        <h4>Principle 3: De-identify for Development</h4>
        <p><strong>What this means in practice:</strong></p>
        <ul>
            <li><strong>Synthetic data generation:</strong> Use libraries like Faker to create realistic but fake data</li>
            <li><strong>Proper de-identification:</strong> Remove all 18 HIPAA identifiers, not just names</li>
            <li><strong>Test data generators:</strong> Build tools to create production-like test data</li>
        </ul>
        
        <div style="background: #f8d7da; padding: 1rem; border-radius: 6px; margin-top: 1rem; border-left: 4px solid #dc3545;">
            <strong style="color: #721c24;">❌ Common Violations:</strong>
            <ul style="margin-top: 0.5rem; color: #721c24; margin-left: 2.5rem; padding-left: 1.5rem;">
                <li>"Just changing the names" but keeping real addresses, dates, diagnosis codes</li>
                <li>Using production data from 2 years ago assuming it's "old enough"</li>
                <li>Hashing identifiers but keeping them linkable to other datasets</li>
                <li>Thinking "test" data is automatically safe without verification</li>
            </ul>
        </div>
    </div>
</div>

                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-title">Exercise 4.1a: Core Principles Application</div>
                        </div>

                        <div class="question" data-question="25" data-correct="c">
                            <div class="question-text">25. You're setting up your local development environment. Your teammate suggests: "Just copy the production patient database to your laptop for testing - it's faster than creating fake data." What's the correct action?</div>
                            <ul class="options">
                                <li class="option" data-answer="a" tabindex="0">a) Copy it if you encrypt your laptop</li>
                                <li class="option" data-answer="b" tabindex="0">b) Copy only a small subset of patients</li>
                                <li class="option" data-answer="c" tabindex="0">c) Refuse - never store production PHI locally, use synthetic data</li>
                                <li class="option" data-answer="d" tabindex="0">d) Copy it but delete after testing</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Core principle: Never store PHI locally without approval. Always use synthetic/de-identified data for development.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Minimize access & storage principle: Never store production PHI locally. Use synthetic data instead. The correct answer is <strong>c)</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="26" data-correct="b">
                            <div class="question-text">26. You need to share patient visit logs with the analytics team for dashboard development. The logs contain timestamps, session IDs, and page views. What's the safest approach?</div>
                            <ul class="options">
                                <li class="option" data-answer="a" tabindex="0">a) Share full logs - they're just technical data</li>
                                <li class="option" data-answer="b" tabindex="0">b) Hash patient identifiers before sharing, remove any PHI</li>
                                <li class="option" data-answer="c" tabindex="0">c) Share only with team members who signed NDAs</li>
                                <li class="option" data-answer="d" tabindex="0">d) Encrypt the log files before sending</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Minimize access principle: De-identify data before sharing. Hash identifiers and remove PHI to create safe analytics data.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Minimize access requires de-identification before sharing. Hash identifiers and remove PHI. The correct answer is <strong>b)</strong>.
                            </div>
                        </div>
                    </div>

                    <div class="subsection-nav">
                        <div></div>
                        <div style="color: #6c757d; font-weight: bold;">Section 1 of 3</div>
                        <button class="btn btn-primary subsection-nav-btn" onclick="nextModule4Subsection()">
                            Next: De-Identification Techniques →
                        </button>
                    </div>
                </div>

                <!-- Subsection 4b: De-Identification (content from v2.1) -->
                <div class="module-subsection" id="subsection-m4-deidentification">
                    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
                        <strong style="color: #2980b9;">🔍 Current Section: 2. De-Identification Techniques (~10-12 min)</strong>
                    </div>

                    <div class="content-section">
                        <h3>🔒 De-Identification Techniques for Developers</h3>
                        <p>De-identification is removing or obscuring PHI from datasets while preserving utility for development, testing, and analytics. Understanding these techniques is critical for technical teams.</p>
                    </div>

                    <div class="alert alert-info">
                        <strong>Critical Distinction:</strong> Properly de-identified data is NOT PHI under HIPAA. This allows you to work with realistic healthcare data without PHI compliance requirements.
                    </div>

                    <div class="content-section">
                        <h3>HIPAA Safe Harbor: The 18 Identifiers</h3>
                        <p>Under HIPAA's Safe Harbor method, you must remove these 18 identifier types to de-identify data:</p>
                        
                        <div class="scenario-box">
                            <h4>The 18 Protected Identifiers</h4>
                            <ol style="padding-left: 2rem; line-height: 1.8;">
                                <li><strong>Names</strong> - All names of individuals</li>
                                <li><strong>Geographic subdivisions</strong> smaller than state (except first 3 digits of ZIP if population >20K)</li>
                                <li><strong>Dates</strong> - All dates except year (birth, admission, discharge, death)</li>
                                <li><strong>Telephone numbers</strong></li>
                                <li><strong>Fax numbers</strong></li>
                                <li><strong>Email addresses</strong></li>
                                <li><strong>Social Security numbers</strong></li>
                                <li><strong>Medical record numbers</strong></li>
                                <li><strong>Health plan beneficiary numbers</strong></li>
                                <li><strong>Account numbers</strong></li>
                                <li><strong>Certificate/license numbers</strong></li>
                                <li><strong>Vehicle identifiers</strong> (VIN, license plates)</li>
                                <li><strong>Device identifiers and serial numbers</strong></li>
                                <li><strong>URLs</strong></li>
                                <li><strong>IP addresses</strong></li>
                                <li><strong>Biometric identifiers</strong> (fingerprints, voiceprints)</li>
                                <li><strong>Full-face photos and comparable images</strong></li>
                                <li><strong>Any other unique identifying number, characteristic, or code</strong></li>
                            </ol>
                        </div>

                        <div class="alert alert-warning">
                            <strong>⚠️ Common Mistake:</strong> Developers often think removing just names is enough. You must remove ALL 18 identifier types to meet Safe Harbor requirements!
                        </div>
                    </div>

                    <div class="content-section">
                        <h3>Technical De-Identification Methods</h3>
                        <p>Three primary techniques for de-identifying data in technical systems:</p>
                        
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Method</th>
                                    <th>What It Does</th>
                                    <th>When To Use</th>
                                    <th>Reversible?</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Hashing</strong></td>
                                    <td>One-way transformation to fixed-length string</td>
                                    <td>Need consistency (same input = same output) but no reversal</td>
                                    <td>❌ No</td>
                                </tr>
                                <tr>
                                    <td><strong>Encryption</strong></td>
                                    <td>Two-way transformation using a key</td>
                                    <td>Need to retrieve original value later</td>
                                    <td>✅ Yes (with key)</td>
                                </tr>
                                <tr>
                                    <td><strong>Tokenization</strong></td>
                                    <td>Replace with random token, store mapping separately</td>
                                    <td>Need reversibility + format preservation</td>
                                    <td>✅ Yes (with vault)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="content-section">
                        <h3>Practical Code Examples</h3>
                        
                        <div class="scenario-box">
                            <h4>1. Hashing for Consistent De-Identification</h4>
                            <p><strong>Use Case:</strong> Logging user activity without exposing email addresses</p>
                            
                            <div class="code-example"><span class="comment"># Python - SHA-256 hashing</span>
<span class="keyword">import</span> hashlib

<span class="keyword">def</span> hash_patient_id(patient_id):
    <span class="comment"># Add secret salt to prevent rainbow table attacks</span>
    salt = <span class="string">"your-secret-salt-here"</span>
    combined = f<span class="string">"{salt}{patient_id}"</span>
    <span class="keyword">return</span> hashlib.sha256(combined.encode()).hexdigest()

<span class="comment"># Example usage</span>
email = <span class="string">"john.smith@email.com"</span>
hashed = hash_patient_id(email)
<span class="keyword">print</span>(f<span class="string">"Hashed: {hashed[:16]}..."</span>)
<span class="comment"># Output: "7a3f9c2e4b1d8f6a..."</span>

<span class="comment"># Use in logs</span>
logger.info(f<span class="string">"User {hashed[:16]} accessed diabetes module"</span>)
<span class="comment"># ✅ Safe: No PII in logs, consistent for analytics</span></div>
                            
                            <div class="alert alert-success" style="font-size: 0.9rem;">
                                <strong>✅ Pros:</strong> Fast, consistent, irreversible<br>
                                <strong>❌ Cons:</strong> Can't recover original, vulnerable to brute force without salting
                            </div>
                        </div>

                        <div class="scenario-box">
                            <h4>2. Encryption for Reversible Protection</h4>
                            <p><strong>Use Case:</strong> Storing PHI that needs to be decrypted for authorized use</p>
                            
                            <div class="code-example"><span class="comment">// JavaScript - AES encryption</span>
<span class="keyword">const</span> crypto = require(<span class="string">'crypto'</span>);

<span class="keyword">function</span> encryptPHI(plaintext, key) {
    <span class="keyword">const</span> iv = crypto.randomBytes(16);
    <span class="keyword">const</span> cipher = crypto.createCipheriv(
        <span class="string">'aes-256-cbc'</span>, Buffer.from(key), iv
    );
    
    <span class="keyword">let</span> encrypted = cipher.update(plaintext, <span class="string">'utf8'</span>, <span class="string">'hex'</span>);
    encrypted += cipher.final(<span class="string">'hex'</span>);
    
    <span class="keyword">return</span> { iv: iv.toString(<span class="string">'hex'</span>), data: encrypted };
}

<span class="comment">// Example</span>
<span class="keyword">const</span> ssn = <span class="string">"123-45-6789"</span>;
<span class="keyword">const</span> key = crypto.randomBytes(32);
<span class="keyword">const</span> encrypted = encryptPHI(ssn, key);
<span class="comment">// ✅ Safe: Can decrypt with key when needed</span></div>
                            
                            <div class="alert alert-success" style="font-size: 0.9rem;">
                                <strong>✅ Pros:</strong> Reversible with key, industry standard<br>
                                <strong>❌ Cons:</strong> Key management complexity, performance overhead
                            </div>
                        </div>

                        <div class="scenario-box">
                            <h4>3. Tokenization for Format Preservation</h4>
                            <p><strong>Use Case:</strong> Testing with SSN/credit card processing logic</p>
                            
                            <div class="code-example"><span class="comment"># Python - Format-preserving tokenization</span>
<span class="keyword">import</span> random

<span class="keyword">class</span> TokenVault:
    <span class="keyword">def</span> __init__(self):
        self.vault = {}
    
    <span class="keyword">def</span> tokenize_ssn(self, ssn):
        <span class="keyword">if</span> ssn <span class="keyword">in</span> self.vault:
            <span class="keyword">return</span> self.vault[ssn]
        
        <span class="comment"># Generate token with same format: XXX-XX-XXXX</span>
        token = f<span class="string">"{random.randint(100,999)}-"</span> + \
                f<span class="string">"{random.randint(10,99)}-"</span> + \
                f<span class="string">"{random.randint(1000,9999)}"</span>
        
        self.vault[ssn] = token
        <span class="keyword">return</span> token

<span class="comment"># Example</span>
vault = TokenVault()
real_ssn = <span class="string">"123-45-6789"</span>
token = vault.tokenize_ssn(real_ssn)
<span class="keyword">print</span>(f<span class="string">"Token: {token}"</span>)  <span class="comment"># Output: "847-23-4891"</span>
<span class="comment"># ✅ Looks real, works in tests, not actual PHI</span></div>
                            
                            <div class="alert alert-success" style="font-size: 0.9rem;">
                                <strong>✅ Pros:</strong> Format preserved, reversible, works with validation<br>
                                <strong>❌ Cons:</strong> Requires secure token vault, additional infrastructure
                            </div>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3>K-Anonymity: Beyond Individual De-Identification</h3>
                        <p><strong>K-anonymity</strong> ensures any individual in a dataset cannot be distinguished from at least k-1 others based on quasi-identifiers (age, ZIP, gender).</p>
                        
                        <div class="scenario-box">
                            <h4>How K-Anonymity Works (k=3 example)</h4>
                            
                            <table class="comparison-table" style="font-size: 0.85rem;">
                                <thead>
                                    <tr>
                                        <th>❌ Not K-Anonymous</th>
                                        <th>✅ K-Anonymous (k=3)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            Age: 47, ZIP: 02138, Diabetes<br>
                                            Age: 52, ZIP: 02139, Asthma<br>
                                            Age: 31, ZIP: 02140, Hypertension
                                        </td>
                                        <td>
                                            Age: 40-50, ZIP: 021**, Diabetes<br>
                                            Age: 40-50, ZIP: 021**, Asthma<br>
                                            Age: 40-50, ZIP: 021**, Hypertension
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <p style="margin-top: 1rem;"><strong>Key Technique:</strong> Generalization (age ranges) + Suppression (ZIP truncation) create groups of similar records.</p>
                        </div>

                        <div class="alert alert-warning">
                            <strong>⚠️ Limitation:</strong> K-anonymity alone doesn't guarantee privacy! Attackers may infer attributes if all k records share the same sensitive value (homogeneity attack).
                        </div>
                    </div>

                    <div class="content-section">
                        <h3>Common De-Identification Mistakes</h3>
                        
                        <div class="scenario-box" style="border-left-color: #e74c3c;">
                            <h4>❌ Mistake #1: Incomplete Identifier Removal</h4>
                            <div class="code-example"><span class="comment">// Bad: Only removed name and email</span>
{
    <span class="string">"patient_id"</span>: <span class="string">"P-12345"</span>,       <span class="comment">// ❌ Still identifiable</span>
    <span class="string">"birthdate"</span>: <span class="string">"1985-03-15"</span>,   <span class="comment">// ❌ Full date</span>
    <span class="string">"zip"</span>: <span class="string">"02138"</span>,             <span class="comment">// ❌ Full ZIP</span>
    <span class="string">"diagnosis"</span>: <span class="string">"Type 2 Diabetes"</span>
}

<span class="comment">// Good: All identifiers addressed</span>
{
    <span class="string">"patient_hash"</span>: <span class="string">"7a3f9c2e..."</span>, <span class="comment">// ✅ Hashed ID</span>
    <span class="string">"birth_year"</span>: <span class="string">"1985"</span>,         <span class="comment">// ✅ Year only</span>
    <span class="string">"zip"</span>: <span class="string">"021**"</span>,              <span class="comment">// ✅ First 3 digits</span>
    <span class="string">"diagnosis"</span>: <span class="string">"Type 2 Diabetes"</span><span class="comment">// ✅ Health data OK without PII</span>
}</div>
                        </div>

                        <div class="scenario-box" style="border-left-color: #e74c3c;">
                            <h4>❌ Mistake #2: Weak Hashing Without Salt</h4>
                            <div class="code-example"><span class="comment">// Bad: No salt - vulnerable to rainbow tables</span>
hashed = md5(patient_email)  <span class="comment">// ❌ Pre-computable</span>

<span class="comment">// Good: Salted hash with strong algorithm</span>
salt = <span class="string">"complex-random-salt"</span>
hashed = sha256(salt + patient_email)  <span class="comment">// ✅ Much harder to reverse</span></div>
                        </div>

                        <div class="scenario-box" style="border-left-color: #e74c3c;">
                            <h4>❌ Mistake #3: Re-identification Through Data Linkage</h4>
                            <p><strong>Scenario:</strong> Even "de-identified" datasets can be re-identified when combined:</p>
                            <ul>
                                <li>Dataset A: {age: 47, ZIP: 02138, diagnosis: diabetes}</li>
                                <li>Dataset B: {name: John Smith, age: 47, ZIP: 02138}</li>
                                <li><strong style="color: #e74c3c;">Risk:</strong> Join on age+ZIP → re-identify John = diabetes</li>
                            </ul>
                            <p><strong>Solution:</strong> Use k-anonymity (k≥5) and never share datasets that could be linked!</p>
                        </div>
                    </div>

                    <div class="content-section" style="margin-top: 2rem; padding: 1.5rem; background: #e8f4fd; border-radius: 8px;">
                        <h3>🎯 De-Identification Key Takeaways</h3>
                        <ul>
                            <li><strong>Safe Harbor = Remove All 18 Identifiers:</strong> Not just names and emails</li>
                            <li><strong>Choose Right Method:</strong> Hashing (one-way), Encryption (reversible), Tokenization (format-preserving)</li>
                            <li><strong>Always Salt Hashes:</strong> Prevent rainbow table attacks</li>
                            <li><strong>K-Anonymity for Datasets:</strong> Ensure groups of k≥5 similar records</li>
                            <li><strong>Watch Re-identification:</strong> Consider data linkage attacks</li>
                            <li><strong>Test with Synthetic Data:</strong> Generate realistic but fake data for development</li>
                        </ul>
                    </div>

                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-title">Exercise 4.1b: De-Identification Techniques</div>
                        </div>

                        <div class="question" data-question="27" data-correct="b">
                            <div class="question-text">27. You need to create a test dataset with 1,000 patient records for load testing. Which approach?</div>
                            <ul class="options">
                                <li class="option" data-answer="a" tabindex="0">a) Copy production data and remove names only</li>
                                <li class="option" data-answer="b" tabindex="0">b) Generate synthetic data with realistic patterns but no real patient info</li>
                                <li class="option" data-answer="c" tabindex="0">c) Hash all identifiers from production data</li>
                                <li class="option" data-answer="d" tabindex="0">d) Use production data but aggregate to k=5</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Always generate synthetic data for development/testing. Even with hashing or aggregation, using production data creates risks.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Always generate synthetic data for development/testing rather than using production data. The correct answer is <strong>b)</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="28" data-correct="c">
                            <div class="question-text">28. For analytics dashboard showing user activity, which de-identification method is best for consistent user tracking without exposing PHI?</div>
                            <ul class="options">
                                <li class="option" data-answer="a" tabindex="0">a) Encryption with shared key</li>
                                <li class="option" data-answer="b" tabindex="0">b) Tokenization with format preservation</li>
                                <li class="option" data-answer="c" tabindex="0">c) SHA-256 hashing with salt (same user = same hash)</li>
                                <li class="option" data-answer="d" tabindex="0">d) Random UUID per session (different each time)</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Hashing provides consistency (same input = same output) for analytics while being irreversible and protecting PHI.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Hashing provides the right balance: consistent for tracking but irreversible to protect PHI. The correct answer is <strong>c)</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="29" data-correct="b">
                            <div class="question-text">29. You're preparing a research dataset. Original data shows ages: "23, 45, 67, 89, 91, 34, 52, 93". Which ages must be aggregated under HIPAA Safe Harbor?</div>
                            <ul class="options">
                                <li class="option" data-answer="a" tabindex="0">a) All ages must be converted to ranges</li>
                                <li class="option" data-answer="b" tabindex="0">b) Only ages 91 and 93 - aggregate to "90+"</li>
                                <li class="option" data-answer="c" tabindex="0">c) Only age 89 needs aggregation</li>
                                <li class="option" data-answer="d" tabindex="0">d) No aggregation needed - ages are not identifiers</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> Safe Harbor requires ages over 89 to be aggregated (e.g., "90+") because they're rare and potentially identifying.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> HIPAA Safe Harbor requires ages >89 to be aggregated. The correct answer is <strong>b) Only ages 91 and 93</strong>.
                            </div>
                        </div>
                    </div>

                    <div class="subsection-nav">
                        <button class="btn btn-secondary subsection-nav-btn" onclick="prevModule4Subsection()">
                            ← Previous: Core Principles
                        </button>
                        <div style="color: #6c757d; font-weight: bold;">Section 2 of 3</div>
                        <button class="btn btn-primary subsection-nav-btn" onclick="nextModule4Subsection()">
                            Next: BAA Understanding →
                        </button>
                    </div>
                </div>

                <!-- Subsection 4c: BAA Understanding (NEW) -->
                <div class="module-subsection" id="subsection-m4-baa">
                    <div style="background: #e8f4fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3498db;">
                        <strong style="color: #2980b9;">🔍 Current Section: 3. BAA Understanding for Technical Teams (~8-10 min) 🆕</strong>
                    </div>

                    <div class="content-section">
                        <h3>⚖️ What Techies Get Wrong About BAAs</h3>
                        <p><strong>Business Associate Agreements (BAAs)</strong> are contracts required under HIPAA, but technical teams often misunderstand what they actually mean for day-to-day work.</p>
                    </div>

                    <div class="alert alert-danger">
                        <strong>🚨 Critical: You Need to Understand TWO Sides of BAAs</strong>
                        <ul style="margin-top: 0.5rem; padding-left: 2rem;">
                            <li><strong>Downstream:</strong> BAAs with vendors (Cloud Service Providers [AWS, GCP, Azure], Logging Platforms [Splunk, Cloudwatch,Datadog]) and their limitations</li>
                            <li><strong>Upstream:</strong> YOUR obligations as a Business Associate to covered entities</li>
                        </ul>
                    </div>

                    <div class="content-section">
                        <h3>Part 1: Vendor BAAs (Downstream) - What Coverage Actually Means</h3>
                        
                        <div class="scenario-box" style="border-left-color: #e74c3c;">
                            <h4>❌ Myth #1: "We have a BAA with AWS = PHI anywhere in AWS is fine"</h4>
                            <p><strong>Reality:</strong> BAAs are often <em>service-specific</em>. Your BAA might cover S3 and RDS, but NOT CloudWatch Logs, Elasticsearch, or third-party integrations.</p>
                            <p><strong>What you must check:</strong></p>
                            <ul>
                                <li>Which specific AWS services are in-scope?</li>
                                <li>Are there configuration requirements? (e.g., encryption at rest)</li>
                                <li>What about logs sent to CloudWatch? Are they covered?</li>
                                <li>Can you use AWS Lambda with PHI? Check the BAA.</li>
                            </ul>
                        </div>

                        <div class="scenario-box" style="border-left-color: #e74c3c;">
                            <h4>❌ Myth #2: "The vendor has HIPAA certification = we're covered"</h4>
                            <p><strong>Reality:</strong> There's no such thing as "HIPAA certified." Vendors can be "HIPAA compliant," but YOU still need a signed BAA and proper technical controls.</p>
                            <p><strong>What you must verify:</strong></p>
                            <ul>
                                <li>Do we have a <em>signed</em> BAA on file? (Not just vendor claiming compliance)</li>
                                <li>Does it cover our specific use case? (Development? Production? Both?)</li>
                                <li>Are WE implementing required technical safeguards on our end?</li>
                            </ul>
                        </div>

                        <div class="scenario-box" style="border-left-color: #e74c3c;">
                            <h4>❌ Myth #3: "A BAA means the vendor is responsible if something goes wrong"</h4>
                            <p><strong>Reality:</strong> BAAs create <em>shared responsibility</em>. The vendor handles their infrastructure security, but YOU are responsible for:</p>
                            <ul>
                                <li>How you configure the service</li>
                                <li>What data you put into it</li>
                                <li>Access controls you implement</li>
                                <li>Your application's security</li>
                            </ul>
                            <p><strong>Example:</strong> AWS has a BAA, but if you store PHI in an S3 bucket with public read access, that's YOUR breach, not Amazon's.</p>
                        </div>
                    </div>

                    <div class="content-section" style="margin-top: 3rem;">
                        <h3>Part 2: YOUR Role as a Business Associate (Upstream) - Your Obligations</h3>
                        
                        <div class="alert alert-warning">
                            <strong>⚠️ Most Overlooked Fact:</strong> If you're building software for a hospital, clinic, or health system, <em>your company is likely a Business Associate</em> under HIPAA. This means YOU have direct legal obligations.
                        </div>

                        <div class="scenario-box">
                            <h4>Understanding the Compliance Chain</h4>
                            <div class="code-example">Covered Entity (Hospital/Clinic)
    ↓ [BAA - defines OUR obligations]
YOUR COMPANY (Business Associate)
    ↓ [BAA with vendor - their obligations]
AWS/Datadog/Other Vendors (Sub-processor)</div>
                        </div>

                        <div class="content-section">
                            <h3>What "Being a Business Associate" Means for Technical Teams</h3>
                            
                            <div class="scenario-box">
                                <h4>1. Technical Safeguards Are YOUR Responsibility</h4>
                                <p>Your BAA with the covered entity requires you to implement:</p>
                                <ul>
                                    <li><strong>Encryption:</strong> PHI at rest and in transit</li>
                                    <li><strong>Access Controls:</strong> Role-based access, audit logs</li>
                                    <li><strong>Audit Trails:</strong> Who accessed what PHI and when</li>
                                    <li><strong>Secure Development:</strong> No PHI in dev/test without de-identification</li>
                                    <li><strong>Incident Response:</strong> Report breaches within contractual timeframe (often 24-72 hours)</li>
                                </ul>
                            </div>

                            <div class="scenario-box">
                                <h4>2. Your Technical Decisions Impact Compliance</h4>
                                <p><strong>Questions you must answer:</strong></p>
                                <ul>
                                    <li>Does this architecture meet OUR BA obligations?</li>
                                    <li>Can we demonstrate technical safeguards in an audit?</li>
                                    <li>What happens if we have a security incident?</li>
                                    <li>Do we have proper logging to support incident investigation?</li>
                                    <li>Are we using vendors with proper BAAs in place?</li>
                                </ul>
                            </div>

                            <div class="scenario-box" style="border-left-color: #e74c3c;">
                                <h4>❌ What NOT to Assume</h4>
                                <ul>
                                    <li><strong>❌ "Legal handles compliance"</strong> → Technical teams implement the actual controls</li>
                                    <li><strong>❌ "Production is compliant, so dev is fine"</strong> → Development environments need same protections or de-identified data</li>
                                    <li><strong>❌ "We can fix it if there's a breach"</strong> → Breaches must be reported immediately, can result in penalties and loss of trust</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="content-section" style="margin-top: 3rem;">
                        <h3>🛠️ Technical Questions Checklist for ANY New Tool/Service</h3>
                        
                        <div class="scenario-box">
                            <h4>Before Using Any Tool with PHI, Ask:</h4>
                            <table class="comparison-table" style="font-size: 0.9rem;">
                                <thead>
                                    <tr>
                                        <th style="width: 40%;">Question</th>
                                        <th>Why It Matters</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>1. Do we have a signed BAA?</strong></td>
                                        <td>No BAA = cannot use with PHI, period</td>
                                    </tr>
                                    <tr>
                                        <td><strong>2. What services does BAA cover?</strong></td>
                                        <td>May only cover specific features/tiers</td>
                                    </tr>
                                    <tr>
                                        <td><strong>3. What configuration is required?</strong></td>
                                        <td>Encryption, private networks, access controls</td>
                                    </tr>
                                    <tr>
                                        <td><strong>4. Where does data get stored?</strong></td>
                                        <td>Geographic/regulatory requirements</td>
                                    </tr>
                                    <tr>
                                        <td><strong>5. What happens to our data when contract ends?</strong></td>
                                        <td>Data deletion obligations under BA agreement</td>
                                    </tr>
                                    <tr>
                                        <td><strong>6. How do we fulfill OUR obligations?</strong></td>
                                        <td>Your BA agreement with covered entity</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3>🎯 Real-World Scenario: Evaluating a New Tool</h3>
                        
                        <div class="scenario-box" style="background: #fff3cd; border-left-color: #ffc107;">
                            <h4>Scenario: Developer wants to use Datadog for application monitoring</h4>
                            
                            <p><strong>❌ Wrong Approach:</strong></p>
                            <p style="font-style: italic;">"Datadog is HIPAA compliant, so I'll just add it to our stack."</p>
                            
                            <p style="margin-top: 1.5rem;"><strong>✅ Right Approach - Technical Questions:</strong></p>
                            <ol style="padding-left: 1.5rem; margin-top: 0.5rem; line-height: 1.8;">
                                <li>☑️ Does our company have a signed BAA with Datadog?</li>
                                <li>☑️ Does our Datadog plan tier include BAA coverage? (often enterprise-only)</li>
                                <li>☑️ What will our application logs contain?
                                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                        <li>If PHI → Need BAA + proper configuration</li>
                                        <li>If only hashed IDs with no PHI → May not need BAA</li>
                                    </ul>
                                </li>
                                <li>☑️ Does Datadog APM tracing capture request parameters? (Could expose PHI)</li>
                                <li>☑️ What's our retention policy? Does it align with our BA obligations?</li>
                                <li>☑️ How do we ensure our dev team doesn't accidentally log PHI?</li>
                                <li>☑️ If we have an incident, how do we pull audit logs from Datadog to fulfill our reporting obligations?</li>
                            </ol>
                        </div>
                    </div>

                    <div class="content-section" style="margin-top: 2rem; padding: 1.5rem; background: #e8f4fd; border-radius: 8px;">
                        <h3>🎯 BAA Key Takeaways</h3>
                        <ul>
                            <li><strong>Two-Way Obligations:</strong> Vendor BAAs (downstream) AND your BA obligations (upstream)</li>
                            <li><strong>Service-Specific Coverage:</strong> BAAs often don't cover all services/features</li>
                            <li><strong>No "HIPAA Certification":</strong> Verify signed BAA, don't trust marketing claims</li>
                            <li><strong>Shared Responsibility:</strong> Vendor secures infrastructure, YOU secure configuration and usage</li>
                            <li><strong>Technical Teams Implement Controls:</strong> Legal signs BAA, but YOU make it real</li>
                            <li><strong>Always Ask Questions:</strong> Use technical checklist before any new tool</li>
                        </ul>
                    </div>

                    <div class="exercise">
                        <div class="exercise-header">
                            <div class="exercise-title">Exercise 4.1c: BAA Understanding & Application</div>
                        </div>

                        <div class="question" data-question="30" data-correct="c">
                            <div class="question-text">30. Production API serving actual patient medication data is failing - need to debug immediately to meet SLA. Which approach?</div>
                            <ul class="options">
                                <li class="option" data-answer="a" tabindex="0">a) Copy production logs to ChatGPT for analysis</li>
                                <li class="option" data-answer="b" tabindex="0">b) Use synthetic data with BAA-approved AI</li>
                                <li class="option" data-answer="c" tabindex="0">c) Debug using approved internal tools only with proper access controls</li>
                                <li class="option" data-answer="d" tabindex="0">d) Ask colleague to use their personal AI tools</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> When debugging production systems with actual PHI, only use approved internal tools with proper access controls and audit trails.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> Production PHI requires approved internal tools with proper access controls. The correct answer is <strong>c)</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="31" data-correct="d">
                            <div class="question-text">31. Your company has a BAA with AWS. You want to use AWS Lambda to process patient appointment reminders. What must you verify before implementation?</div>
                            <ul class="options">
                                <li class="option" data-answer="a" tabindex="0">a) Nothing - BAA covers all AWS services</li>
                                <li class="option" data-answer="b" tabindex="0">b) Just that Lambda is encrypted</li>
                                <li class="option" data-answer="c" tabindex="0">c) Only that our security team approves</li>
                                <li class="option" data-answer="d" tabindex="0">d) That Lambda is specifically covered in our BAA and meets configuration requirements</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> BAAs are service-specific. You must verify Lambda is explicitly covered and understand any required configurations (encryption, VPC, logs).
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> BAAs are service-specific - verify Lambda is explicitly covered. The correct answer is <strong>d)</strong>.
                            </div>
                        </div>

                        <div class="question" data-question="32" data-correct="b">
                            <div class="question-text">32. A vendor claims their monitoring tool is "HIPAA compliant and certified." As a technical lead, what's your response?</div>
                            <ul class="options">
                                <li class="option" data-answer="a" tabindex="0">a) Great! Start integration immediately</li>
                                <li class="option" data-answer="b" tabindex="0">b) Verify: Do WE have a signed BAA? What configuration is required? What's covered?</li>
                                <li class="option" data-answer="c" tabindex="0">c) Check if they have SOC 2 certification</li>
                                <li class="option" data-answer="d" tabindex="0">d) As long as legal approved, technical team can proceed</li>
                            </ul>
                            <div class="feedback correct">
                                <strong>Correct!</strong> "HIPAA certified" doesn't exist. Always verify signed BAA, understand coverage, and confirm technical requirements.
                            </div>
                            <div class="feedback incorrect">
                                <strong>Incorrect.</strong> No such thing as "HIPAA certified." Must verify signed BAA and technical requirements. The correct answer is <strong>b)</strong>.
                            </div>
                        </div>
                    </div>

                    <div class="subsection-nav">
                        <button class="btn btn-secondary subsection-nav-btn" onclick="prevModule4Subsection()">
                            ← Previous: De-Identification
                        </button>
                        <div style="color: #6c757d; font-weight: bold;">Section 3 of 3 <span style="color: #27ae60;">✓</span> Complete</div>
                        <button class="btn btn-success subsection-nav-btn" onclick="nextModule()">
                            Complete Module 4 → Continue
                        </button>
                    </div>
                </div>

                <!-- Exercise 4.1 - After all subsections -->
                <div class="module-subsection" id="subsection-m4-exercise" style="display: none;">
                    <!-- This subsection removed in v2.3 - exercises moved to individual subsections -->
                </div>
            </div>

            <!-- Module 5: Incident Response -->
            <div class="module" id="module-5">
                <div class="module-header">
                    <div class="module-title">Module 5: Incident Response & Mistakes</div>
                    <p>Duration: 8-10 minutes</p>
                </div>

                <div class="alert alert-danger">
                    <strong>Golden Rule:</strong> Never try to "quietly fix" a PHI exposure. Always report immediately.
                </div>

                <div class="content-section">
                    <h3>Incident Response Timeline</h3>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <h4>Step 1: DISCOVER (0-30 min)</h4>
                                <ul>
                                    <li>Stop ongoing exposure</li>
                                    <li>Preserve evidence (don't delete)</li>
                                    <li>Notify manager and security team</li>
                                </ul>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <h4>Step 2: CONTAIN (30 min-2 hrs)</h4>
                                <ul>
                                    <li>Determine scope and timeline</li>
                                    <li>Document exposure method</li>
                                    <li>Identify who had access</li>
                                </ul>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <h4>Step 3: REPORT (2-24 hrs)</h4>
                                <ul>
                                    <li>Internal: Security, Legal, Compliance</li>
                                    <li>External: May require regulatory notification</li>
                                    <li>Timeline: 24-72 hours for most regulations</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exercise">
                    <div class="exercise-header">
                        <div class="exercise-title">Incident Response Scenarios</div>
                        <p>You discover yesterday's backup script uploaded patient emails + appointment types to shared Google Drive (50 people have access).</p>
                    </div>

                    <div class="question" data-question="33" data-correct="c">
                        <div class="question-text">33. Your immediate action?</div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) Delete file and hope no one noticed</li>
                            <li class="option" data-answer="b" tabindex="0">b) Move to private folder and assess</li>
                            <li class="option" data-answer="c" tabindex="0">c) Stop backup processes and report immediately</li>
                            <li class="option" data-answer="d" tabindex="0">d) Check if anyone downloaded first</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Stop ongoing exposure immediately and report. Never handle PHI incidents quietly.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Stop exposure and report immediately. The correct answer is <strong>c)</strong>.
                        </div>
                    </div>

                    <div class="question" data-question="34" data-correct="b">
                        <div class="question-text">34. During investigation, you find PHI in application logs from 2 weeks ago. What should you do with the logs?</div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) Delete the logs immediately to eliminate the exposure</li>
                            <li class="option" data-answer="b" tabindex="0">b) Preserve logs as evidence and notify security team</li>
                            <li class="option" data-answer="c" tabindex="0">c) Manually edit logs to remove PHI, then save</li>
                            <li class="option" data-answer="d" tabindex="0">d) Move logs to encrypted folder and continue investigation alone</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Never delete or modify evidence. Preserve everything and let security/compliance teams determine proper handling.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Evidence must be preserved unmodified for investigation. The correct answer is <strong>b)</strong>.
                        </div>
                    </div>

                    <div class="question" data-question="35" data-correct="a">
                        <div class="question-text">35. You accidentally sent an email with patient diagnosis to wrong recipient (another patient). Who do you contact first?</div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) Your manager and IT security immediately</li>
                            <li class="option" data-answer="b" tabindex="0">b) Send follow-up email asking recipient to delete it</li>
                            <li class="option" data-answer="c" tabindex="0">c) Contact the email recipient to apologize first</li>
                            <li class="option" data-answer="d" tabindex="0">d) Wait to see if recipient responds before escalating</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> Immediately escalate to management and security. They will coordinate proper response including patient notification and documentation.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Never try to handle PHI breaches yourself. Escalate immediately to management and security. The correct answer is <strong>a)</strong>.
                        </div>
                    </div>

                    <div class="question" data-question="36" data-correct="c">
                        <div class="question-text">36. While reviewing old Slack messages, you find PHI was shared in a public channel 6 months ago. What now?</div>
                        <ul class="options">
                            <li class="option" data-answer="a" tabindex="0">a) Too old to matter - no action needed</li>
                            <li class="option" data-answer="b" tabindex="0">b) Delete the Slack message and move on</li>
                            <li class="option" data-answer="c" tabindex="0">c) Report immediately regardless of when it occurred</li>
                            <li class="option" data-answer="d" tabindex="0">d) Document it yourself for next week's team meeting</li>
                        </ul>
                        <div class="feedback correct">
                            <strong>Correct!</strong> PHI incidents must be reported immediately regardless of when they occurred. Timeline matters for compliance reporting.
                        </div>
                        <div class="feedback incorrect">
                            <strong>Incorrect.</strong> Report all PHI exposures immediately, no matter how old. The correct answer is <strong>c)</strong>.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Module 6: GenAI -->
<div class="module" id="module-6">
    <div class="module-header">
        <div class="module-title">Module 6: Generative AI in Healthcare Workflows</div>
        <p>Duration: 12-15 minutes</p>
    </div>

    <div class="alert alert-warning">
        <strong>Critical Reality:</strong> AI tools are transforming development workflows, but most popular AI assistants have NO Business Associate Agreements and cannot be used with PHI.
    </div>

    <div class="content-section">
        <h3>🤖 The AI Tool Landscape: What Developers Need to Know</h3>
        <p>Generative AI has become essential for modern development, but healthcare developers face unique constraints. Understanding which tools you can use <b>and how to use them safely</b> is critical.</p>
    </div>

    <div class="content-section">
        <h3>Understanding the Three Categories of AI Tools</h3>
        
        <table class="comparison-table">
            <thead>
                <tr>
                    <th style="width: 25%;">Category</th>
                    <th style="width: 35%;">Examples</th>
                    <th style="width: 20%;">BAA Available?</th>
                    <th style="width: 20%;">Safe for PHI?</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Public/Consumer AI</strong></td>
                    <td>ChatGPT Free/Plus, Claude.ai, Gemini, Perplexity (personal accounts)</td>
                    <td><span style="color: #e74c3c;">❌ No</span></td>
                    <td><span style="color: #e74c3c;">❌ Never</span></td>
                </tr>
                <tr>
                    <td><strong>Enterprise AI Platforms</strong></td>
                    <td>ChatGPT Enterprise, Claude for Enterprise, Azure OpenAI</td>
                    <td><span style="color: #27ae60;">✅ Yes (if configured)</span></td>
                    <td><span style="color: #f39c12;">⚠️ Only with BAA + proper setup</span></td>
                </tr>
                <tr>
                    <td><strong>Development AI Tools</strong></td>
                    <td>GitHub Copilot, Cursor, JetBrains AI, Tabnine, Codeium</td>
                    <td><span style="color: #f39c12;">⚠️ Varies by tier</span></td>
                    <td><span style="color: #f39c12;">⚠️ Depends on version + config</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="content-section">
        <h3>🛠️ Development AI Tools: The Tricky Middle Ground</h3>
        <p>Code completion and AI coding assistants present unique challenges because they operate <em>inside your development environment</em>, seeing your code, comments, variable names, and potentially sensitive data.</p>
        
        <div class="scenario-box">
            <h4>Common Development AI Tools & Their PHI Risks</h4>
            
            <div style="margin: 1rem 0;">
                <strong style="color: #2980b9;">GitHub Copilot</strong>
                <ul>
                    <li><strong>Individual/Pro:</strong> ❌ No BAA - data may be used for training</li>
                    <li><strong>Business/Enterprise:</strong> ⚠️ BAA available, but requires proper configuration</li>
                    <li><strong>Risk:</strong> Sends code context to cloud for suggestions</li>
                </ul>
            </div>

            <div style="margin: 1rem 0;">
                <strong style="color: #2980b9;">Cursor AI</strong>
                <ul>
                    <li><strong>Free/Pro:</strong> ❌ No BAA available</li>
                    <li><strong>Business:</strong> ⚠️ Check with your organization - BAA status varies</li>
                    <li><strong>Risk:</strong> Full codebase access, can read open files and project structure</li>
                </ul>
            </div>

            <div style="margin: 1rem 0;">
                <strong style="color: #2980b9;">JetBrains AI Assistant</strong>
                <ul>
                    <li><strong>Individual:</strong> ❌ No BAA</li>
                    <li><strong>Enterprise:</strong> ⚠️ Potential BAA available - verify with IT</li>
                    <li><strong>Risk:</strong> Code completion sees variable names, function signatures, comments</li>
                </ul>
            </div>

            <div style="margin: 1rem 0;">
                <strong style="color: #2980b9;">Tabnine</strong>
                <ul>
                    <li><strong>Cloud versions:</strong> ❌ Typically no BAA for standard tiers</li>
                    <li><strong>Self-hosted Enterprise:</strong> ✅ Can be configured safely (runs on your infrastructure)</li>
                    <li><strong>Advantage:</strong> Offers true local-only options</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="content-section">
        <h3>⚠️ What AI Tools Can "See" in Your Development Environment</h3>
        
        <div class="scenario-box" style="border-left-color: #e74c3c;">
            <h4>❌ Common Dangerous Exposures</h4>
            
            <div class="code-example">
<span class="comment">// AI sees this entire file when providing suggestions:</span>

<span class="keyword">const</span> patientData = {
    email: <span class="string">"sarah.jones@email.com"</span>,  <span class="comment">// ❌ PII visible to AI</span>
    diagnosis: <span class="string">"Type 2 Diabetes"</span>,      <span class="comment">// ❌ Health data visible</span>
    medications: [<span class="string">"Metformin"</span>, <span class="string">"Insulin"</span>] <span class="comment">// ❌ PHI context visible</span>
};

<span class="comment">// Even variable names expose PHI context:</span>
<span class="keyword">function</span> getPatientInsulinDosage(patientId) { <span class="comment">// ❌ Function name reveals health context</span>
    <span class="keyword">return</span> database.query(
        <span class="string">"SELECT dosage FROM diabetes_treatments WHERE patient_id = ?"</span>,
        [patientId]  <span class="comment">// ❌ Query structure reveals PHI schema</span>
    );
}</div>
            
            <p style="margin-top: 1rem; color: #721c24;"><strong>What the AI learns from this code:</strong></p>
            <ul style="color: #721c24;">
                <li>Your database schema for patient health data</li>
                <li>Field names and relationships</li>
                <li>Business logic around medication and diagnoses</li>
                <li>API structures for accessing PHI</li>
                <li>Even with generic IDs, the context reveals healthcare operations</li>
            </ul>
        </div>
    </div>

    <div class="content-section">
        <h3>✅ Best Practices for Using AI Development Tools Safely</h3>
        
        <div class="scenario-box">
            <h4>Strategy 1: Environment Separation</h4>
            <p><strong>Create PHI-free development zones</strong></p>
            <ul>
                <li>✅ Use AI tools ONLY in non-production, de-identified environments</li>
                <li>✅ Disable AI assistants when working on repositories with real PHI</li>
                <li>✅ Create separate IDE profiles: "Healthcare (AI Off)" vs "General Development (AI On)"</li>
                <li>✅ Use synthetic data generators for all development and testing</li>
            </ul>
            
            <div class="code-example">
<span class="comment">// ✅ Safe for AI tools - synthetic data, generic context</span>

<span class="keyword">const</span> testUser = {
    id: generateUUID(),           <span class="comment">// ✅ Random, not real</span>
    email: faker.internet.email(), <span class="comment">// ✅ Synthetic</span>
    metadata: { enrolled: <span class="keyword">true</span> }  <span class="comment">// ✅ No health context</span>
};

<span class="keyword">function</span> processUserAction(userId, action) {
    <span class="comment">// ✅ Generic naming, no PHI context revealed</span>
    <span class="keyword">return</span> dataService.update(userId, action);
}</div>
        </div>

        <div class="scenario-box">
            <h4>Strategy 2: Configuration & Access Control</h4>
            <p><strong>Lock down AI tool access to sensitive repos</strong></p>
            <ul>
                <li>✅ Use <code>.gitignore</code>-style rules to exclude PHI-containing files from AI indexing</li>
                <li>✅ Configure IDE to disable AI features in specific project directories</li>
                <li>✅ Set up workspace-level AI settings, not just user preferences</li>
                <li>✅ Require manual opt-in for AI on healthcare projects (never auto-enable)</li>
            </ul>
            
            <div class="code-example">
<span class="comment">// Example: .cursorignore or IDE settings</span>

<span class="comment"># Exclude from AI assistant context</span>
**/patient_data/**
**/phi_exports/**
**/*patient*.sql
**/*medical*.json
**/prod_configs/**
.env.production</div>
        </div>

        <div class="scenario-box">
            <h4>Strategy 3: Code Review & Awareness</h4>
            <p><strong>Build organizational safeguards</strong></p>
            <ul>
                <li>✅ Include "AI tool usage" in code review checklists</li>
                <li>✅ Document which repos/projects allow AI assistance</li>
                <li>✅ Train team on recognizing PHI exposure through AI suggestions</li>
                <li>✅ Implement pre-commit hooks to detect potential PHI before it reaches AI tools</li>
            </ul>
        </div>
    </div>

    <div class="content-section">
        <h3>🎯 Decision Tree: Can I Use This AI Tool?</h3>
        
        <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
            <h4 style="color: #856404; margin-bottom: 1rem;">Before Using ANY AI Tool, Ask:</h4>
            
            <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 6px;">
                <strong>Question 1: Will this tool access ANY of the following?</strong>
                <ul style="margin-top: 0.5rem; padding-left: 2rem">
                    <li>Code that processes patient data</li>
                    <li>Database schemas with PHI fields</li>
                    <li>API endpoints serving health information</li>
                    <li>Configuration files with production credentials</li>
                    <li>Test data that might contain real PHI</li>
                </ul>
                <p style="margin-top: 0.5rem;"><strong>If YES →</strong> Continue to Question 2<br>
                <strong>If NO →</strong> Safe to use (with normal security practices)</p>
            </div>

            <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 6px;">
                <strong>Question 2: Does your organization have a signed BAA with this tool?</strong>
                <p style="margin-top: 0.5rem;"><strong>If NO →</strong> ❌ CANNOT USE with healthcare code<br>
                <strong>If YES →</strong> Continue to Question 3</p>
            </div>

            <div style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 6px;">
                <strong>Question 3: Is the tool properly configured per BAA requirements?</strong>
                <ul style="margin-top: 0.5rem;">
                    <li>✓ Enterprise tier with data isolation enabled?</li>
                    <li>✓ Training data opt-out configured?</li>
                    <li>✓ Audit logging enabled?</li>
                    <li>✓ Geographic data residency requirements met?</li>
                </ul>
                <p style="margin-top: 0.5rem;"><strong>If ALL YES →</strong> ✅ MAY use per organizational policy<br>
                <strong>If ANY NO →</strong> ❌ CANNOT USE until properly configured</p>
            </div>
        </div>
    </div>

    <div class="content-section">
        <h3>📋 Organizational Policy Recommendations</h3>
        
        <div class="scenario-box">
            <h4>What Your Organization Should Define</h4>
            <table class="comparison-table" style="font-size: 0.9rem;">
                <thead>
                    <tr>
                        <th>Policy Area</th>
                        <th>Key Questions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Approved Tools</strong></td>
                        <td>
                            • Which AI tools have BAAs?<br>
                            • What tiers/versions are approved?<br>
                            • How often is this list updated?
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Repository Classification</strong></td>
                        <td>
                            • Which repos contain PHI/healthcare logic?<br>
                            • How are they tagged/labeled?<br>
                            • Different rules for frontend vs backend?
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Developer Workflow</strong></td>
                        <td>
                            • How to request AI tool access?<br>
                            • Mandatory training requirements?<br>
                            • Consequences for policy violations?
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Incident Response</strong></td>
                        <td>
                            • What if PHI is accidentally sent to AI?<br>
                            • Reporting process?<br>
                            • Remediation steps?
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="content-section" style="margin-top: 2rem; padding: 1.5rem; background: #e8f4fd; border-radius: 8px;">
        <h3>🎯 Module 6 Key Takeaways</h3>
        <ul>
            <li><strong>Not All AI Tools Are Equal:</strong> Consumer vs Enterprise vs Development tools have different BAA availability</li>
            <li><strong>AI Sees Your Context:</strong> Code completion tools access variable names, comments, file structure, and database schemas</li>
            <li><strong>Enterprise ≠ Automatic Safety:</strong> Even with BAAs, tools must be properly configured</li>
            <li><strong>Development Tools Are High Risk:</strong> Cursor, Copilot, JetBrains AI operate inside your codebase</li>
            <li><strong>Separation Is Key:</strong> Use AI only in non-PHI environments with synthetic data</li>
            <li><strong>When In Doubt, Ask:</strong> Check with IT/Security before using any new AI tool on healthcare projects</li>
        </ul>
    </div>

    <div class="exercise">
        <div class="exercise-header">
            <div class="exercise-title">Exercise 6.1: GenAI Safety & Compliance</div>
        </div>

        <div class="question" data-question="37" data-correct="d">
            <div class="question-text">37. You're debugging a query issue and want to ask ChatGPT: "Debug this: SELECT patient_name, diagnosis FROM patients WHERE id = 12345" - Is this safe?</div>
            <ul class="options">
                <li class="option" data-answer="a" tabindex="0">a) Safe - it's just SQL syntax with no actual data</li>
                <li class="option" data-answer="b" tabindex="0">b) Safe if you remove the patient ID number first</li>
                <li class="option" data-answer="c" tabindex="0">c) Safe if you anonymize table names to generic_table</li>
                <li class="option" data-answer="d" tabindex="0">d) Unsafe - query reveals PHI structure and identifiers</li>
            </ul>
            <div class="feedback correct">
                <strong>Correct!</strong> The query structure reveals PHI schema (patient_name, diagnosis fields), table relationships, and patient ID format. This exposes your healthcare data model to a public AI without a BAA.
            </div>
            <div class="feedback incorrect">
                <strong>Incorrect.</strong> The query reveals PHI structure (patient_name, diagnosis fields), table relationships, and ID formats. Even without real data, this exposes your healthcare data model. The correct answer is <strong>d)</strong>.
            </div>
        </div>

        <div class="question" data-question="38" data-correct="a">
            <div class="question-text">38. You ask public ChatGPT: "What are best practices for HIPAA compliance in API design?" (sharing no company code or PHI) - Is this safe?</div>
            <ul class="options">
                <li class="option" data-answer="a" tabindex="0">a) Safe - general knowledge question with no PHI or proprietary information</li>
                <li class="option" data-answer="b" tabindex="0">b) Unsafe - HIPAA topic implies PHI work</li>
                <li class="option" data-answer="c" tabindex="0">c) Unsafe - must use BAA-approved AI only for any healthcare topics</li>
                <li class="option" data-answer="d" tabindex="0">d) Safe only if using personal email, not work email</li>
            </ul>
            <div class="feedback correct">
                <strong>Correct!</strong> Asking general knowledge questions about compliance, security best practices, or healthcare regulations is safe when you share no PHI, company data, code, or proprietary information. This is like reading a HIPAA compliance guide.
            </div>
            <div class="feedback incorrect">
                <strong>Incorrect.</strong> General knowledge questions with no PHI, company data, or proprietary information are safe. This is like asking about publicly available compliance information. The correct answer is <strong>a)</strong>.
            </div>
        </div>

        <div class="question" data-question="39" data-correct="c">
            <div class="question-text">39. Your team wants to enable GitHub Copilot for a repository containing patient appointment scheduling logic. The code uses synthetic test data but has real database schema and PHI field names. What's required?</div>
            <ul class="options">
                <li class="option" data-answer="a" tabindex="0">a) GitHub Copilot Individual is fine - test data is synthetic</li>
                <li class="option" data-answer="b" tabindex="0">b) Any paid Copilot tier is acceptable since no real PHI exists</li>
                <li class="option" data-answer="c" tabindex="0">c) Must use GitHub Copilot Enterprise with BAA and verify proper configuration</li>
                <li class="option" data-answer="d" tabindex="0">d) Copilot is safe as long as developers don't commit PHI to the repo</li>
            </ul>
            <div class="feedback correct">
                <strong>Correct!</strong> Even with synthetic data, real PHI database schemas, field names, and healthcare business logic constitute proprietary healthcare system information. Copilot Enterprise with proper BAA and configuration is required for healthcare repositories.
            </div>
            <div class="feedback incorrect">
                <strong>Incorrect.</strong> Database schemas and PHI field structures are sensitive even without real data. Healthcare repos require Copilot Enterprise with proper BAA. The correct answer is <strong>c)</strong>.
            </div>
        </div>

        <div class="question" data-question="40" data-correct="a">
            <div class="question-text">40. While working, you accidentally paste "Patient sarah@email.com insulin dosage: 10mg" into ChatGPT before realizing your mistake. What should you do?</div>
            <ul class="options">
                <li class="option" data-answer="a" tabindex="0">a) Immediately stop, close ChatGPT, and report to IT security/compliance</li>
                <li class="option" data-answer="b" tabindex="0">b) Delete the message from ChatGPT and continue working</li>
                <li class="option" data-answer="c" tabindex="0">c) Edit the message to remove identifiers, then submit a corrected version</li>
                <li class="option" data-answer="d" tabindex="0">d) Log out of ChatGPT and delete your account</li>
            </ul>
            <div class="feedback correct">
                <strong>Correct!</strong> This is a reportable PHI exposure incident. Stop immediately, preserve evidence (don't delete), and escalate to IT security. They will coordinate proper response, documentation, and determine if regulatory notification is required.
            </div>
            <div class="feedback incorrect">
                <strong>Incorrect.</strong> Accidental PHI exposure to unauthorized systems must be reported immediately as a security incident. Never try to "fix it quietly." The correct answer is <strong>a)</strong>.
            </div>
        </div>
    </div>
</div>

            <!-- Module 7: Completion -->
            <div class="module" id="module-7">
                <div class="module-header">
                    <div class="module-title">Training Complete!</div>
                </div>

                <div class="completion-certificate" id="completionCertificate">
                    <div style="text-align: center; margin-bottom: 0.5rem;">
                        <div style="display: inline-block; padding: 0.3rem 1.5rem; background: rgba(255,255,255,0.2); border-radius: 8px; font-weight: bold; font-size: 1rem; letter-spacing: 2px;">
                            VITSO
                        </div>
                        <div style="font-size: 0.7rem; margin-top: 0.2rem; opacity: 0.9;">Healthcare Technology Compliance Training</div>
                    </div>
                    <div style="text-align: center; margin-bottom: 0.5rem; font-size: 1.5rem; color: rgba(255,255,255,0.8);">★ ★ ★</div>
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">🏆</div>
                    <h2 style="margin-bottom: 0.5rem;">Certificate of Completion</h2>
                    <p style="margin: 0.8rem 0; font-size: 1rem;">This certifies that</p>
                    <p id="userName" 
                       style="font-size: 1.8rem; margin: 0.5rem 0; cursor: pointer; text-decoration: underline; text-decoration-style: dotted; transition: all 0.3s ease; font-weight: bold; letter-spacing: 1px;" 
                       onclick="editUserName()"
                       title="Click to edit your name">
                       Participant
                    </p>
                    <p style="margin: 0.8rem 0; font-size: 1rem;"><span id="completionStatus">has successfully completed</span> the</p>
                    <h3 style="margin: 0.5rem 0; font-size: 1.3rem; font-weight: bold;">PHI/PII Identification & Handling Training v2.3<br>for Technical Teams</h3>
                    
                    <div class="score-display" id="finalScore"></div>
                    
                    <div style="margin: 1rem 0; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;"><strong>Digital Badge:</strong> PHI/PII Technical Compliance v2.3</p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;"><strong>Date of Completion:</strong> <span id="certDate"></span></p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;"><strong>Training Mode:</strong> <span id="certMode"></span></p>
                        <p style="margin: 0.3rem 0; font-size: 0.9rem;"><strong>Certificate Validity:</strong> 12 months</p>
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid rgba(255,255,255,0.3);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; max-width: 600px; margin: 0 auto;">
                            <div style="text-align: center;">
                                <div style="border-bottom: 2px solid white; padding: 0.3rem; margin-bottom: 0.3rem;">
                                    <span style="font-style: italic; font-family: 'Brush Script MT', cursive; font-size: 1.2rem;">Tom Smolinsky</span>
                                </div>
                                <p style="font-size: 0.8rem; margin: 0; font-weight: bold;">Tom Smolinsky, CISSP</p>
                                <p style="font-size: 0.75rem; margin: 0; opacity: 0.9;">Training Administrator</p>
                                <p style="font-size: 0.75rem; margin: 0; opacity: 0.9;">VITSO Healthcare Compliance</p>
                            </div>
                            <div style="text-align: center;">
                                <div style="border-bottom: 2px solid white; padding: 0.3rem; margin-bottom: 0.3rem;">
                                    <span id="certDate2"></span>
                                </div>
                                <p style="font-size: 0.8rem; margin: 0; font-weight: bold;">Date</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1rem; font-size: 1.5rem; color: rgba(255,255,255,0.8);">★ ★ ★</div>
                    
                    <div class="cert-actions">
                        <button class="btn btn-success" onclick="printCertificate()">🖨️ Print Certificate</button>
                        <button class="btn btn-secondary" onclick="resetTraining()">🔄 Retry Training</button>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 0.9rem;">
                        <strong>💡 Tip:</strong> Use your browser's "Print" dialog to save as PDF, then email or store the certificate for your records.
                    </div>
                </div>

                <div class="answer-key" id="answerKey" style="page-break-before: always;">
                    <h3 style="text-align: center; color: #2c3e50; margin-bottom: 1.5rem;">📊 Your Answer Review</h3>
                    <div id="answerKeyContent"></div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="btn btn-secondary" id="prevBtn" onclick="previousModule()" disabled>← Previous</button>
            <div>
                <span>Module </span>
                <span id="currentModuleDisplay">1</span>
                <span> of </span>
                <span id="totalModules">8</span>
            </div>
            <button class="btn btn-primary" id="nextBtn" onclick="nextModule()">Next →</button>
        </div>
    
        <footer id="license-footer">
            Code licensed under the <a href="LICENSE.HTML">MIT License</a>. Content licensed under
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. © 2025 VITSO - Tom Smolinsky, CISSP
        </footer>
    </div>

    <script>
        // ===== STATE MANAGEMENT =====
        const state = {
            currentModule: 0,
            mode: 'learn',
            answers: {},
            completedModules: new Set(),
            startTime: Date.now(),
            userName: '',
            module3Sections: new Set(['intro']),
            module4Sections: new Set(['m4-principles'])
        };

        // Correct answers - 40 QUESTIONS (Module 4 now has 8 questions across 3 subsections)
        const correctAnswers = {
            1: 'b', 2: 'c', 3: 'c', 4: 'b', 5: 'c', 6: 'c', 7: 'b',
            8: 'no', 9: 'yes', 10: 'yes', 11: 'no', 12: 'no', 13: 'yes',
            14: 'no', 15: 'yes', 16: 'no', 17: 'no', 18: 'yes', 19: 'yes',
            20: 'no', 21: 'yes', 22: 'yes', 23: 'no', 24: 'yes',
            25: 'c', 26: 'b', 27: 'b', 28: 'c', 29: 'b',
            30: 'c', 31: 'd', 32: 'b',
            33: 'c', 34: 'b', 35: 'a', 36: 'c',
            37: 'd', 38: 'a', 39: 'c', 40: 'a'
        };

        const allModule3Sections = ['intro', 'database', 'logging', 'inference', 'systems', 'safeharbor'];
        const allModule4Sections = ['m4-principles', 'm4-deidentification', 'm4-baa'];

        // ===== INITIALIZATION =====
        function init() {
            setupModuleNavigation();
            updateDisplay();
            setupEventListeners();
            loadUserName();
        }

        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowRight' && state.currentModule < getTotalModules() - 1) {
                    nextModule();
                } else if (e.key === 'ArrowLeft' && state.currentModule > 0) {
                    previousModule();
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('option')) {
                    handleQuestionClick(e);
                } else if (e.target.classList.contains('module-nav-item')) {
                    const index = parseInt(e.target.dataset.module);
                    if (!isNaN(index)) showModule(index);
                } else if (e.target.classList.contains('module-section-btn')) {
                    const section = e.target.dataset.section;
                    const module = e.target.dataset.module;
                    if (module === '4') {
                        showModule4Subsection(section);
                    } else {
                        showSubsection(section);
                    }
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('option')) {
                    handleQuestionClick(e);
                }
            });
        }

        function setupModuleNavigation() {
            const nav = document.getElementById('moduleNav');
            const totalMods = getTotalModules();
            nav.innerHTML = '';
            
            for (let i = 0; i < totalMods; i++) {
                const dot = document.createElement('div');
                dot.className = 'module-nav-item';
                if (i === 0) dot.classList.add('active');
                dot.dataset.module = i;
                dot.setAttribute('tabindex', '0');
                dot.setAttribute('aria-label', `Go to module ${i + 1}`);
                nav.appendChild(dot);
            }
        }

        function getTotalModules() {
            return document.querySelectorAll('.module').length;
        }

        // ===== USER NAME MANAGEMENT =====
        function updateUserName(name) {
            state.userName = name.trim();
            const certName = document.getElementById('userName');
            if (certName) {
                certName.textContent = state.userName || 'Participant';
            }
        }

        function editUserName() {
            const currentName = state.userName || '';
            const newName = prompt('Enter your name for the certificate:', currentName);
            if (newName !== null) {
                updateUserName(newName);
                const input = document.getElementById('userNameInput');
                if (input) {
                    input.value = newName;
                }
            }
        }

        function loadUserName() {
            const input = document.getElementById('userNameInput');
            if (input && input.value) {
                updateUserName(input.value);
            }
        }

        // ===== MODE MANAGEMENT =====
        function setMode(mode) {
            state.mode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            const msg = document.createElement('div');
            msg.className = mode === 'learn' ? 'alert alert-info' : 'alert alert-warning';
            msg.innerHTML = mode === 'learn' 
                ? '<strong>Learn Mode:</strong> You can change answers anytime.'
                : '<strong>Assessment Mode:</strong> Answers lock after submission.';
            msg.style.position = 'fixed';
            msg.style.top = '80px';
            msg.style.left = '50%';
            msg.style.transform = 'translateX(-50%)';
            msg.style.zIndex = '9999';
            msg.style.maxWidth = '90%';
            document.body.appendChild(msg);
            
            setTimeout(() => msg.remove(), 3000);
        }

        // ===== QUESTION HANDLING =====
        function handleQuestionClick(event) {
            const option = event.target;
            const question = option.closest('.question');
            const questionId = parseInt(question.dataset.question);
            const selectedAnswer = option.dataset.answer;
            const correctAnswer = question.dataset.correct;
            
            if (state.mode === 'assessment' && state.answers[questionId]) {
                return;
            }
            
            state.answers[questionId] = selectedAnswer;
            
            question.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
                if (state.mode === 'assessment' && state.answers[questionId]) {
                    opt.classList.add('disabled');
                }
            });
            
            option.classList.add('selected');
            
            const isCorrect = selectedAnswer === correctAnswer;
            if (isCorrect) {
                option.classList.add('correct');
                question.classList.add('correct-answered');
                question.classList.remove('incorrect-answered');
                showFeedback(question, true);
            } else {
                option.classList.add('incorrect');
                question.classList.add('incorrect-answered');
                question.classList.remove('correct-answered');
                showFeedback(question, false);
                
                question.querySelectorAll('.option').forEach(opt => {
                    if (opt.dataset.answer === correctAnswer) {
                        opt.classList.add('correct');
                    }
                });
            }
            
            updateProgress();
        }

        function showFeedback(question, isCorrect) {
            question.querySelectorAll('.feedback').forEach(fb => fb.style.display = 'none');
            const feedback = question.querySelector(`.feedback.${isCorrect ? 'correct' : 'incorrect'}`);
            if (feedback) feedback.style.display = 'block';
        }

        // ===== MODULE 3 SUBSECTION HANDLING =====
        function showSubsection(sectionId) {
            document.querySelectorAll('#module-3 .module-subsection').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(`subsection-${sectionId}`).classList.add('active');
            
            document.querySelectorAll('#module-3 .module-section-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`#module-3 [data-section="${sectionId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                // Save the subsection name for display in resume prompt
                state.currentModule3SubsectionName = activeBtn.textContent.trim();
            }
            
            if (state.currentModule === 3) {
                state.module3Sections.add(sectionId);
                updateModule3Progress();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextSubsection() {
            const currentIndex = allModule3Sections.findIndex(s => 
                document.getElementById(`subsection-${s}`).classList.contains('active')
            );
            
            if (currentIndex < allModule3Sections.length - 1) {
                showSubsection(allModule3Sections[currentIndex + 1]);
            }
        }

        function prevSubsection() {
            const currentIndex = allModule3Sections.findIndex(s => 
                document.getElementById(`subsection-${s}`).classList.contains('active')
            );
            
            if (currentIndex > 0) {
                showSubsection(allModule3Sections[currentIndex - 1]);
            }
        }

        function updateModule3Progress() {
            allModule3Sections.forEach(sectionId => {
                const btn = document.querySelector(`#module-3 [data-section="${sectionId}"]`);
                if (btn && state.module3Sections.has(sectionId)) {
                    btn.classList.add('viewed');
                }
            });
            
            updateNavigation();
        }

        // ===== MODULE 4 SUBSECTION HANDLING =====
        function showModule4Subsection(sectionId) {
            // Hide all Module 4 subsections
            document.querySelectorAll('#module-4 .module-subsection').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            
            // Show selected subsection
            const targetSection = document.getElementById(`subsection-${sectionId}`);
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
            }
            
            // Update button states
            document.querySelectorAll('#module-4 .module-section-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`#module-4 [data-section="${sectionId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                // Save the subsection name for display in resume prompt
                state.currentModule4SubsectionName = activeBtn.textContent.trim();
            }
            
            // Track viewed sections
            if (state.currentModule === 4) {
                state.module4Sections.add(sectionId);
                updateModule4Progress();
            }
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextModule4Subsection() {
            const currentIndex = allModule4Sections.findIndex(s => 
                document.getElementById(`subsection-${s}`).classList.contains('active')
            );
            
            if (currentIndex < allModule4Sections.length - 1) {
                showModule4Subsection(allModule4Sections[currentIndex + 1]);
            }
        }

        function prevModule4Subsection() {
            const currentIndex = allModule4Sections.findIndex(s => 
                document.getElementById(`subsection-${s}`).classList.contains('active')
            );
            
            if (currentIndex > 0) {
                showModule4Subsection(allModule4Sections[currentIndex - 1]);
            }
        }

        function updateModule4Progress() {
            allModule4Sections.forEach(sectionId => {
                const btn = document.querySelector(`#module-4 [data-section="${sectionId}"]`);
                if (btn && state.module4Sections.has(sectionId)) {
                    btn.classList.add('viewed');
                }
            });
            
            updateNavigation();
        }

        // ===== NAVIGATION =====
        function showModule(index) {
            const totalMods = getTotalModules();
            if (index < 0 || index >= totalMods) return;
            
            document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
            document.getElementById(`module-${index}`).classList.add('active');
            state.currentModule = index;
            
            if (index === 3) {
                showSubsection('intro');
            } else if (index === 4) {
                showModule4Subsection('m4-principles');
            }
            
            updateDisplay();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            if (index > 0) state.completedModules.add(index - 1);
            
            if (index === totalMods - 1) {
                showResults();
            }
        }

        function nextModule() {
            const totalMods = getTotalModules();
            
            if (state.currentModule === 3) {
                const allViewed = allModule3Sections.every(s => state.module3Sections.has(s));
                if (!allViewed) {
                    alert('Please complete all 6 subsections of Module 3 before continuing.');
                    return;
                }
            }
            
            if (state.currentModule === 4) {
                const allViewed = allModule4Sections.every(s => state.module4Sections.has(s));
                if (!allViewed) {
                    alert('Please complete all 3 subsections of Module 4 before continuing.');
                    return;
                }
            }
            
            if (state.currentModule < totalMods - 1) {
                showModule(state.currentModule + 1);
            }
        }

        function previousModule() {
            if (state.currentModule > 0) {
                showModule(state.currentModule - 1);
            }
        }

        function updateDisplay() {
            const totalMods = getTotalModules();
            
            const progress = Math.round(((state.currentModule + 1) / totalMods) * 100);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
            
            const footer = document.querySelector('.navigation');
            const moduleCounter = footer.querySelector('div:nth-child(2)');
            
            if (state.currentModule === 0) {
                footer.style.display = 'flex';
                moduleCounter.style.visibility = 'hidden';
            } else if (state.currentModule === 7) {
                footer.style.display = 'none';
            } else {
                footer.style.display = 'flex';
                moduleCounter.style.visibility = 'visible';
                document.getElementById('currentModuleDisplay').textContent = state.currentModule;
                document.getElementById('totalModules').textContent = '6';
            }
            
            updateNavigation();
            
            document.querySelectorAll('.module-nav-item').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i === state.currentModule) {
                    dot.classList.add('active');
                } else if (state.completedModules.has(i)) {
                    dot.classList.add('completed');
                }
            });
        }

        function updateNavigation() {
            document.getElementById('prevBtn').disabled = state.currentModule === 0;
            
            const nextBtn = document.getElementById('nextBtn');
            const totalMods = getTotalModules();
            
            if (state.currentModule === 3) {
                const allViewed = allModule3Sections.every(s => state.module3Sections.has(s));
                nextBtn.disabled = !allViewed;
                if (!allViewed) {
                    nextBtn.title = 'Complete all Module 3 sections to continue';
                } else {
                    nextBtn.title = '';
                }
            } else if (state.currentModule === 4) {
                const allViewed = allModule4Sections.every(s => state.module4Sections.has(s));
                nextBtn.disabled = !allViewed;
                if (!allViewed) {
                    nextBtn.title = 'Complete all Module 4 sections to continue';
                } else {
                    nextBtn.title = '';
                }
            } else {
                nextBtn.disabled = false;
                nextBtn.title = '';
            }
            
            if (state.currentModule === totalMods - 1) {
                nextBtn.textContent = 'View Results';
            } else {
                nextBtn.textContent = 'Next →';
            }
        }

        function updateProgress() {
            const totalQuestions = Object.keys(correctAnswers).length;
            const answeredQuestions = Object.keys(state.answers).length;
            const questionProgress = (answeredQuestions / totalQuestions) * 100;
            
            const moduleProgress = ((state.currentModule + 1) / getTotalModules()) * 50;
            const totalProgress = Math.round(moduleProgress + (questionProgress * 0.5));
            
            document.getElementById('progressFill').style.width = totalProgress + '%';
            document.getElementById('progressText').textContent = totalProgress + '%';
        }

        // ===== RESULTS & CERTIFICATE =====
        function showResults() {
            const score = calculateScore();
            generateAnswerKey();
            updateCertificate(score);
        }

        function calculateScore() {
            const totalQuestions = Object.keys(correctAnswers).length;
            let correctCount = 0;
            
            Object.keys(correctAnswers).forEach(qId => {
                if (state.answers[qId] === correctAnswers[qId]) {
                    correctCount++;
                }
            });
            
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            const passed = percentage >= 80;
            
            const scoreDisplay = document.getElementById('finalScore');
            if (scoreDisplay) {
                scoreDisplay.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">
                        ${passed ? '✅' : '❌'} ${percentage}%
                    </div>
                    <div style="font-size: 1rem;">
                        ${correctCount} out of ${totalQuestions} correct
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                        ${passed ? '<span style="color: #27ae60;">PASSED</span>' : '<span style="color: #e74c3c;">FAILED - 80% required</span>'}
                    </div>
                `;
            }
            
            return { correctCount, totalQuestions, percentage, passed };
        }

        function generateAnswerKey() {
            const keyContent = document.getElementById('answerKeyContent');
            if (!keyContent) return;
            
            keyContent.innerHTML = '';
            
            Object.keys(correctAnswers).forEach(qId => {
                const userAnswer = state.answers[qId];
                const isCorrect = userAnswer === correctAnswers[qId];
                
                const item = document.createElement('div');
                item.className = `answer-item ${isCorrect ? 'correct' : 'incorrect'}`;
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>Question ${qId}</strong>
                        </div>
                        <div style="font-size: 1.5rem;">
                            ${isCorrect ? '✅' : '❌'}
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <strong>Your answer:</strong> ${userAnswer || 'Not answered'}
                        ${!isCorrect ? `<br><strong style="color: #27ae60;">Correct answer:</strong> ${correctAnswers[qId]}` : ''}
                    </div>
                `;
                keyContent.appendChild(item);
            });
        }

        function updateCertificate(score) {
            const dateStr = new Date().toLocaleDateString();
            const certDate = document.getElementById('certDate');
            if (certDate) certDate.textContent = dateStr;
            const certDate2 = document.getElementById('certDate2');
            if (certDate2) certDate2.textContent = dateStr;
            const certMode = document.getElementById('certMode');
            if (certMode) certMode.textContent = state.mode === 'assessment' ? 'Assessment Mode' : 'Learn Mode';
            const certName = document.getElementById('userName');
            if (certName) {
                certName.textContent = state.userName || 'Participant';
            }
            
            const completionStatus = document.getElementById('completionStatus');
            if (completionStatus) {
                if (score.passed) {
                    completionStatus.textContent = 'has successfully completed';
                } else {
                    completionStatus.textContent = 'has completed';
                }
            }
        }

        // ===== CERTIFICATE ACTIONS =====
        function printCertificate() {
            const answerKey = document.getElementById('answerKey');
            const certActions = document.querySelector('.cert-actions');
            const moduleHeader = document.querySelector('#module-7 .module-header');
            const tipBox = document.querySelector('.cert-actions + div');
            
            if (answerKey) answerKey.style.display = 'none';
            if (certActions) certActions.style.display = 'none';
            if (moduleHeader) moduleHeader.style.display = 'none';
            if (tipBox) tipBox.style.display = 'none';
            
            window.print();
            
            setTimeout(() => {
                if (answerKey) answerKey.style.display = 'block';
                if (certActions) certActions.style.display = 'flex';
                if (moduleHeader) moduleHeader.style.display = 'block';
                if (tipBox) tipBox.style.display = 'block';
            }, 1000);
        }

        function resetTraining() {
            if (confirm('Reset and retry the training? All progress will be lost.')) {
                state.currentModule = 0;
                state.answers = {};
                state.completedModules = new Set();
                state.startTime = Date.now();
                state.module3Sections = new Set(['intro']);
                state.module4Sections = new Set(['m4-principles']);
                
                document.querySelectorAll('.question').forEach(q => {
                    q.classList.remove('correct-answered', 'incorrect-answered');
                    q.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected', 'correct', 'incorrect', 'disabled');
                    });
                    q.querySelectorAll('.feedback').forEach(fb => {
                        fb.style.display = 'none';
                    });
                });
                
                showModule(0);
                
                const msg = document.createElement('div');
                msg.className = 'alert alert-success';
                msg.innerHTML = '<strong>Training Reset!</strong> You can now retake the training.';
                msg.style.position = 'fixed';
                msg.style.top = '80px';
                msg.style.left = '50%';
                msg.style.transform = 'translateX(-50%)';
                msg.style.zIndex = '9999';
                msg.style.maxWidth = '90%';
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), 3000);
            }
        }

  // ===== PROGRESS SAVING SYSTEM =====
        function saveProgress() {
            const progressData = {
                currentModule: state.currentModule,
                answers: state.answers,
                completedModules: Array.from(state.completedModules),
                module3Sections: Array.from(state.module3Sections),
                module4Sections: Array.from(state.module4Sections),
                userName: state.userName,
                timestamp: new Date().toISOString(),
                version: '3.0'
            };
            
// Track current subsection for display
            if (state.currentModule === 3 && state.currentModule3SubsectionName) {
                progressData.module3SubsectionName = state.currentModule3SubsectionName;
            }
            
            if (state.currentModule === 4 && state.currentModule4SubsectionName) {
                progressData.module4SubsectionName = state.currentModule4SubsectionName;
            }
            
            try {
                localStorage.setItem('phi_training_progress', JSON.stringify(progressData));
                console.log('Progress saved successfully');
                showSaveConfirmation();
            } catch (error) {
                console.error('Failed to save progress:', error);
            }
        }

        function loadProgress() {
            try {
                const saved = localStorage.getItem('phi_training_progress');
                if (!saved) return null;
                
                const progressData = JSON.parse(saved);
                
                // Restore state
                state.currentModule = progressData.currentModule || 0;
                state.answers = progressData.answers || {};
                state.completedModules = new Set(progressData.completedModules || []);
                state.module3Sections = new Set(progressData.module3Sections || ['intro']);
                state.module4Sections = new Set(progressData.module4Sections || ['m4-principles']);
                state.userName = progressData.userName || '';
                
                // Restore answered questions UI
                Object.keys(state.answers).forEach(questionId => {
                    const question = document.querySelector(`[data-question="${questionId}"]`);
                    if (question) {
                        const selectedAnswer = state.answers[questionId];
                        const option = question.querySelector(`[data-answer="${selectedAnswer}"]`);
                        if (option) {
                            option.classList.add('selected');
                            const isCorrect = selectedAnswer === correctAnswers[questionId];
                            option.classList.add(isCorrect ? 'correct' : 'incorrect');
                            const feedback = question.querySelector(isCorrect ? '.correct-feedback' : '.incorrect-feedback');
                            if (feedback) feedback.style.display = 'block';
                        }
                    }
                });
                
                console.log('Progress restored successfully');
                return progressData;
            } catch (error) {
                console.error('Failed to load progress:', error);
                return null;
            }
        }

        function clearProgress() {
            try {
                localStorage.removeItem('phi_training_progress');
                console.log('Progress cleared');
            } catch (error) {
                console.error('Failed to clear progress:', error);
            }
        }

        function showSaveConfirmation() {
            let toast = document.getElementById('saveToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'saveToast';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #27ae60;
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-weight: bold;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                toast.innerHTML = '✓ Progress Saved';
                document.body.appendChild(toast);
            }
            
            setTimeout(() => toast.style.opacity = '1', 10);
            setTimeout(() => toast.style.opacity = '0', 2000);
        }

        function showResumePrompt(progressData) {
            const resumeDiv = document.createElement('div');
            resumeDiv.id = 'resumePrompt';
            resumeDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const savedDate = new Date(progressData.timestamp);
            const moduleNum = progressData.currentModule + 1;
            const questionsAnswered = Object.keys(progressData.answers).length;
            const totalMods = getTotalModules();
            
            resumeDiv.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📚</div>
                    <h2 style="color: #2c3e50; margin-bottom: 1rem;">Welcome Back!</h2>
                    <p style="color: #555; margin-bottom: 1.5rem;">
                        You have saved progress from ${savedDate.toLocaleDateString()} at ${savedDate.toLocaleTimeString()}
                    </p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <p style="margin: 0.5rem 0;"><strong>Module:</strong> ${moduleNum} of ${totalMods}</p>
                        ${progressData.currentModule === 3 && progressData.module3SubsectionName ? 
                            `<p style="margin: 0.5rem 0;"><strong>Subsection:</strong> ${progressData.module3SubsectionName}</p>` : ''}
                        ${progressData.currentModule === 4 && progressData.module4SubsectionName ? 
                            `<p style="margin: 0.5rem 0;"><strong>Subsection:</strong> ${progressData.module4SubsectionName}</p>` : ''}
                        <p style="margin: 0.5rem 0;"><strong>Questions Answered:</strong> ${questionsAnswered}</p>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="resumeTraining()" class="btn btn-primary" style="padding: 1rem 2rem;">
                            Continue Training
                        </button>
                        <button onclick="startFresh()" class="btn btn-secondary" style="padding: 1rem 2rem;">
                            Start Fresh
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(resumeDiv);
        }

        window.resumeTraining = function() {
            const promptDiv = document.getElementById('resumePrompt');
            if (promptDiv) promptDiv.remove();
            showModule(state.currentModule);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.startFresh = function() {
            const promptDiv = document.getElementById('resumePrompt');
            if (promptDiv) promptDiv.remove();
            
            clearProgress();
            
            // Reset state
            state.currentModule = 0;
            state.answers = {};
            state.completedModules = new Set();
            state.module3Sections = new Set(['intro']);
            state.module4Sections = new Set(['m4-principles']);
            
            showModule(0);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function enableAutoSave() {
            console.log('Auto-save enabled');
            
            document.addEventListener('click', function(e) {
                const target = e.target;
                
                if (target.classList.contains('option') || 
                    target.classList.contains('btn') ||
                    target.classList.contains('module-section-btn') ||
                    target.classList.contains('module-nav-item')) {
                    
                    setTimeout(function() {
                        try {
                            saveProgress();
                        } catch (error) {
                            console.error('Auto-save error:', error);
                        }
                    }, 1000);
                }
            });
            
            window.addEventListener('beforeunload', function() {
                try {
                    saveProgress();
                } catch (error) {
                    console.error('Save on exit error:', error);
                }
            });
        }

        function initWithProgress() {
            const savedProgress = loadProgress();
            
            if (savedProgress && savedProgress.currentModule > 0) {
                showResumePrompt(savedProgress);
            }
            
            enableAutoSave();
        }

        // Expose save function globally
        window.saveProgress = saveProgress;
        window.clearProgress = clearProgress;

        // ===== START =====
        document.addEventListener('DOMContentLoaded', function() {
            init();
            initWithProgress();
        });
    </script>
</body>
</html>
